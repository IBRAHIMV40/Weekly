<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MovieNest - Video Management</title>
    <!-- Add Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <style>
        /* CSS remains the same as before */
        :root {
            --bg-color: #141414;
            --text-color: #ffffff;
            --card-bg: #2c2c2c;
            --border-color: #444;
            --primary-color: #00b300;
            --light-bg: #2c2c2c;
            --gradient-3: linear-gradient(to right, #004d00, #00b300);
            --text-muted: #aaaaaa;
            --gradient-1: linear-gradient(to right, #004d00, #00b300);
        }
        
        /* Hide all scrollbars globally */
        * {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none;  /* IE and Edge */
        }
        *::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Edge */
        }
        
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow-x: hidden;
        }
        header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 48px;
            background: linear-gradient(to right, #141414, #141414);
            display: flex;
            border: 1px solid #333;
            border-radius: 0px;
            flex-direction: column;
            align-items: center;
            padding: 0px 0px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        /* Logo Image */
        .logo img {
            height: 45px;
            border-radius: 8px;
            margin-left: 6px;
            border: 1px solid #;
        }
        .search-container {
            display: flex;
            align-items: center;
            background-color: #333;
            border: 2px solid #444;
            border-radius: 18px;
            padding: 5px 5px;
            margin-right: 7px;
            width: fit-content;
        }
        .search-container i {
            color: #fff;
            margin-right: 8px;
            font-size: 16px;
        }
        #search-bar {
            border: none;
            outline: none;
            background: transparent;
            font-size: 14px;
            color: #fff;
            width: 140px;
        }
        .icons {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .history-icon {
            font-size: 21px;
            margin-right: 10px;
            cursor: pointer;
            color: #777777;
            position: relative;
        }
        .history-icon:hover {
            color: #00b300;
        }
        /* Notification Badge */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ff0000;
            color: white;
            font-size: 10px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        /* History Modal */
        .history-modal {
            display: none;
            position: fixed;
            top: 80px;
            right: 10px;
            width: 320px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            padding: 10px;
        }
        .history-modal.open {
            display: block;
        }
        .history-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .history-modal-header h3 {
            font-size: 16px;
            margin: 0;
            color: #333;
        }
        .history-modal-header button {
            background: none;
            border: none;
            color: #333;
            font-size: 16px;
            cursor: pointer;
        }
        .history-modal-header button:hover {
            color: #007bff';
        }
        .history-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .history-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .history-item:last-child {
            border-bottom: none;
        }
        .history-item img {
            width: 80px;
            height: 115px;
            object-fit: cover;
            border-radius: 5px;
        }
        .history-item .content {
            flex: 1;
        }
        .history-item h4 {
            font-size: 14px;
            margin: 0;
            color: #333;
        }
        .history-item p {
            font-size: 0px;
            margin: 0;
            color: #777;
        }
        .clear-history-button {
            width: 100%;
            background: linear-gradient(to right, #004d00, #00b300);
            color: #fff;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
        }
        .clear-history-button:hover {
            background-color: #00b300;
        }
        
        /* Carousel Styles - Updated to match screenshot */
        .carousel-container {
            width: 100%;
            max-width: 600px;
            overflow: hidden;
            position: relative;
            border-radius: 10px;
            touch-action: pan-y;
            height: 320px; /* Fixed height */
            margin: 0 auto 15px; /* Centered with margin */
            z-index: 10;
        }
        .carousel {
            display: flex;
            transition: transform 0.4s ease-in-out;
            will-change: transform;
            height: 100%;
        }
        .slide {
            min-width: 100%;
            position: relative;
            user-select: none;
            height: 100%;
            cursor: pointer;
        }
        .slide img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
        }
        .overlay {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 40%;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.9), transparent);
            border-radius: 10px;
        }
        .video-title {
            position: absolute;
            bottom: 75px;
            left: 15px;
            font-size: 22px;
            font-weight: bold;
            color: white;
        }
        .video-info {
            position: absolute;
            bottom: 50px;
            left: 15px;
            font-size: 14px;
            color: #ccc;
        }
        .download-btn {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background-color: #00b300;
            color: white;
            font-size: 12px;
            padding: 8px 12px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .download-btn img {
            width: 20px;
            height: 20px;
        }
        .dots {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 5px;
        }
        .dot {
            width: 11px;
            height: 11px;
            background-color: gray;
            border-radius: 50%;
            cursor: pointer;
            transition: 0.3s;
        }
        .dot.active {
            background-color: white;
        }
        
        /* Categories Section - New section based on screenshot */
        .categories-section {
            margin-top: 15px;
            padding: 0 8px;
        }
        .categories-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        .categories-scroll {
            display: flex;
            overflow-x: auto;
            gap: 8px;
            padding-bottom: 12px;
        }
        .category-btn {
            flex: 0 0 auto;
            padding: 8px 16px;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            color: var(--text-color);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .category-btn.active {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        .category-btn:hover {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        /* Discover Section */
        .discover-container {
            margin-top: 38px;
            padding: 8px;
        }
        .discover-scroll {
            display: flex;
            overflow-x: auto;
            gap: 8px;
            padding-bottom: 10px;
        }
        .discover-item {
            flex: 0 0 auto;
            width: 130px;
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            text-align: center;
            position: relative;
            cursor: pointer;
        }
        .discover-item img {
            width: 100%;
            aspect-ratio: 16 / 23;
            object-fit: cover;
            border-radius: 5px;
        }
        .discover-item .content {
            padding: 0px;
        }
        .discover-item .content h2 {
            font-weight: 400;
            font-size: 0.60rem;
            margin: 0;
            color: var(--text-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }
        .discover-item .content p {
            font-size: 0px;
            color: var(--text-muted);
            margin: 0px 0;
        }
        /* Category Section */
        .category-container {
            margin-top: 8px;
            padding: 2px;
        }
        .category-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            margin-left: 7px;
            color: var(--text-color);
            justify-content: space-between;
            align-items: center;
        }
        .category-title button {
            background-color: var(--light-bg);
            border: none;
            padding: 5px 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-color);
            cursor: pointer;
            font-size: 13px;
        }
        .category-title button:hover {
            background-color: var(--light-bg);
        }
        .category-scroll {
            display: flex;
            overflow-x: auto;
            gap: 4px;
            padding-bottom: 10px;
        }
        
        .frame {
            flex: 0 0 auto;
            width: 112px;
            background-color: var(--card-bg);
            border-radius: 8px;
            margin-left: 4px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            text-align: center;
            cursor: pointer;
        }
        .frame img {
            width: 100%;
            aspect-ratio: 16 / 24;
            object-fit: cover;
            border-radius: 5px;
        }
        .frame .content h2 {
            font-weight: 400;
            font-size: 0.60rem;
            color: var(--text-color);
            text-align: center;
            margin-top: 0px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }
        /* Grid Layout for View All and Search Results */
        .grid-container {
            margin-top: 35px;
            padding: 10px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            max-height: calc(100vh - 120px);
            overflow-y: auto;
        }
        .grid-container .frame {
            width: 100%;
        }
        
        /* Filter Section for Grid View */
        .filter-section {
            background-color: #;
            padding: 0px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            grid-column: 1 / -1; /* Span all columns */
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filter-dropdown {
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 8px 8px;
            font-size: 8px;
            cursor: pointer;
            outline: none;
        }
        
        .filter-dropdown:focus {
            border-color: var(--primary-color);
        }
        
        .filter-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 15px;
            font-size: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .filter-button:hover {
            background-color: #009900;
        }
        
        /* Navigation Modal Styles */
        .nav-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height:  90%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .nav-content {
            background-color: #141414;
            width: 100%;
            height: 100%;
            max-width: 800px;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .nav-header {
            background-color: #141414;
            color: #fff;
            padding: 10px;
            text-align: right;
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .nav-header button {
            background: none;
            border: none;
            color: #fff;
            font-size: 16px;
            border: 1px solid #333;
            border-radius: 50px;
            cursor: pointer;
            padding: 0 10px;
            margin: 0 5px;
        }
        .nav-header button:hover {
            color: #fff;
        }
        .save-btn {
            background-color: #00b300;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 14px;
        }
        .save-btn:hover {
            background-color: #ff0000;
        }
        .nav-body {
            flex-grow: 1;
            overflow: hidden;
            position: relative;
        }
        .nav-body iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        /* Episode Footer Styles */
        .episode-footer {
            background: #141414;    
            padding: 20px 0 10px;
            border-top: 1px solid var(--border-color);
            z-index: 310;
        }
        .episode-header {
            display: flex;
            padding: 0 20px 15px;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        .episode-title {
            font-size: 18px;
            font-weight: 700;
            max-width: 70%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: white;
        }
        .episode-count {
            font-size: 16px;
            color: var(--primary-color);
            font-weight: 600;
        }
        .episode-scroller {
            display: flex;
            overflow-x: auto;
            padding: 15px 20px;
            gap: 15px;
        }
        .episode-btn {
            flex: 0 0 auto;
            width: 65px;
            height: 65px;
            border-radius: 15px;
            background: #222;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 20px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        .episode-btn:hover {
            background: var(--light-bg);
            transform: translateY(-3px);
        }
        .episode-btn.active {
            background: var(--gradient-3);
            border-color: white;
            transform: scale(1.1);
            color: white;
            border: 2px solid #ccc;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
        }
        .episode-btn .ep-num {
            font-size: 12px;
            position: absolute;
            top: 5px;
            left: 5px;
            color: var(--text-muted);
        }
        .episode-btn.active .ep-num {
            color: white;
            font-weight: 700;
        }
        
        /* Season Navigation Buttons */
        .season-nav-btn {
            background: var(--gradient-1) !important;
            color: white !important;
            border: 2px solid white !important;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            width: 65px;
            height: 65px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
        }
        
        .season-nav-btn .season-nav-text {
            position: absolute;
            top: 2px;
            left: 8px;
            font-size: 12px;
            font-weight: 700;
            color: white;
        }
        
        .season-nav-btn .season-number {
            font-size: 20px;
            font-weight: 700;
        }
        
        .season-nav-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(255, 77, 77, 0.5);
        }
        
        .season-nav-btn.prev-season {
            margin-right: 5px;
        }
        
        .season-nav-btn.next-season {
            margin-left: 5px;
        }
        
        /* Notification Styles - Updated to center */
        .notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 15px 25px;
            font-size: 13px;
            font-weight: bold;
            border-radius: 8px;
            border: 1px solid #ccc;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 80%;
            z-index: 10000;
            animation: fadeInOut 3s ease-in-out;
        }
        .notification.success {
            background-color: #4CAF50;
            color: white;
        }
        .notification.warning {
            background-color: #FF9800;
            color: white;
        }
        .notification.info {
            background-color: #2196F3;
            color: white;
        }
        .notification.error {
            background-color: #F44336;
            color: white;
        }
        @keyframes fadeInOut {
            0% {
                opacity: 0;
                transform: translate(-50%, -60%);
            }
            10% {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
            90% {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -40%);
            }
        }
        #social-media {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 25px 0;
        }
        /* Social Media Descriptions */
        #social-media-descriptions {
            text-align: center;
            margin-bottom: 5px;
        }
        #social-media-descriptions h2 {
            font-size: 15px;
            color: #ccc;
            margin: 5;
        }
        /* Social Media Icons */
        #social-media {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }
        .social-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(to right, #004d00, #00b300);
            color: white;
            font-size: 18px;
            cursor: pointer;
            text-decoration: none;
            transition: background-color 0.3s ease;
        }
        .social-icon:hover {
            background-color: #555;
        }
        /* Sidebar Modal */
        .sidebar-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 300px;
            height: 100%;
            background-color: #fff;
            border-right: 1px solid #ccc;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            overflow-y: auto;
            padding: 10px;
        }
        .sidebar-modal.open {
            display: block;
        }
        .sidebar-modal-header {
            display: flex;
            background: linear-gradient(to right, #004d00, #00b300);
            justify-content: space-between;
            align-items: center;
            padding: 6px;
            border-radius: 20px;
            border-bottom: 1px solid #ccc;
            margin-bottom: 10px;
        }
        .sidebar-modal-header h3 {
            font-size: 18px;
            margin: 0;
            color: #333;
        }
        .sidebar-modal-header button {
            background: #fff;
            border: none;
            color: #333;
            border-bottom: 1px solid #ccc;
            font-size: 16px;
            border-radius: 50px;
            cursor: pointer;
        }
        .sidebar-modal-header button:hover {
            color: #007bff';
        }
        .sidebar-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .sidebar-item img {
            width: 30px;
            height: 30px;
            object-fit: cover;
            border-radius: 5px;
        }
        .sidebar-item span {
            font-size: 14px;
            color: #333;
        }
        /* Bars Icon */
        .bars-icon {
            font-size: 22px;
            cursor: pointer;
            color: #777777;
            margin-left: 15px;
        }
        .bars-icon:hover {
            color: #00b300;
        }
        
        /* Bottom Navigation Bar */
        footer {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px 0;
            border-radius: 0px;
            background-color: #141414;
            border-bottom: 1px solid #;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 100;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        footer .nav-icon {
            flex: 1;
            text-align: center;
            color: #777777;
            transition: all 0.3s ease-in-out;
            cursor: pointer;
            font-size: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        footer .nav-icon i {
            font-size: 21px;
            transition: 0.3s;
        }
        footer .nav-icon.active,
        footer .nav-icon:hover {
            color: #00b300;
        }
        footer .nav-icon.active i,
        footer .nav-icon:hover i {
            transform: scale(1.2);
        }
        /* Hide Footer */
        footer.hide {
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
        }
        
        /* New styles for added features */
        .filter-container {
            display: none;
            position: fixed;
            top: 60px;
            right: 10px;
            width: 280px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            padding: 15px;
        }
        .filter-container.open {
            display: block;
        }
        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .filter-header h3 {
            font-size: 16px;
            margin: 0;
            color: #333;
        }
        .filter-header button {
            background: none;
            border: none;
            color: #333;
            font-size: 16px;
            cursor: pointer;
        }
        .filter-section {
            margin-bottom: 15px;
        }
        .filter-section h4 {
            font-size: 14px;
            margin-bottom: 8px;
            color: #333;
        }
        .filter-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .filter-option {
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 15px;
            padding: 5px 10px;
            color: black;
            font-size: 12px;
            cursor: pointer;
        }
        .filter-option.active {
            background-color: #00b300;
            color: white;
        }
        .apply-filter-btn {
            width: 100%;
            background: linear-gradient(to right, #004d00, #00b300);
            color: #fff;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        /* Video quality selector - Changed to download button */
        .download-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 10px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 65px;
            height: 60px;
        }
        .download-btn i {
            font-size: 20px;
            margin-bottom: 5px;
        }
        .download-btn span {
            font-size: 10px;
        }
        .download-btn:hover {
            background: rgba(0,0,0,0.5);
        }
        
        /* User profile section */
        .user-profile {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #00b300;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
        }
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .user-info h3 {
            margin: 0 0 5px;
            font-size: 16px;
            color: #333;
            text-align: center;
        }
        .user-info p {
            margin: 0 0 10px;
            font-size: 12px;
            color: #777;
            text-align: center;
        }
        .edit-profile-btn {
            background-color: #00b300;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .edit-profile-btn i {
            font-size: 12px;
        }
        
        /* Video player controls */
        .player-controls {
            position: absolute;
            bottom: 0px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            background: #;
        }
        .player-controls button {
            background: none;
            border: none;
            color: #;
            font-size: 0px;
            cursor: pointer;
        }
        .player-timeline {
            flex: 1;
            height: 4px;
            background-color: rgba(255,255,255,0.3);
            margin: 0 15px;
            border-radius: 2px;
            position: relative;
        }
        .player-progress {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background-color: #00b300;
            width: 0%;
        }
        
        /* Edit Profile Modal */
        .edit-profile-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }
        .edit-profile-modal.open {
            display: flex;
        }
        .edit-profile-content {
            background-color: #fff;
            width: 90%;
            max-width: 400px;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .edit-profile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .edit-profile-header h3 {
            font-size: 18px;
            margin: 0;
            color: #333';
        }
        .edit-profile-header button {
            background: none;
            border: none;
            color: #333';
            font-size: 16px;
            cursor: pointer;
        }
        .avatar-selection {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        .avatar-option {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 0 5px;
            cursor: pointer;
            border: 2px solid transparent;
            overflow: hidden;
        }
        .avatar-option.selected {
            border-color: #00b300;
        }
        .avatar-option img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #333';
        }
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .save-profile-btn {
            width: 100%;
            background: linear-gradient(to right, #004d00, #00b300);
            color: #fff;
            border: none;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        /* Upload Modal Styles - Updated for scrolling */
        .upload-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            justify-content: center;
            align-items: center;
            overflow-y: auto; /* Enable scrolling for the modal background */
            padding: 20px 0; /* Add padding for better scrolling */
        }
        .upload-modal.open {
            display: flex;
        }
        .upload-content {
            background-color: #fff;
            width: 90%;
            max-width: 500px;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-height: 90vh; /* Limit height to 90% of viewport */
            overflow-y: auto; /* Enable scrolling for content */
            margin: auto; /* Center the modal */
        }
        .upload-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: sticky; /* Make header stick to top */
            top: 0;
            background-color: #fff;
            z-index: 10; /* Ensure header stays above content */
            padding-bottom: 10px;
        }
        .upload-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        .form-group label {
            font-size: 14px;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }
        .form-group input,
        .form-group textarea,
        .form-group select {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #00b300;
            box-shadow: 0 0 0 2px rgba(0, 179, 0, 0.2);
        }
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
            max-height: 150px; /* Limit textarea height */
        }
        .upload-btn {
            background: linear-gradient(to right, #004d00, #00b300);
            color: #fff;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        .upload-btn:hover {
            background: linear-gradient(to right, #003d00, #009900);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .upload-btn:active {
            transform: translateY(0);
        }
        .upload-example {
            margin-top: 15px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 4px;
            font-size: 12px;
            border-left: 4px solid #00b300;
        }
        .upload-example h4 {
            margin: 0 0 8px;
            color: #333;
            font-size: 14px;
        }
        .upload-example p {
            margin: 0 0 5px;
            color: #666;
            line-height: 1.4;
        }
        
        /* Add smooth scrolling */
        .upload-content {
            scroll-behavior: smooth;
        }
        
        /* Style for scrollbar in Webkit browsers */
        .upload-content::-webkit-scrollbar {
            width: 8px;
        }
        .upload-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .upload-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .upload-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Network Warning Styles - Updated to match image */
        .network-warning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }
        .network-warning.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .network-warning-icon {
            font-size: 80px;
            color: #ff0000;
            margin-bottom: 20px;
        }
        .network-warning-text {
            color: #ffffff;
            font-size: 20px;
            margin-bottom: 30px;
            text-align: center;
        }
        .network-warning-retry {
            background-color: #00b300;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 30px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }
        .network-warning-retry:hover {
            background-color: #009900;
        }
        
        /* Search Suggestions */
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background-color: #333;
            border-radius: 0 0 10px 10px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }
        .search-suggestions.show {
            display: block;
        }
        .search-suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            color: #fff;
            border-bottom: 1px solid #444;
        }
        .search-suggestion-item:last-child {
            border-bottom: none;
        }
        .search-suggestion-item .suggestion-type {
            font-size: 12px;
            color: #aaa;
            margin-left: 5px;
        }
        .search-suggestion-item:hover {
            background-color: #444;
        }
        
        /* Loading Spinner */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #00b300;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Season and Episode Management Styles */
        .seasons-container {
            margin-top: 15px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 8px;
        }
        
        .season-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .season-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }
        
        .season-actions {
            display: flex;
            gap: 10px;
        }
        
        .season-btn {
            background-color: #00b300;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .season-btn.remove {
            background-color: #ff0000;
        }
        
        .episodes-container {
            margin-top: 10px;
            padding: 10px;
            background-color: #fff;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        .episode-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        
        .episode-item:last-child {
            border-bottom: none;
        }
        
        .episode-info {
            flex: 1;
        }
        
        .episode-number {
            font-weight: bold;
            font-size: 14px;
            color: #333;
        }
        
        .episode-title {
            font-size: 12px;
            color: #666;
        }
        
        .episode-actions {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .episode-input {
            width: 200px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .episode-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: #666;
        }
        
        .episode-btn.remove {
            color: #ff0000;
        }
        
        .add-episode-btn {
            width: 100%;
            background-color: #f0f0f0;
            border: 1px dashed #ccc;
            color: #666;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }
        
        .add-episode-btn:hover {
            background-color: #e0e0e0;
        }
        
        .add-season-btn {
            width: 100%;
            background-color: #f0f0f0;
            border: 1px dashed #ccc;
            color: #666;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }
        
        .add-season-btn:hover {
            background-color: #e0e0e0;
        }
        
        /* Direct video link styles */
        .direct-link-message {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: rgba(0, 179, 0, 0.9);
            color: white;
            padding: 10px;
            text-align: center;
            z-index: 1001;
            font-size: 14px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        /* Password Modal Styles */
        .password-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 4000;
            justify-content: center;
            align-items: center;
        }
        .password-modal.open {
            display: flex;
        }
        .password-content {
            background-color: #fff;
            width: 90%;
            max-width: 400px;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .password-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .password-header h3 {
            font-size: 18px;
            margin: 0;
            color: #333;
        }
        .password-header button {
            background: none;
            border: none;
            color: #333;
            font-size: 16px;
            cursor: pointer;
        }
        .password-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .password-input {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            text-align: center;
        }
        .password-submit {
            background: linear-gradient(to right, #004d00, #00b300);
            color: #fff;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        .password-error {
            color: #ff0000;
            font-size: 14px;
            text-align: center;
            margin-top: 10px;
        }
        
        /* Ad Upload Modal Styles */
        .ad-upload-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            padding: 20px 0;
        }
        .ad-upload-modal.open {
            display: flex;
        }
        .ad-upload-content {
            background-color: #fff;
            width: 90%;
            max-width: 500px;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-height: 90vh;
            overflow-y: auto;
            margin: auto;
        }
        .ad-upload-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            background-color: #fff;
            z-index: 10;
            padding-bottom: 10px;
        }
        .ad-upload-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        /* App Upload Modal Styles */
        .app-upload-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            padding: 20px 0;
        }
        .app-upload-modal.open {
            display: flex;
        }
        .app-upload-content {
            background-color: #fff;
            width: 90%;
            max-width: 500px;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-height: 90vh;
            overflow-y: auto;
            margin: auto;
        }
        .app-upload-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            background-color: #fff;
            z-index: 10;
            padding-bottom: 10px;
        }
        .app-upload-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        /* Submenu Styles */
        .submenu {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 3500;
            padding: 10px;
            min-width: 200px;
        }
        .submenu.open {
            display: block;
        }
        .submenu-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .submenu-item:last-child {
            border-bottom: none;
        }
        .submenu-item:hover {
            background-color: #f5f5f5;
        }
        .submenu-item img {
            width: 24px;
            height: 24px;
            border-radius: 4px;
        }
        .submenu-item span {
            font-size: 14px;
            color: #333;
        }
        
        /* Ad container styles */
        .ad-container {
            position: fixed;
            bottom: 0;
            width:  96.5%;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.3);
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 1000;
        }
        .ad-content {
            display: flex;
            align-items: center;
            flex-grow: 1;
            overflow: hidden;
        }
        .app-icon {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            overflow: hidden;
            margin-right: 15px;
            flex-shrink: 0;
        }
        .app-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .ad-info {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .app-name {
            font-weight: bold;
            font-size: 18px;
            color: var(--text-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
            margin-bottom: 6px;
        }
        .ad-meta {
            font-size: 14px;
            color: var(--text-muted);
            white-space: nowrap;
        }
        .install-button {
            background: var(--gradient-1);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 30px;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
            margin-left: 15px;
            flex-shrink: 0;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 179, 0, 0.3);
        }
        .install-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 179, 0, 0.4);
        }
        .sponsored {
            font-size: 12px;
            color: var(--text-muted);
            margin-right: 5px;
        }
        .ad-wrapper {
            display: flex;
            align-items: center;
            flex: 1;
            overflow: hidden;
        }
        
        /* View Apps and Ads Section Styles */
        .view-section {
            margin-bottom: 20px;
        }
        .view-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 0 10px;
        }
        .view-section-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--text-color);
        }
        .view-section-count {
            background-color: var(--primary-color);
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        .view-search-container {
            margin-bottom: 15px;
            padding: 10px;
            background-color: var(--card-bg);
            border-radius: 8px;
        }
        .view-search-input-container {
            display: flex;
            align-items: center;
            background-color: #333;
            border: 2px solid #444;
            border-radius: 18px;
            padding: 5px 10px;
        }
        .view-search-input-container i {
            color: #fff;
            margin-right: 10px;
        }
        .view-search-input-container input {
            border: none;
            outline: none;
            background: transparent;
            font-size: 14px;
            color: #fff;
            width: 100%;
        }
        .view-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-bottom: 1px solid #333;
        }
        .view-item:last-child {
            border-bottom: none;
        }
        .view-item-icon {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            object-fit: cover;
        }
        .view-item-content {
            flex: 1;
        }
        .view-item-title {
            font-size: 14px;
            font-weight: bold;
            color: var(--text-color);
            margin: 0 0 5px;
        }
        .view-item-description {
            font-size: 12px;
            color: var(--text-muted);
            margin: 0;
        }
        .view-item-views {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            font-weight: bold;
        }
        .view-item-views:hover {
            background-color: #009900;
        }
        
        /* Video Management Modal Styles */
        .video-management-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            padding: 20px 0;
        }
        .video-management-modal.open {
            display: flex;
        }
        .video-management-content {
            background-color: #fff;
            width: 90%;
            max-width: 800px;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-height: 90vh;
            overflow-y: auto;
            margin: auto;
        }
        .video-management-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            background-color: #fff;
            z-index: 10;
            padding-bottom: 10px;
        }
        .video-management-search {
            margin-bottom: 15px;
        }
        .video-management-list {
            max-height: calc(90vh - 150px);
            overflow-y: auto;
        }
        .video-management-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            gap: 15px;
        }
        .video-management-item:last-child {
            border-bottom: none;
        }
        .video-thumbnail {
            width: 80px;
            height: 120px;
            object-fit: cover;
            border-radius: 5px;
            flex-shrink: 0;
        }
        .video-info {
            flex: 1;
        }
        .video-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        .video-meta {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }
        .video-actions {
            display: flex;
            gap: 10px;
            flex-direction: column;
        }
        .edit-btn, .delete-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            width: 80px;
            text-align: center;
        }
        .edit-btn {
            background-color: #00b300;
            color: white;
        }
        .edit-btn:hover {
            background-color: #009900;
        }
        .delete-btn {
            background-color: #ff0000;
            color: white;
        }
        .delete-btn:hover {
            background-color: #cc0000;
        }
        .no-videos {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        /* Folder Management Styles */
        .folder-management {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 8px;
        }
        
        .folder-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .folder-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        
        .folder-actions {
            display: flex;
            gap: 10px;
        }
        
        .folder-btn {
            background-color: #00b300;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .folder-btn:hover {
            background-color: #009900;
        }
        
        .folder-list {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            padding-bottom: 10px;
            scrollbar-width: thin; /* Firefox */
            -ms-overflow-style: scrollbar; /* IE and Edge */
        }
        
        .folder-list::-webkit-scrollbar {
            display: block; /* Chrome, Safari, Edge */
            width: 8px;
            height: 8px;
        }
        
        .folder-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .folder-list::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        .folder-list::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        .folder-item {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 0 0 auto;
            width: 200px;
            min-width: 200px;
            max-width: 200px;
        }
        
        .folder-item:hover {
            border-color: #00b300;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .folder-item.active {
            background-color: #e6f7e6;
            border-color: #00b300;
        }
        
        .folder-name {
            font-weight: bold;
            font-size: 14px;
            color: #333;
            margin-bottom: 5px;
        }
        
        .folder-description {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .folder-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #888;
        }
        
        .folder-actions-small {
            display: flex;
            gap: 5px;
        }
        
        .folder-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            padding: 2px 5px;
            border-radius: 3px;
        }
        
        .folder-action-btn:hover {
            background-color: #f0f0f0;
        }
        
        .folder-action-btn.edit {
            color: #00b300;
        }
        
        .folder-action-btn.delete {
            color: #ff0000;
        }
        
        .create-folder-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 4000;
            justify-content: center;
            align-items: center;
        }
        
        .create-folder-modal.open {
            display: flex;
        }
        
        .create-folder-content {
            background-color: #fff;
            width: 90%;
            max-width: 500px;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .create-folder-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .create-folder-header h3 {
            font-size: 18px;
            margin: 0;
            color: #333;
        }
        
        .create-folder-header button {
            background: none;
            border: none;
            color: #333;
            font-size: 16px;
            cursor: pointer;
        }
        
        .create-folder-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .create-folder-btn {
            background: linear-gradient(to right, #004d00, #00b300);
            color: #fff;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        
        .create-folder-btn:hover {
            background: linear-gradient(to right, #003d00, #009900);
        }
        
        /* Folder selection in upload form */
        .folder-selection {
            margin-top: 10px;
        }
        
        .folder-select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background-color: #fff;
            color: #333;
        }
        
        .folder-select:focus {
            outline: none;
            border-color: #00b300;
            box-shadow: 0 0 0 2px rgba(0, 179, 0, 0.2);
        }
        
        /* Video folder management */
        .video-folder-select {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .video-folder-select select {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background-color: #fff;
            color: #333;
        }
        
        .video-folder-select button {
            background-color: #00b300;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .video-folder-select button:hover {
            background-color: #009900;
        }
        
        /* Breadcrumb navigation */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #666;
        }
        
        .breadcrumb-item {
            cursor: pointer;
            color: #00b300;
            font-weight: 500;
        }
        
        .breadcrumb-item:hover {
            text-decoration: underline;
        }
        
        .breadcrumb-separator {
            color: #999;
        }
        
        .breadcrumb-current {
            color: #333;
            font-weight: bold;
        }
        
        /* Image preview styles */
        .image-preview {
            display: none;
            max-width: 100%;
            max-height: 200px;
            margin-top: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .file-input-label {
            display: inline-block;
            padding: 8px 12px;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            color: #333;
            transition: all 0.3s ease;
        }
        
        .file-input-label:hover {
            background-color: #e0e0e0;
        }
        
        .file-input {
            display: none;
        }
        
        /* Settings Modal Styles */
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            padding: 20px 0;
        }
        .settings-modal.open {
            display: flex;
        }
        .settings-content {
            background-color: #fff;
            width: 90%;
            max-width: 500px;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-height: 90vh;
            overflow-y: auto;
            margin: auto;
        }
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            background-color: #fff;
            z-index: 10;
            padding-bottom: 10px;
        }
        .settings-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .stats-container {
            background-color: #f5f5f5;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .stat-item:last-child {
            border-bottom: none;
        }
        .stat-label {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }
        .stat-value {
            font-size: 16px;
            color: #00b300;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Loading Spinner -->
    <div id="loading" class="loading" style="display: none;">
        <div class="loading-spinner"></div>
    </div>
    
    <!-- Hidden radio buttons for navigation -->
    <input type="radio" name="nav" id="nav-discover" class="nav-radio" checked>
    <input type="radio" name="nav" id="nav-movies" class="nav-radio">
    <input type="radio" name="nav" id="nav-trending" class="nav-radio">
    <input type="radio" name="nav" id="nav-mylist" class="nav-radio">
    <input type="radio" name="nav" id="nav-apps" class="nav-radio">
    
    <!-- Network Warning - Updated to match image -->
    <div class="network-warning hidden" id="network-warning">
        <i class="fas fa-wifi-slash network-warning-icon"></i>
        <div class="network-warning-text">No network connection found</div>
        <button class="network-warning-retry" onclick="checkNetworkConnection()">Try Again</button>
    </div>
    
    <!-- Direct Link Message -->
    <div id="direct-link-message" class="direct-link-message" style="display: none;">
        Opening shared video...
    </div>
    
    <header>
        <div class="header-top">
            <!-- Bars Icon -->
            <div class="bars-icon" onclick="toggleSidebarModal()">
                <i class="fas fa-bars"></i>
            </div>
            <!-- Logo as Image -->
            <div class="logo">
                <img src="https://ucarecdn.com/1ad62d6d-b8fb-4f3f-a98a-8d9bba0f57a0/-/preview/1000x1000/" alt="MovieNest Logo" />
            </div>
            <!-- History Icon -->
            <div class="history-icon" onclick="toggleHistoryModal()">
                <i class="fas fa-history"></i>
                <span class="notification-badge">3</span>
            </div>
            <!-- Search Bar Container -->
            <div class="search-container" style="position: relative;">
                <i class="fas fa-search"></i>
                <input type="text" id="search-bar" placeholder="Search movies..." oninput="handleSearch()" onfocus="showSearchSuggestions()" onblur="hideSearchSuggestions()" />
                <i class="fas fa-filter" onclick="toggleFilterModal()" style="margin-left: 10px; cursor: pointer;"></i>
                <!-- Search Suggestions -->
                <div class="search-suggestions" id="search-suggestions"></div>
            </div>
        </div>
    </header>
    
    <!-- Filter Modal -->
    <div class="filter-container" id="filter-modal">
        <div class="filter-header">
            <h3>Filter & Sort</h3>
            <button onclick="toggleFilterModal()"></button>
        </div>
        <div class="filter-section">
            <h4>Category</h4>
            <div class="filter-options">
                <div class="filter-option active" data-category="All">All</div>
                <div class="filter-option" data-category="Hollywood">Hollywood</div>
                <div class="filter-option" data-category="Nollywood">Nollywood</div>
                <div class="filter-option" data-category="Bollywood">Bollywood</div>
                <div class="filter-option" data-category="Kannywood">Kannywood</div>
                <div class="filter-option" data-category="Action">Action</div>
                <div class="filter-option" data-category="Drama">Drama</div>
                <div class="filter-option" data-category="Comedy">Comedy</div>
                <div class="filter-option" data-category="Romance">Romance</div>
                <div class="filter-option" data-category="Thriller">Thriller</div>
            </div>
        </div>
        <div class="filter-section">
            <h4>Sort By</h4>
            <div class="filter-options">
                <div class="filter-option active" data-sort="Newest">Newest</div>
                <div class="filter-option" data-sort="Popular">Popular</div>
                <div class="filter-option" data-sort="Rating">Rating</div>
                <div class="filter-option" data-sort="A-Z">A-Z</div>
            </div>
        </div>
        <button class="apply-filter-btn" onclick="applyFilters()">Apply Filters</button>
    </div>
    
    <!-- Sidebar Modal -->
    <div class="sidebar-modal" id="sidebar-modal">
        <div class="sidebar-modal-header">
            <h3></h3>
            <button onclick="toggleSidebarModal()"></button>
        </div>
        
        <!-- User Profile Section -->
        <div class="user-profile">
            <div class="user-avatar" id="user-avatar">
                <i class="fas fa-user" style="font-size: 36px;"></i>
            </div>
            <div class="user-info">
                <h3 id="user-name">Movie Nest User</h3>
                <p>Free Account</p>
            </div>
            <button class="edit-profile-btn" onclick="openEditProfileModal()">
                <i class="fas fa-edit"></i> Edit Profile
            </button>
        </div>
        
        <div class="sidebar-list" id="sidebar-list">
            <!-- Director Center - Now with upload functionality -->
            <div class="sidebar-item" onclick="checkUploadPassword()">
                <img src="https://cdn-icons-png.flaticon.com/128/18831/18831648.png" alt="Director Center">
                <span>Director Center</span>
            </div>
            <div class="sidebar-item" onclick="openAppsCenter()">
                <img src="https://cdn-icons-png.flaticon.com/128/5303/5303479.png" alt="Apps Center">
                <span>Apps Center</span>
            </div>
            <div class="sidebar-item" onclick="openAdsCenter()">
                <img src="https://cdn-icons-png.flaticon.com/128/9592/9592247.png" alt="Ads Center">
                <span>Ads Center</span>
            </div>
            <div class="sidebar-item" onclick="viewApps()">
                <img src="https://cdn-icons-png.flaticon.com/128/2767/2767325.png" alt="View Apps">
                <span>View Apps</span>
            </div>
            <div class="sidebar-item" onclick="viewAds()">
                <img src="https://cdn-icons-png.flaticon.com/128/2767/2767325.png" alt="View Ads">
                <span>View Ads</span>
            </div>
            <div class="sidebar-item" onclick="checkVideoManagementPassword()">
                <img src="https://cdn-icons-png.flaticon.com/128/4225/4225690.png" alt="Video Management">
                <span>Video Management</span>
            </div>
            <div class="sidebar-item" onclick="checkSettingsPassword()">
                <img src="https://cdn-icons-png.flaticon.com/128/3405/3405247.png" alt="Settings">
                <span>Settings</span>
            </div>
            <div class="sidebar-item">
                <img src="https://cdn-icons-png.flaticon.com/128/18392/18392966.png" alt="Online Service">
                <span>Online Service</span>
            </div>
            <div class="sidebar-item">
                <img src="https://cdn-icons-png.flaticon.com/128/2312/2312342.png" alt="Privacy Policy">
                <span>Privacy Policy</span>
            </div>
            <div class="sidebar-item">
                <img src="https://cdn-icons-png.flaticon.com/128/2838/2838694.png" alt="Help">
                <span>Help & Support</span>
            </div>
        </div>
    </div>
    
    <!-- Password Modal -->
    <div class="password-modal" id="password-modal">
        <div class="password-content">
            <div class="password-header">
                <h3>Enter Password</h3>
                <button onclick="closePasswordModal()"></button>
            </div>
            <form class="password-form" onsubmit="validatePassword(event)">
                <input type="password" class="password-input" id="password-input" placeholder="Enter password" required>
                <button type="submit" class="password-submit">Submit</button>
                <div class="password-error" id="password-error"></div>
            </form>
        </div>
    </div>
    
    <!-- Upload Modal -->
    <div class="upload-modal" id="upload-modal">
        <div class="upload-content">
            <div class="upload-header">
                <h3>Upload Video</h3>
                <button onclick="closeUploadModal()"></button>
            </div>
            <form class="upload-form" id="upload-form">
                <div class="form-group">
                    <label for="video-title">Video Title</label>
                    <input type="text" id="video-title" placeholder="Enter video title" required>
                </div>
                <div class="form-group">
                    <label for="video-description">Description</label>
                    <textarea id="video-description" placeholder="Enter video description"></textarea>
                </div>
                <div class="form-group">
                    <label for="video-type">Video Type</label>
                    <select id="video-type" required onchange="toggleSeriesFields()">
                        <option value="movie">Movie</option>
                        <option value="series">Series</option>
                        <option value="anime">Anime</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="video-category">Category</label>
                    <select id="video-category" required>
                        <!-- Industries -->
                        <option value="Hollywood">Hollywood</option>
                        <option value="Nollywood">Nollywood</option>
                        <option value="Bollywood">Bollywood</option>
                        <option value="Kannywood">Kannywood</option>

                        <!-- Genres -->
                        <option value="Action">Action</option>
                        <option value="Adventure">Adventure</option>
                        <option value="Comedy">Comedy</option>
                        <option value="Drama">Drama</option>
                        <option value="Romance">Romance</option>
                        <option value="Thriller">Thriller</option>
                        <option value="Horror">Horror</option>
                        <option value="Sci-Fi">Sci-Fi</option>
                        <option value="Fantasy">Fantasy</option>
                        <option value="Mystery">Mystery</option>
                        <option value="Crime">Crime</option>
                        <option value="Documentary">Documentary</option>
                        <option value="Biography">Biography</option>
                        <option value="Historical">Historical</option>
                        <option value="War">War</option>
                        <option value="Western">Western</option>
                        <option value="Musical">Musical</option>
                        <option value="Animation">Animation</option>
                        <option value="Family">Family</option>
                        <option value="Sports">Sports</option>
                        <option value="Short-Drama">Short-Drama</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="video-genre">Genre</label>
                    <select id="video-genre" required>
                        <option value="Action">Action</option>
                        <option value="Drama">Drama</option>
                        <option value="Comedy">Comedy</option>
                        <option value="Romance">Romance</option>
                        <option value="Thriller">Thriller</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="video-country">Country</label>
                    <select id="video-country" required>
                        <option value="United States">United States</option>
                        <option value="UK">UK</option>
                        <option value="Nigeria">Nigeria</option>
                        <option value="India">India</option>
                        <option value="Canada">Canada</option>
                        <option value="Australia">Australia</option>
                        <option value="Germany">Germany</option>
                        <option value="France">France</option>
                        <option value="Japan">Japan</option>
                        <option value="China">China</option>
                        <option value="South Korea">South Korea</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="video-year">Year</label>
                    <input type="number" id="video-year" min="1900" max="2030" placeholder="2023" required>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="video-trending" name="trending">
                        Mark as Trending
                    </label>
                </div>
                <div class="form-group">
                    <label for="video-url">Video URL (Any valid video URL)</label>
                    <input type="url" id="video-url" placeholder="Enter any video URL (YouTube, Vimeo, Direct Link, etc.)" required>
                </div>
                <div class="form-group">
                    <label for="video-download-url">Download URL (Optional)</label>
                    <input type="url" id="video-download-url" placeholder="https://example.com/download-link">
                    <small style="color: #666; font-size: 12px;">Optional: Provide a download link if available</small>
                </div>
                <div class="form-group">
                    <label for="video-thumbnail">Thumbnail Image</label>
                    <label for="video-thumbnail" class="file-input-label">
                        <i class="fas fa-upload"></i> Choose Thumbnail Image
                    </label>
                    <input type="file" id="video-thumbnail" class="file-input" accept="image/*" onchange="previewThumbnail(event, 'video-thumbnail-preview')">
                    <img id="video-thumbnail-preview" class="image-preview">
                    <input type="hidden" id="video-thumbnail-url" name="video-thumbnail-url">
                </div>
                <div class="form-group">
                    <label for="video-carousel-thumbnail">Carousel Thumbnail Image (Optional)</label>
                    <label for="video-carousel-thumbnail" class="file-input-label">
                        <i class="fas fa-upload"></i> Choose Carousel Thumbnail
                    </label>
                    <input type="file" id="video-carousel-thumbnail" class="file-input" accept="image/*" onchange="previewThumbnail(event, 'video-carousel-thumbnail-preview')">
                    <img id="video-carousel-thumbnail-preview" class="image-preview">
                    <input type="hidden" id="video-carousel-thumbnail-url" name="video-carousel-thumbnail-url">
                    <small style="color: #666; font-size: 12px;">If not provided, the regular thumbnail will be used</small>
                </div>
                
                <!-- Folder Selection -->
                <div class="form-group folder-selection">
                    <label for="video-folder">Save to Folder (Optional)</label>
                    <select id="video-folder" class="folder-select">
                        <option value="">No Folder</option>
                        <!-- Folders will be loaded here dynamically -->
                    </select>
                </div>
                
                <!-- Series-specific fields - initially hidden -->
                <div id="series-fields" style="display: none;">
                    <div class="seasons-container" id="seasons-container">
                        <div class="season-header">
                            <div class="season-title">Seasons</div>
                            <button type="button" class="season-btn" onclick="addSeason()">Add Season</button>
                        </div>
                        <div id="seasons-list">
                            <!-- Seasons will be added here dynamically -->
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="upload-btn">Upload Video</button>
                <div class="upload-example">
                    <h4>Example URLs:</h4>
                    <p>YouTube: https://www.youtube.com/embed/MN4hHqWWpwU</p>
                    <p>Google Drive: https://drive.google.com/file/d/1CWOELtePqeDDI-t07aWB0NAWQXlvH-ul/preview</p>
                    <p>Vimeo: https://player.vimeo.com/video/123456789</p>
                    <p>Dailymotion: https://www.dailymotion.com/embed/video/x123456</p>
                    <p>Direct MP4: https://example.com/video.mp4</p>
                    <p>Any other valid video URL</p>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Ad Upload Modal -->
    <div class="ad-upload-modal" id="ad-upload-modal">
        <div class="ad-upload-content">
            <div class="ad-upload-header">
                <h3>Upload Ad</h3>
                <button onclick="closeAdUploadModal()"></button>
            </div>
            <form class="ad-upload-form" id="ad-upload-form">
                <div class="form-group">
                    <label for="ad-title">Ad Title</label>
                    <input type="text" id="ad-title" placeholder="Enter ad title" required>
                </div>
                <div class="form-group">
                    <label for="ad-description">Description</label>
                    <textarea id="ad-description" placeholder="Enter ad description"></textarea>
                </div>
                <div class="form-group">
                    <label for="ad-image">Ad Image URL</label>
                    <input type="url" id="ad-image" placeholder="https://example.com/ad-image.jpg" required>
                </div>
                <div class="form-group">
                    <label for="ad-link">Ad Link</label>
                    <input type="url" id="ad-link" placeholder="https://example.com" required>
                </div>
                <div class="form-group">
                    <label for="ad-category">Ad Category</label>
                    <select id="ad-category" required>
                        <option value="App">App</option>
                        <option value="Game">Game</option>
                        <option value="Service">Service</option>
                        <option value="Product">Product</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <button type="submit" class="upload-btn">Upload Ad</button>
            </form>
        </div>
    </div>
    
    <!-- App Upload Modal -->
    <div class="app-upload-modal" id="app-upload-modal">
        <div class="app-upload-content">
            <div class="app-upload-header">
                <h3>Upload App</h3>
                <button onclick="closeAppUploadModal()"></button>
            </div>
            <form class="app-upload-form" id="app-upload-form">
                <div class="form-group">
                    <label for="app-name">App Name</label>
                    <input type="text" id="app-name" placeholder="Enter app name" required>
                </div>
                <div class="form-group">
                    <label for="app-description">Description</label>
                    <textarea id="app-description" placeholder="Enter app description"></textarea>
                </div>
                <div class="form-group">
                    <label for="app-icon">App Icon URL</label>
                    <input type="url" id="app-icon" placeholder="https://example.com/app-icon.png" required>
                </div>
                <div class="form-group">
                    <label for="app-link">App Download Link</label>
                    <input type="url" id="app-link" placeholder="https://example.com/download" required>
                </div>
                <div class="form-group">
                    <label for="app-category">App Category</label>
                    <select id="app-category" required>
                        <option value="Entertainment">Entertainment</option>
                        <option value="Games">Games</option>
                        <option value="Productivity">Productivity</option>
                        <option value="Social">Social</option>
                        <option value="Tools">Tools</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="app-rating">App Rating</label>
                    <input type="number" id="app-rating" min="1" max="5" step="0.1" placeholder="4.5" required>
                </div>
                <button type="submit" class="upload-btn">Upload App</button>
            </form>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="settings-modal" id="settings-modal">
        <div class="settings-content">
            <div class="settings-header">
                <h3>Settings</h3>
                <button onclick="closeSettingsModal()"></button>
            </div>
            
            <div class="stats-container">
                <h4 style="margin-top: 0; margin-bottom: 15px; color: #333;">App Statistics</h4>
                
                <div class="stat-item">
                    <div class="stat-label">Total Videos</div>
                    <div class="stat-value" id="total-videos-count">0</div>
                </div>
                
                <div class="stat-item">
                    <div class="stat-label">Total Video Views</div>
                    <div class="stat-value" id="total-views-count">0</div>
                </div>
                
                <div class="stat-item">
                    <div class="stat-label">Total Apps</div>
                    <div class="stat-value" id="total-apps-count">0</div>
                </div>
                
                <div class="stat-item">
                    <div class="stat-label">Total App Views</div>
                    <div class="stat-value" id="total-app-views-count">0</div>
                </div>
                
                <div class="stat-item">
                    <div class="stat-label">Total Ads</div>
                    <div class="stat-value" id="total-ads-count">0</div>
                </div>
                
                <div class="stat-item">
                    <div class="stat-label">Total Ad Views</div>
                    <div class="stat-value" id="total-ad-views-count">0</div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="cache-clear">Clear App Cache</label>
                <button type="button" class="upload-btn" onclick="clearAppCacheAndNotify()">Clear Cache</button>
                <small style="color: #666; font-size: 12px;">This will clear all cached data and reload the app</small>
            </div>
        </div>
    </div>
    
    <!-- Video Management Modal -->
    <div class="video-management-modal" id="video-management-modal">
        <div class="video-management-content">
            <div class="video-management-header">
                <h3 id="video-management-title">Video Management</h3>
                <button onclick="closeVideoManagementModal()"></button>
            </div>
            
            <!-- Folder Management Section -->
            <div class="folder-management">
                <div class="folder-header">
                    <div class="folder-title">Folders</div>
                    <div class="folder-actions">
                        <button class="folder-btn" onclick="openCreateFolderModal()">
                            <i class="fas fa-plus"></i> Create Folder
                        </button>
                    </div>
                </div>
                
                <!-- Breadcrumb Navigation -->
                <div class="breadcrumb" id="folder-breadcrumb">
                    <div class="breadcrumb-item" onclick="showAllVideosInManagement()">All Videos</div>
                </div>
                
                <!-- Folder List -->
                <div class="folder-list" id="folder-list">
                    <!-- Folders will be loaded here dynamically -->
                </div>
            </div>
            
            <div class="video-management-search">
                <div class="search-container" style="width: 100%; margin-bottom: 15px;">
                    <i class="fas fa-search"></i>
                    <input type="text" id="video-management-search" placeholder="Search videos..." oninput="filterManagementVideos()">
                </div>
            </div>
            <div class="video-management-list" id="video-management-list">
                <!-- Videos will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Create Folder Modal -->
    <div class="create-folder-modal" id="create-folder-modal">
        <div class="create-folder-content">
            <div class="create-folder-header">
                <h3>Create New Folder</h3>
                <button onclick="closeCreateFolderModal()"></button>
            </div>
            <form class="create-folder-form" id="create-folder-form" onsubmit="createFolderSubmit(event)">
                <div class="form-group">
                    <label for="folder-name">Folder Name</label>
                    <input type="text" id="folder-name" placeholder="Enter folder name" required>
                </div>
                <div class="form-group">
                    <label for="folder-description">Description (Optional)</label>
                    <textarea id="folder-description" placeholder="Enter folder description" rows="3"></textarea>
                </div>
                <button type="submit" class="create-folder-btn">Create Folder</button>
            </form>
        </div>
    </div>
    
    <!-- Edit Folder Modal -->
    <div class="create-folder-modal" id="edit-folder-modal">
        <div class="create-folder-content">
            <div class="create-folder-header">
                <h3>Edit Folder</h3>
                <button onclick="closeEditFolderModal()"></button>
            </div>
            <form class="create-folder-form" id="edit-folder-form" onsubmit="editFolderSubmit(event)">
                <div class="form-group">
                    <label for="edit-folder-name">Folder Name</label>
                    <input type="text" id="edit-folder-name" placeholder="Enter folder name" required>
                </div>
                <div class="form-group">
                    <label for="edit-folder-description">Description (Optional)</label>
                    <textarea id="edit-folder-description" placeholder="Enter folder description" rows="3"></textarea>
                </div>
                <button type="submit" class="create-folder-btn">Update Folder</button>
            </form>
        </div>
    </div>
    
    <!-- Video Folder Management Modal -->
    <div class="create-folder-modal" id="video-folder-modal">
        <div class="create-folder-content">
            <div class="create-folder-header">
                <h3>Change Video Folder</h3>
                <button onclick="closeVideoFolderModal()"></button>
            </div>
            <form class="create-folder-form" id="video-folder-form" onsubmit="changeVideoFolderSubmit(event)">
                <div class="form-group">
                    <label for="video-folder-select">Select Folder</label>
                    <select id="video-folder-select" class="folder-select">
                        <option value="">No Folder</option>
                        <!-- Folders will be loaded here dynamically -->
                    </select>
                </div>
                <button type="submit" class="create-folder-btn">Update Folder</button>
            </form>
        </div>
    </div>
    
    <!-- Submenu for Ads Center -->
    <div class="submenu" id="ads-submenu">
        <div class="submenu-item" onclick="checkUploadAdPassword()">
            <img src="https://cdn-icons-png.flaticon.com/128/4208/4208469.png" alt="Upload Ad">
            <span>Upload Ad</span>
        </div>
        <div class="submenu-item" onclick="viewAds()">
            <img src="https://cdn-icons-png.flaticon.com/128/2767/2767325.png" alt="View Ads">
            <span>View Ads</span>
        </div>
    </div>
    
    <!-- Submenu for Apps Center -->
    <div class="submenu" id="apps-submenu">
        <div class="submenu-item" onclick="checkUploadAppPassword()">
            <img src="https://cdn-icons-png.flaticon.com/128/4208/4208469.png" alt="Upload App">
            <span>Upload App</span>
        </div>
        <div class="submenu-item" onclick="viewApps()">
            <img src="https://cdn-icons-png.flaticon.com/128/2767/2767325.png" alt="View Apps">
            <span>View Apps</span>
        </div>
    </div>
    
    <!-- Edit Profile Modal -->
    <div class="edit-profile-modal" id="edit-profile-modal">
        <div class="edit-profile-content">
            <div class="edit-profile-header">
                <h3>Edit Profile</h3>
                <button onclick="closeEditProfileModal()"></button>
            </div>
            <div class="avatar-selection">
                <div class="avatar-option" data-avatar="1">
                    <img src="https://cdn-icons-png.flaticon.com/128/6997/6997666.png" alt="Avatar 1">
                </div>
                <div class="avatar-option" data-avatar="2">
                    <img src="https://cdn-icons-png.flaticon.com/128/6997/6997662.png" alt="Avatar 2">
                </div>
                <div class="avatar-option" data-avatar="3">
                    <img src="https://cdn-icons-png.flaticon.com/128/6997/6997661.png" alt="Avatar 3">
                </div>
                <div class="avatar-option" data-avatar="4">
                    <img src="https://cdn-icons-png.flaticon.com/128/6997/6997664.png" alt="Avatar 4">
                </div>
            </div>
            <div class="form-group">
                <label for="user-name-input">Name</label>
                <input type="text" id="user-name-input" placeholder="Enter your name">
            </div>
            <button class="save-profile-btn" onclick="saveProfile()">Save Changes</button>
        </div>
    </div>
    
    <!-- History Modal -->
    <div class="history-modal" id="history-modal">
        <div class="history-modal-header">
            <h3>Recently Watched</h3>
            <button onclick="toggleHistoryModal()"></button>
        </div>
        <div class="history-list" id="history-list"></div>
        <button class="clear-history-button" onclick="clearHistory()">Clear All History</button>
    </div>
    <!-- Discover Section -->
    <div class="discover-container" id="discover-container">
        <!-- Carousel Section - Now inside discover section -->
        <div class="carousel-container">
            <div class="carousel" id="carousel"></div>
            <div class="dots" id="dots"></div>
        </div>
        
        <!-- Categories Section - New section based on screenshot -->
        <div class="categories-section">
            <div class="categories-title">Categories</div>
            <div class="categories-scroll" id="categories-scroll">
                <div class="category-btn active" data-category="All">All</div>
                <div class="category-btn" data-category="Hollywood">Hollywood</div>
                <div class="category-btn" data-category="Nollywood">Nollywood</div>
                <div class="category-btn" data-category="Bollywood">Bollywood</div>
                <div class="category-btn" data-category="Kannywood">Kannywood</div>
                <div class="category-btn" data-category="Action">Action</div>
                <div class="category-btn" data-category="Short-Drama">Short-Drama</div>
                <div class="category-btn" data-category="Comedy">Comedy</div>
                <div class="category-btn" data-category="Adventure">Adventure</div>
                <div class="category-btn" data-category="Romance">Romance</div>
                <div class="category-btn" data-category="Thriller">Thriller</div>
                <div class="category-btn" data-category="Horror">Horror</div>
                <div class="category-btn" data-category="Sci-Fi">Sci-Fi</div>
                <div class="category-btn" data-category="Fantasy">Fantasy</div>
                <div class="category-btn" data-category="Mystery">Mystery</div>
                <div class="category-btn" data-category="Crime">Crime</div>
                <div class="category-btn" data-category="Documentary">Documentary</div>
                <div class="category-btn" data-category="Biography">Biography</div>
                <div class="category-btn" data-category="Historical">Historical</div>
                <div class="category-btn" data-category="War">War</div>
                <div class="category-btn" data-category="Western">Western</div>
                <div class="category-btn" data-category="Musical">Musical</div>
                <div class="category-btn" data-category="Animation">Animation</div>
                <div class="category-btn" data-category="Family">Family</div>
                <div class="category-btn" data-category="Sports">Sports</div>
            </div>
        </div>
        
        <div class="discover-scroll" id="discover-scroll"></div>
    </div>        
    <!-- Categories Section -->
    <div id="categories-container"></div>
    <!-- Grid Layout for View All and Search Results -->
    <div id="grid-container" class="grid-container" style="display: none;"></div>
    <!-- Navigation Modal -->
    <div class="nav-container" id="video-nav">
        <div class="nav-content">
            <div class="nav-header">
                <button id="close-btn" onclick="closeNav()"><i class="fas fa-arrow-left"></i></button>
                <div>
                    <button id="share-btn" onclick="shareMovie()"><i class="fas fa-share-alt"></i> Share</button>
                    <span id="view-count" style="margin-left: 10px; color: #ccc;">0 views</span>
                    <button id="save-btn" class="save-btn" onclick="toggleSaveStatus()">Add to list</button>
                </div>
            </div>
            <div class="nav-body">
                <div style="position: relative; width: 100%; height: 100%;">
                    <!-- Download button (only shown if download URL is available) -->
                    <button class="download-btn" id="video-download-btn" style="display: none;" onclick="downloadVideo()">
                        <i class="fas fa-download"></i>
                        <span>Download</span>
                    </button>
                    <iframe id="video-player" src="" frameborder="0" allowfullscreen style="width: 100%; height: 100%;"></iframe>
                    <div class="player-controls">
                        <button><i class="fas fa-backward"></i></button>
                        <div class="player-timeline">
                            <div class="player-progress"></div>
                        </div>
                        <button><i class="fas fa-forward"></i></button>
                    </div>
                </div>
            </div>
            <!-- Ad container for video modal -->
            <div class="ad-container" id="video-ad-container" style="display: none;">
                <div class="ad-wrapper">
                    <div class="ad-content" id="video-ad-content">
                        <!-- Ad content will be inserted here by JavaScript -->
                    </div>
                </div>
                <a href="#" class="install-button" id="video-install-button">Install</a>
            </div>
            <!-- Episode Footer -->
            <div class="episode-footer" id="episode-footer" style="display: none;">
                <div class="episode-header">
                    <div class="episode-title" id="episode-title">Episodes</div>
                    <div class="episode-count" id="episode-count">0 Episodes</div>
                </div>
                <div class="episode-scroller" id="episode-scroller">
                    <!-- Episode buttons will be dynamically added here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Social Media Descriptions -->
    <div id="social-media-descriptions">
        <h2>Follow us on social media:</h2>
    </div>
    <!-- Social Media Icons -->
    <div id="social-media">
        <a href="https://www.facebook.com/share/1AQXgVMP49/" target="_blank" class="social-icon">
            <i class="fab fa-facebook-f"></i>
        </a>
        <a href="#" target="_blank" class="social-icon">
            <i class="fab fa-twitter"></i>
        </a>
        <a href="#" target="_blank" class="social-icon">
            <i class="fab fa-telegram"></i>
        </a>
        <a href="#" target="_blank" class="social-icon">
            <i class="fab fa-instagram"></i>
        </a>
        <a href="#" target="_blank" class="social-icon">
            <i class="fab fa-youtube"></i>
        </a>
        <a href="#" target="_blank" class="social-icon">
            <i class="fab fa-whatsapp"></i>
        </a>
        <a href="#" target="_blank" class="social-icon">
            <i class="fab fa-tiktok"></i>
        </a>
    </div>
    <!-- Bottom Navigation Bar -->
    <footer>
        <label for="nav-discover" class="nav-icon" onclick="showDiscoverSection();">
            <i class="fa-solid fa-house"></i>
            <span>Home</span>
        </label>
        <label for="nav-movies" class="nav-icon" onclick="showHomeVideos();">
            <i class="fas fa-film"></i>
            <span>Movies</span>
        </label>
        <label for="nav-trending" class="nav-icon" onclick="showTrendingVideos();">
            <i class="fas fa-fire"></i>
            <span>Trending</span>
        </label>
        <label for="nav-mylist" class="nav-icon" onclick="showMyList();">
            <i class="fas fa-tasks"></i>
            <span>My List</span>
        </label>
        <label for="nav-apps" class="nav-icon" onclick="showProfileSection();">
            <i class="fab fa-app-store"></i>
            <span>Apps</span>
        </label>
    </footer>
    
    <script>
        // Initialize Firebase with your configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA9JK8BX2pAXpmW_d6GpXRZjFpTLkso1KI",
            authDomain: "movie-nest-77e6b.firebaseapp.com",
            projectId: "movie-nest-77e6b",
            storageBucket: "movie-nest-77e6b.firebasestorage.app",
            messagingSenderId: "513317696448",
            appId: "1:513317696448:web:c70c566151226ef55bce25"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();
        
        // Cache management functions
        const CACHE_EXPIRY_HOURS = 24; // Cache expires after 24 hours

        function isCacheExpired(timestamp) {
            const now = new Date().getTime();
            const cacheTime = new Date(timestamp).getTime();
            const hoursDiff = (now - cacheTime) / (1000 * 60 * 60);
            return hoursDiff > CACHE_EXPIRY_HOURS;
        }

        function getCachedData(key) {
            try {
                const cachedData = localStorage.getItem(key);
                if (!cachedData) return null;
                
                const { data, timestamp } = JSON.parse(cachedData);
                if (isCacheExpired(timestamp)) {
                    localStorage.removeItem(key);
                    return null;
                }
                
                return data;
            } catch (error) {
                console.error('Error reading from cache:', error);
                return null;
            }
        }

        function setCachedData(key, data) {
            try {
                const cacheData = {
                    data,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem(key, JSON.stringify(cacheData));
            } catch (error) {
                console.error('Error writing to cache:', error);
            }
        }
        
        // Function to format view counts with K, M, B suffixes
        function formatViewCount(count) {
            if (!count) return '0';
            
            const num = parseInt(count);
            if (num >= 1000000000) {
                return (num / 1000000000).toFixed(1) + 'B';
            } else if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }
        
        // Fetch videos from Firestore
        async function fetchVideosFromFirestore() {
            try {
                // Check cache first
                const cachedVideos = getCachedData('videosCache');
                if (cachedVideos) {
                    console.log('Using cached videos');
                    return cachedVideos;
                }
                
                showLoading();
                const snapshot = await db.collection('videos').get();
                const videos = [];
                snapshot.forEach(doc => {
                    videos.push({ id: doc.id, ...doc.data() });
                });
                
                // Cache the results
                setCachedData('videosCache', videos);
                
                hideLoading();
                return videos;
            } catch (error) {
                console.error('Error fetching videos:', error);
                hideLoading();
                showNotification('Failed to load videos. Please check your connection.', 'error');
                return [];
            }
        }
        
        // Fetch ads from Firestore
        async function fetchAdsFromFirestore() {
            try {
                // Check cache first
                const cachedAds = getCachedData('adsCache');
                if (cachedAds) {
                    console.log('Using cached ads');
                    return cachedAds;
                }
                
                const snapshot = await db.collection('ads').get();
                const ads = [];
                snapshot.forEach(doc => {
                    ads.push({ id: doc.id, ...doc.data() });
                });
                
                // Cache the results
                setCachedData('adsCache', ads);
                
                return ads;
            } catch (error) {
                console.error('Error fetching ads:', error);
                return [];
            }
        }
        
        // Fetch apps from Firestore
        async function fetchAppsFromFirestore() {
            try {
                // Check cache first
                const cachedApps = getCachedData('appsCache');
                if (cachedApps) {
                    console.log('Using cached apps');
                    return cachedApps;
                }
                
                const snapshot = await db.collection('apps').get();
                const apps = [];
                snapshot.forEach(doc => {
                    apps.push({ id: doc.id, ...doc.data() });
                });
                
                // Cache the results
                setCachedData('appsCache', apps);
                
                return apps;
            } catch (error) {
                console.error('Error fetching apps:', error);
                return [];
            }
        }
        
        // Fetch folders from Firestore
        async function fetchFoldersFromFirestore() {
            try {
                // Check cache first
                const cachedFolders = getCachedData('foldersCache');
                if (cachedFolders) {
                    console.log('Using cached folders');
                    return cachedFolders;
                }
                
                const snapshot = await db.collection('folders').get();
                const folders = [];
                snapshot.forEach(doc => {
                    folders.push({ id: doc.id, ...doc.data() });
                });
                
                // Cache the results
                setCachedData('foldersCache', folders);
                
                return folders;
            } catch (error) {
                console.error('Error fetching folders:', error);
                return [];
            }
        }
        
        // Function to clear cache when needed (e.g., after uploading new content)
        function clearAppCache() {
            localStorage.removeItem('videosCache');
            localStorage.removeItem('adsCache');
            localStorage.removeItem('appsCache');
            localStorage.removeItem('foldersCache');
            console.log('App cache cleared');
        }
        
        // Function to clear cache and show notification
        function clearAppCacheAndNotify() {
            clearAppCache();
            showNotification('Cache cleared successfully. App will reload now.', 'success');
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        }
        
        // Initialize saved movies from localStorage
        let savedMovies = JSON.parse(localStorage.getItem('savedMovies')) || [];
        
        // Initialize user profile from localStorage
        let userProfile = JSON.parse(localStorage.getItem('userProfile')) || {
            name: 'Movie Nest User',
            avatar: null
        };
        
        // Initialize current folder for video management
        let currentFolderId = null;
        let currentFolderName = null;
        
        // Fallback data in case external files fail to load
        const fallbackData = [
            {
                id: 1,
                title: "Sample Movie",
                description: "A sample movie for testing",
                imgUrl: "https://picsum.photos/seed/movie1/300/450.jpg",
                videoUrl: "https://www.youtube.com/embed/MN4hHqWWpwU",
                category: "Hollywood",
                genre: "Action",
                year: 2023,
                type: "Movie"
            }
        ];
        
        // Data validation
        let videosData, seriesData, animeData, profileApps, adsData;
        
        function validateData() {
            if (!videosData || !Array.isArray(videosData)) {
                console.error("videosData is missing or invalid");
                return false;
            }
            if (!seriesData || !Array.isArray(seriesData)) {
                console.error("seriesData is missing or invalid");
                return false;
            }
            if (!animeData || !Array.isArray(animeData)) {
                console.error("animeData is missing or invalid");
                return false;
            }
            return true;
        }
        
        // Combine videos, series, and anime data and shuffle
        let combinedData;
        let data;
        
        try {
            if (validateData()) {
                combinedData = [...videosData, ...seriesData, ...animeData];
            } else {
                combinedData = fallbackData;
                console.warn("Using fallback data due to validation errors");
            }
            data = shuffleArray(combinedData);
        } catch (error) {
            console.error("Error combining data:", error);
            data = fallbackData;
        }
        
        // Track if we're currently in the video modal
        let inVideoModal = false;
        
        // Track if we're currently in a grid view
        let inGridView = false;
        
        // Track if we're currently in the filter modal
        let inFilterModal = false;
        
        // Track if we're currently in the history modal
        let inHistoryModal = false;
        
        // Track if we're currently in the sidebar modal
        let inSidebarModal = false;
        
        // Track if we're currently in the upload modal
        let inUploadModal = false;
        
        // Track if we're currently in the password modal
        let inPasswordModal = false;
        
        // Track if we're currently in the ad upload modal
        let inAdUploadModal = false;
        
        // Track if we're currently in the app upload modal
        let inAppUploadModal = false;
        
        // Track if we're currently in the video management modal
        let inVideoManagementModal = false;
        
        // Track if we're currently in the create folder modal
        let inCreateFolderModal = false;
        
        // Track if we're currently in the edit folder modal
        let inEditFolderModal = false;
        
        // Track if we're currently in the video folder modal
        let inVideoFolderModal = false;
        
        // Track if we're currently in the settings modal
        let inSettingsModal = false;
        
        // Track if we're currently in the ads submenu
        let inAdsSubmenu = false;
        
        // Track if we're currently in the apps submenu
        let inAppsSubmenu = false;
        
        // Track current grid data for filtering
        let currentGridData = [];
        
        // Track if we're navigating episodes/seasons
        let isEpisodeNavigation = false;
        
        // Track search suggestions
        let searchTimeout;
        let currentSearchTerm = '';
        
        // Track seasons and episodes for upload
        let seasons = [];
        let seasonCounter = 0;
        
        // Track if we're opening a direct video link
        let openingDirectLink = false;
        
        // Function to show/hide loading spinner
        function showLoading() {
            document.getElementById('loading').style.display = 'flex';
        }
        
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
        
        // Function to validate video URLs - Updated to accept any URL
        function isValidVideoUrl(url) {
            try {
                const urlObj = new URL(url);
                // Simply check if it's a valid URL without restricting to specific domains
                return true;
            } catch (e) {
                return false;
            }
        }
        
        // Function to preview selected thumbnail
        function previewThumbnail(event, previewId) {
            const file = event.target.files[0];
            const preview = document.getElementById(previewId);
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                preview.style.display = 'none';
            }
        }
        
        // Function to upload image to Firebase Storage
        async function uploadImage(file, path) {
            if (!file) return null;
            
            try {
                showLoading();
                const storageRef = storage.ref();
                const fileName = `${Date.now()}_${file.name}`;
                const fileRef = storageRef.child(`${path}/${fileName}`);
                
                await fileRef.put(file);
                const downloadUrl = await fileRef.getDownloadURL();
                hideLoading();
                
                return downloadUrl;
            } catch (error) {
                console.error('Error uploading image:', error);
                hideLoading();
                showNotification('Error uploading image. Please try again.', 'error');
                return null;
            }
        }
        
        // Save form data to localStorage
        function saveUploadFormData() {
            const formData = {
                title: document.getElementById('video-title').value,
                description: document.getElementById('video-description').value,
                type: document.getElementById('video-type').value,
                category: document.getElementById('video-category').value,
                genre: document.getElementById('video-genre').value,
                country: document.getElementById('video-country').value,
                year: document.getElementById('video-year').value,
                trending: document.getElementById('video-trending').checked,
                videoUrl: document.getElementById('video-url').value,
                downloadUrl: document.getElementById('video-download-url').value,
                thumbnail: document.getElementById('video-thumbnail-url').value,
                carouselThumbnail: document.getElementById('video-carousel-thumbnail-url').value,
                folderId: document.getElementById('video-folder').value,
                seasons: seasons.map(season => ({
                    seasonNumber: season.seasonNumber,
                    episodes: season.episodes.map(episode => ({
                        number: episode.number,
                        title: episode.title,
                        url: episode.url,
                        downloadUrl: episode.downloadUrl || ''
                    }))
                }))
            };
            
            localStorage.setItem('uploadFormData', JSON.stringify(formData));
        }
        
        // Load form data from localStorage
        function loadUploadFormData() {
            const savedData = localStorage.getItem('uploadFormData');
            if (!savedData) return;
            
            try {
                const formData = JSON.parse(savedData);
                
                // Populate basic fields
                document.getElementById('video-title').value = formData.title || '';
                document.getElementById('video-description').value = formData.description || '';
                document.getElementById('video-type').value = formData.type || 'Movie';
                document.getElementById('video-category').value = formData.category || 'Hollywood';
                document.getElementById('video-genre').value = formData.genre || 'Action';
                document.getElementById('video-country').value = formData.country || 'United States';
                document.getElementById('video-year').value = formData.year || '';
                document.getElementById('video-trending').checked = formData.trending || false;
                document.getElementById('video-url').value = formData.videoUrl || '';
                document.getElementById('video-download-url').value = formData.downloadUrl || '';
                document.getElementById('video-folder').value = formData.folderId || '';
                
                // Set thumbnail URL and preview
                document.getElementById('video-thumbnail-url').value = formData.thumbnail || '';
                if (formData.thumbnail) {
                    const preview = document.getElementById('video-thumbnail-preview');
                    preview.src = formData.thumbnail;
                    preview.style.display = 'block';
                }
                
                // Set carousel thumbnail URL and preview
                document.getElementById('video-carousel-thumbnail-url').value = formData.carouselThumbnail || '';
                if (formData.carouselThumbnail) {
                    const preview = document.getElementById('video-carousel-thumbnail-preview');
                    preview.src = formData.carouselThumbnail;
                    preview.style.display = 'block';
                }
                
                // Handle series data if present
                if ((formData.type === 'series' || formData.type === 'anime') && formData.seasons && formData.seasons.length > 0) {
                    toggleSeriesFields();
                    
                    // Clear existing seasons
                    seasons = [];
                    seasonCounter = 0;
                    document.getElementById('seasons-list').innerHTML = '';
                    
                    // Recreate seasons
                    formData.seasons.forEach(seasonData => {
                        addSeason();
                        const currentSeason = seasons[seasons.length - 1];
                        
                        // Update season number
                        currentSeason.seasonNumber = seasonData.seasonNumber;
                        document.querySelector(`#${currentSeason.id} .season-title`).textContent = `Season ${seasonData.seasonNumber}`;
                        
                        // Clear default episode and add saved episodes
                        currentSeason.episodes = [];
                        const episodesContainer = document.getElementById(`${currentSeason.id}-episodes`);
                        episodesContainer.innerHTML = '';
                        
                        seasonData.episodes.forEach(episodeData => {
                            addEpisode(currentSeason.id);
                            const currentEpisode = currentSeason.episodes[currentSeason.episodes.length - 1];
                            
                            // Update episode data
                            currentEpisode.number = episodeData.number;
                            currentEpisode.title = episodeData.title;
                            currentEpisode.url = episodeData.url;
                            currentEpisode.downloadUrl = episodeData.downloadUrl || '';
                            
                            // Update DOM
                            const episodeElement = document.getElementById(currentEpisode.id);
                            episodeElement.querySelector('.episode-title input').value = episodeData.title;
                            episodeElement.querySelector('.episode-url-input').value = episodeData.url;
                            episodeElement.querySelector('.episode-download-url-input').value = episodeData.downloadUrl || '';
                        });
                    });
                }
            } catch (error) {
                console.error('Error loading saved form data:', error);
            }
        }
        
        // Clear saved form data
        function clearUploadFormData() {
            localStorage.removeItem('uploadFormData');
        }
        
        // Function to toggle the upload modal
        const openUploadModal = () => {
            const uploadModal = document.getElementById('upload-modal');
            const sidebarModal = document.getElementById('sidebar-modal');
            
            // Close sidebar modal first
            if (sidebarModal.classList.contains('open')) {
                sidebarModal.classList.remove('open');
                inSidebarModal = false;
            }
            
            // Open upload modal
            uploadModal.classList.add('open');
            inUploadModal = true;
            
            // Push state to history
            history.pushState({ uploadOpen: true }, '');
            
            // Load saved form data
            loadUploadFormData();
            
            // Load folders for folder selection
            loadFoldersForUpload();
            
            // Scroll to top of modal content
            setTimeout(() => {
                const uploadContent = document.querySelector('.upload-content');
                if (uploadContent) {
                    uploadContent.scrollTop = 0;
                }
            }, 100);
        };
        
        const closeUploadModal = () => {
            const uploadModal = document.getElementById('upload-modal');
            uploadModal.classList.remove('open');
            inUploadModal = false;
            
            // Save form data before closing
            saveUploadFormData();
        };
        
        // Function to toggle the ad upload modal
        const openAdUploadModal = () => {
            const adUploadModal = document.getElementById('ad-upload-modal');
            const sidebarModal = document.getElementById('sidebar-modal');
            const adsSubmenu = document.getElementById('ads-submenu');
            
            // Close sidebar modal first
            if (sidebarModal.classList.contains('open')) {
                sidebarModal.classList.remove('open');
                inSidebarModal = false;
            }
            
            // Close ads submenu
            if (adsSubmenu.classList.contains('open')) {
                adsSubmenu.classList.remove('open');
                inAdsSubmenu = false;
            }
            
            // Open ad upload modal
            adUploadModal.classList.add('open');
            inAdUploadModal = true;
            
            // Reset form
            document.getElementById('ad-upload-form').reset();
            
            // Scroll to top of modal content
            setTimeout(() => {
                const adUploadContent = document.querySelector('.ad-upload-content');
                if (adUploadContent) {
                    adUploadContent.scrollTop = 0;
                }
            }, 100);
        };
        
        const closeAdUploadModal = () => {
            const adUploadModal = document.getElementById('ad-upload-modal');
            adUploadModal.classList.remove('open');
            inAdUploadModal = false;
            
            // Reset form
            document.getElementById('ad-upload-form').reset();
        };
        
        // Function to toggle the app upload modal
        const openAppUploadModal = () => {
            const appUploadModal = document.getElementById('app-upload-modal');
            const sidebarModal = document.getElementById('sidebar-modal');
            const appsSubmenu = document.getElementById('apps-submenu');
            
            // Close sidebar modal first
            if (sidebarModal.classList.contains('open')) {
                sidebarModal.classList.remove('open');
                inSidebarModal = false;
            }
            
            // Close apps submenu
            if (appsSubmenu.classList.contains('open')) {
                appsSubmenu.classList.remove('open');
                inAppsSubmenu = false;
            }
            
            // Open app upload modal
            appUploadModal.classList.add('open');
            inAppUploadModal = true;
            
            // Reset form
            document.getElementById('app-upload-form').reset();
            
            // Scroll to top of modal content
            setTimeout(() => {
                const appUploadContent = document.querySelector('.app-upload-content');
                if (appUploadContent) {
                    appUploadContent.scrollTop = 0;
                }
            }, 100);
        };
        
        const closeAppUploadModal = () => {
            const appUploadModal = document.getElementById('app-upload-modal');
            appUploadModal.classList.remove('open');
            inAppUploadModal = false;
            
            // Reset form
            document.getElementById('app-upload-form').reset();
        };
        
        // Function to check password before opening upload modal
        const checkUploadPassword = () => {
            const passwordModal = document.getElementById('password-modal');
            passwordModal.classList.add('open');
            inPasswordModal = true;
            
            // Focus on password input
            setTimeout(() => {
                document.getElementById('password-input').focus();
            }, 100);
        };
        
        // Function to check password before opening app upload modal
        const checkUploadAppPassword = () => {
            const passwordModal = document.getElementById('password-modal');
            passwordModal.classList.add('open');
            inPasswordModal = true;
            
            // Focus on password input
            setTimeout(() => {
                document.getElementById('password-input').focus();
            }, 100);
            
            // Set a flag to indicate we're opening app upload
            passwordModal.dataset.target = 'app';
        };
        
        // Function to check password before opening ad upload modal
        const checkUploadAdPassword = () => {
            const passwordModal = document.getElementById('password-modal');
            passwordModal.classList.add('open');
            inPasswordModal = true;
            
            // Focus on password input
            setTimeout(() => {
                document.getElementById('password-input').focus();
            }, 100);
            
            // Set a flag to indicate we're opening ad upload
            passwordModal.dataset.target = 'ad';
        };
        
        // Function to check password before opening video management modal
        const checkVideoManagementPassword = () => {
            const passwordModal = document.getElementById('password-modal');
            passwordModal.classList.add('open');
            inPasswordModal = true;
            
            // Focus on password input
            setTimeout(() => {
                document.getElementById('password-input').focus();
            }, 100);
            
            // Set a flag to indicate we're opening video management
            passwordModal.dataset.target = 'video-management';
        };
        
        // Function to check password before opening settings modal
        const checkSettingsPassword = () => {
            const passwordModal = document.getElementById('password-modal');
            passwordModal.classList.add('open');
            inPasswordModal = true;
            
            // Focus on password input
            setTimeout(() => {
                document.getElementById('password-input').focus();
            }, 100);
            
            // Set a flag to indicate we're opening settings
            passwordModal.dataset.target = 'settings';
        };
        
        const closePasswordModal = () => {
            const passwordModal = document.getElementById('password-modal');
            passwordModal.classList.remove('open');
            inPasswordModal = false;
            
            // Clear password input and error message
            document.getElementById('password-input').value = '';
            document.getElementById('password-error').textContent = '';
        };
        
        const validatePassword = (event) => {
            event.preventDefault();
            
            const password = document.getElementById('password-input').value;
            const target = document.getElementById('password-modal').dataset.target;
            
            if (password === "Mm&&0220" && target === 'video-management') {
                closePasswordModal();
                openVideoManagementModal();
            } else if (password === "Mm&&0220") {
                closePasswordModal();
                openUploadModal();
            } else if (password === "Mm&&0221" && target === 'app') {
                closePasswordModal();
                openAppUploadModal();
            } else if (password === "Mm&&0221" && target === 'ad') {
                closePasswordModal();
                openAdUploadModal();
            } else if (password === "Mm&&02211" && target === 'video-management') {
                closePasswordModal();
                openVideoManagementModal();
            } else if (password === "Mm&&022111" && target === 'settings') {
                closePasswordModal();
                openSettingsModal();
            } else {
                document.getElementById('password-error').textContent = "Incorrect password. Please try again.";
            }
        };
        
        // Function to open Settings Modal
        const openSettingsModal = async () => {
            const settingsModal = document.getElementById('settings-modal');
            const sidebarModal = document.getElementById('sidebar-modal');
            
            // Close sidebar modal first
            if (sidebarModal.classList.contains('open')) {
                sidebarModal.classList.remove('open');
                inSidebarModal = false;
            }
            
            // Open settings modal
            settingsModal.classList.add('open');
            inSettingsModal = true;
            
            // Load statistics
            await loadSettingsStatistics();
            
            // Scroll to top of modal content
            setTimeout(() => {
                const settingsContent = document.querySelector('.settings-content');
                if (settingsContent) {
                    settingsContent.scrollTop = 0;
                }
            }, 100);
        };
        
        // Function to close the settings modal
        const closeSettingsModal = () => {
            const settingsModal = document.getElementById('settings-modal');
            settingsModal.classList.remove('open');
            inSettingsModal = false;
        };
        
        // Function to load statistics for settings
        const loadSettingsStatistics = async () => {
            try {
                showLoading();
                
                // Get total videos count
                const videosSnapshot = await db.collection('videos').get();
                const totalVideos = videosSnapshot.size;
                document.getElementById('total-videos-count').textContent = totalVideos;
                
                // Get total video views
                let totalVideoViews = 0;
                videosSnapshot.forEach(doc => {
                    const views = doc.data().views || 0;
                    totalVideoViews += views;
                });
                document.getElementById('total-views-count').textContent = formatViewCount(totalVideoViews);
                
                // Get total apps count
                const appsSnapshot = await db.collection('apps').get();
                const totalApps = appsSnapshot.size;
                document.getElementById('total-apps-count').textContent = totalApps;
                
                // Get total app views
                let totalAppViews = 0;
                appsSnapshot.forEach(doc => {
                    const views = doc.data().views || 0;
                    totalAppViews += views;
                });
                document.getElementById('total-app-views-count').textContent = formatViewCount(totalAppViews);
                
                // Get total ads count
                const adsSnapshot = await db.collection('ads').get();
                const totalAds = adsSnapshot.size;
                document.getElementById('total-ads-count').textContent = totalAds;
                
                // Get total ad views
                let totalAdViews = 0;
                adsSnapshot.forEach(doc => {
                    const views = doc.data().views || 0;
                    totalAdViews += views;
                });
                document.getElementById('total-ad-views-count').textContent = formatViewCount(totalAdViews);
                
                hideLoading();
            } catch (error) {
                console.error('Error loading settings statistics:', error);
                showNotification('Error loading statistics. Please try again.', 'error');
                hideLoading();
            }
        };
        
        // Function to open Apps Center
        const openAppsCenter = () => {
            const appsSubmenu = document.getElementById('apps-submenu');
            const sidebarModal = document.getElementById('sidebar-modal');
            
            // Toggle the submenu
            if (appsSubmenu.classList.contains('open')) {
                appsSubmenu.classList.remove('open');
                inAppsSubmenu = false;
            } else {
                // Close other submenus first
                document.getElementById('ads-submenu').classList.remove('open');
                inAdsSubmenu = false;
                
                appsSubmenu.classList.add('open');
                inAppsSubmenu = true;
            }
        };
        
        // Function to open Ads Center
        const openAdsCenter = () => {
            const adsSubmenu = document.getElementById('ads-submenu');
            const sidebarModal = document.getElementById('sidebar-modal');
            
            // Toggle the submenu
            if (adsSubmenu.classList.contains('open')) {
                adsSubmenu.classList.remove('open');
                inAdsSubmenu = false;
            } else {
                // Close other submenus first
                document.getElementById('apps-submenu').classList.remove('open');
                inAppsSubmenu = false;
                
                adsSubmenu.classList.add('open');
                inAdsSubmenu = true;
            }
        };
        
        // Function to view all apps
        const viewApps = async () => {
            // Reset scroll position
            window.scrollTo(0, 0);
            
            // Set flag and push state for grid view
            inGridView = true;
            history.pushState({ gridView: true, view: 'apps' }, '');
            
            const gridContainer = document.getElementById('grid-container');
            gridContainer.innerHTML = '';
            gridContainer.scrollTop = 0;
            
            // Hide other sections
            document.getElementById('discover-container').style.display = 'none';
            document.getElementById('categories-container').style.display = 'none';
            gridContainer.style.display = 'block';
            
            // Create search container for apps
            const searchContainer = document.createElement('div');
            searchContainer.className = 'view-search-container';
            searchContainer.innerHTML = `
                <div class="view-search-input-container">
                    <i class="fas fa-search"></i>
                    <input type="text" id="apps-search-bar" placeholder="Search apps..." oninput="searchApps()">
                </div>
            `;
            
            // Create apps section header
            const appsHeader = document.createElement('div');
            appsHeader.className = 'view-section-header';
            appsHeader.innerHTML = `
                <h3 class="view-section-title">Apps Center</h3>
                <span class="view-section-count">${profileApps ? profileApps.length : 0} apps</span>
            `;
            
            // Create apps content container
            const appsContent = document.createElement('div');
            appsContent.className = 'view-section';
            appsContent.id = 'apps-content';
            
            // Add elements to grid container
            gridContainer.appendChild(searchContainer);
            gridContainer.appendChild(appsHeader);
            gridContainer.appendChild(appsContent);
            
            // Populate apps
            if (profileApps && profileApps.length > 0) {
                profileApps.forEach(app => {
                    const appItem = createAppViewItem(app);
                    appsContent.appendChild(appItem);
                });
            } else {
                appsContent.innerHTML = '<p>No apps available</p>';
            }
            
            // Close sidebar
            toggleSidebarModal();
        };
        
        // Function to view all ads
        const viewAds = async () => {
            // Reset scroll position
            window.scrollTo(0, 0);
            
            // Set flag and push state for grid view
            inGridView = true;
            history.pushState({ gridView: true, view: 'ads' }, '');
            
            const gridContainer = document.getElementById('grid-container');
            gridContainer.innerHTML = '';
            gridContainer.scrollTop = 0;
            
            // Hide other sections
            document.getElementById('discover-container').style.display = 'none';
            document.getElementById('categories-container').style.display = 'none';
            gridContainer.style.display = 'block';
            
            // Create search container for ads
            const searchContainer = document.createElement('div');
            searchContainer.className = 'view-search-container';
            searchContainer.innerHTML = `
                <div class="view-search-input-container">
                    <i class="fas fa-search"></i>
                    <input type="text" id="ads-search-bar" placeholder="Search ads..." oninput="searchAds()">
                </div>
            `;
            
            // Create ads section header
            const adsHeader = document.createElement('div');
            adsHeader.className = 'view-section-header';
            adsHeader.innerHTML = `
                <h3 class="view-section-title">Ads Center</h3>
                <span class="view-section-count">${adsData ? adsData.length : 0} ads</span>
            `;
            
            // Create ads content container
            const adsContent = document.createElement('div');
            adsContent.className = 'view-section';
            adsContent.id = 'ads-content';
            
            // Add elements to grid container
            gridContainer.appendChild(searchContainer);
            gridContainer.appendChild(adsHeader);
            gridContainer.appendChild(adsContent);
            
            // Populate ads
            if (adsData && adsData.length > 0) {
                adsData.forEach(ad => {
                    const adItem = createAdViewItem(ad);
                    adsContent.appendChild(adItem);
                });
            } else {
                adsContent.innerHTML = '<p>No ads available</p>';
            }
            
            // Close sidebar
            toggleSidebarModal();
        };
        
        // Function to create an app view item
        const createAppViewItem = (app) => {
            const appItem = document.createElement('div');
            appItem.className = 'view-item';
            
            const icon = document.createElement('img');
            icon.src = app.icon || 'https://picsum.photos/seed/app/50/50.jpg';
            icon.alt = app.name;
            icon.className = 'view-item-icon';
            
            const content = document.createElement('div');
            content.className = 'view-item-content';
            
            const name = document.createElement('h4');
            name.className = 'view-item-title';
            name.textContent = app.name;
            
            const description = document.createElement('p');
            description.className = 'view-item-description';
            description.textContent = app.description;
            
            const viewsButton = document.createElement('button');
            viewsButton.className = 'view-item-views';
            viewsButton.textContent = app.views ? `${formatViewCount(app.views)} views` : '0 views';
            viewsButton.onclick = async () => {
                try {
                    // Get the app document
                    const appRef = db.collection('apps').doc(app.id);
                    const appDoc = await appRef.get();
                    
                    if (appDoc.exists) {
                        // Get current view count
                        const currentViews = appDoc.data().views || 0;
                        const newViews = currentViews + 1;
                        
                        // Update view count in Firestore
                        await appRef.update({ views: newViews });
                        
                        // Update button text to show view count
                        viewsButton.textContent = `${formatViewCount(newViews)} views`;
                        
                        // Update local data
                        app.views = newViews;
                    } else {
                        // If document doesn't exist, create it with view count
                        await appRef.set({ 
                            views: 1,
                            ...app 
                        });
                        viewsButton.textContent = '1 views';
                        app.views = 1;
                    }
                } catch (error) {
                    console.error('Error updating app view count:', error);
                    showNotification('Error updating view count', 'error');
                }
            };
            
            content.appendChild(name);
            content.appendChild(description);
            appItem.appendChild(icon);
            appItem.appendChild(content);
            appItem.appendChild(viewsButton);
            
            return appItem;
        };
        
        // Function to create an ad view item
        const createAdViewItem = (ad) => {
            const adItem = document.createElement('div');
            adItem.className = 'view-item';
            
            const icon = document.createElement('img');
            icon.src = ad.image || 'https://picsum.photos/seed/ad/50/50.jpg';
            icon.alt = ad.title;
            icon.className = 'view-item-icon';
            
            const content = document.createElement('div');
            content.className = 'view-item-content';
            
            const name = document.createElement('h4');
            name.className = 'view-item-title';
            name.textContent = ad.title;
            
            const description = document.createElement('p');
            description.className = 'view-item-description';
            description.textContent = ad.description;
            
            const viewsButton = document.createElement('button');
            viewsButton.className = 'view-item-views';
            viewsButton.textContent = ad.views ? `${formatViewCount(ad.views)} views` : '0 views';
            viewsButton.onclick = async () => {
                try {
                    // Get the ad document
                    const adRef = db.collection('ads').doc(ad.id);
                    const adDoc = await adRef.get();
                    
                    if (adDoc.exists) {
                        // Get current view count
                        const currentViews = adDoc.data().views || 0;
                        const newViews = currentViews + 1;
                        
                        // Update view count in Firestore
                        await adRef.update({ views: newViews });
                        
                        // Update button text to show view count
                        viewsButton.textContent = `${formatViewCount(newViews)} views`;
                        
                        // Update local data
                        ad.views = newViews;
                    } else {
                        // If document doesn't exist, create it with view count
                        await adRef.set({ 
                            views: 1,
                            ...ad 
                        });
                        viewsButton.textContent = '1 views';
                        ad.views = 1;
                    }
                } catch (error) {
                    console.error('Error updating ad view count:', error);
                    showNotification('Error updating view count', 'error');
                }
            };
            
            content.appendChild(name);
            content.appendChild(description);
            adItem.appendChild(icon);
            adItem.appendChild(content);
            adItem.appendChild(viewsButton);
            
            return adItem;
        };
        
        // Function to search apps
        const searchApps = () => {
            const searchTerm = document.getElementById('apps-search-bar').value.toLowerCase();
            const appsContent = document.getElementById('apps-content');
            appsContent.innerHTML = '';
            
            if (!profileApps || profileApps.length === 0) {
                appsContent.innerHTML = '<p>No apps available</p>';
                return;
            }
            
            const filteredApps = profileApps.filter(app => {
                return app.name.toLowerCase().includes(searchTerm) || 
                       app.description.toLowerCase().includes(searchTerm) ||
                       (app.category && app.category.toLowerCase().includes(searchTerm));
            });
            
            if (filteredApps.length > 0) {
                filteredApps.forEach(app => {
                    const appItem = createAppViewItem(app);
                    appsContent.appendChild(appItem);
                });
            } else {
                appsContent.innerHTML = '<p>No apps found matching your search</p>';
            }
        };
        
        // Function to search ads
        const searchAds = () => {
            const searchTerm = document.getElementById('ads-search-bar').value.toLowerCase();
            const adsContent = document.getElementById('ads-content');
            adsContent.innerHTML = '';
            
            if (!adsData || adsData.length === 0) {
                adsContent.innerHTML = '<p>No ads available</p>';
                return;
            }
            
            const filteredAds = adsData.filter(ad => {
                return ad.title.toLowerCase().includes(searchTerm) || 
                       ad.description.toLowerCase().includes(searchTerm) ||
                       (ad.category && ad.category.toLowerCase().includes(searchTerm));
            });
            
            if (filteredAds.length > 0) {
                filteredAds.forEach(ad => {
                    const adItem = createAdViewItem(ad);
                    adsContent.appendChild(adItem);
                });
            } else {
                adsContent.innerHTML = '<p>No ads found matching your search</p>';
            }
        };
        
        // Function to toggle the sidebar modal
        const toggleSidebarModal = () => {
            const sidebarModal = document.getElementById('sidebar-modal');
            const historyModal = document.getElementById('history-modal');
            const filterModal = document.getElementById('filter-modal');
            
            // If history modal is open, close it first
            if (historyModal.classList.contains('open')) {
                historyModal.classList.remove('open');
                inHistoryModal = false;
            }
            
            // If filter modal is open, close it first
            if (filterModal.classList.contains('open')) {
                filterModal.classList.remove('open');
                inFilterModal = false;
            }
            
            // Close submenus
            document.getElementById('ads-submenu').classList.remove('open');
            inAdsSubmenu = false;
            document.getElementById('apps-submenu').classList.remove('open');
            inAppsSubmenu = false;
            
            // Toggle the sidebar modal
            sidebarModal.classList.toggle('open');
            inSidebarModal = !inSidebarModal;
            
            // If opening the sidebar modal, push state to history
            if (inSidebarModal) {
                history.pushState({ sidebarOpen: true }, '');
            }
        };
        
        // Function to toggle the history modal
        const toggleHistoryModal = () => {
            const historyModal = document.getElementById('history-modal');
            const sidebarModal = document.getElementById('sidebar-modal');
            const filterModal = document.getElementById('filter-modal');
            
            // If sidebar modal is open, close it first
            if (sidebarModal.classList.contains('open')) {
                sidebarModal.classList.remove('open');
                inSidebarModal = false;
            }
            
            // If filter modal is open, close it first
            if (filterModal.classList.contains('open')) {
                filterModal.classList.remove('open');
                inFilterModal = false;
            }
            
            // Toggle the history modal
            historyModal.classList.toggle('open');
            inHistoryModal = !inHistoryModal;
            
            // If opening the history modal, push state to history
            if (inHistoryModal) {
                history.pushState({ historyOpen: true }, '');
            }
        };
        
        // Function to toggle the filter modal
        const toggleFilterModal = () => {
            const filterModal = document.getElementById('filter-modal');
            const sidebarModal = document.getElementById('sidebar-modal');
            const historyModal = document.getElementById('history-modal');
            
            // If sidebar modal is open, close it first
            if (sidebarModal.classList.contains('open')) {
                sidebarModal.classList.remove('open');
                inSidebarModal = false;
            }
            
            // If history modal is open, close it first
            if (historyModal.classList.contains('open')) {
                historyModal.classList.remove('open');
                inHistoryModal = false;
            }
            
            // Toggle the filter modal
            filterModal.classList.toggle('open');
            inFilterModal = !inFilterModal;
            
            // If opening the filter modal, push state to history
            if (inFilterModal) {
                history.pushState({ filterOpen: true }, '');
            }
        };
        
        // Function to populate the sidebar with URL logos
        const populateSidebar = () => {
            const sidebarList = document.getElementById('sidebar-list');
            sidebarList.innerHTML = '';
            // Example list of URL logos (replace with your own data)
            const urlLogos = [
                { logoUrl: "https://cdn-icons-png.flaticon.com/128/18831/18831648.png", name: "Director Center", url: "#", isUpload: true },
                { logoUrl: "https://cdn-icons-png.flaticon.com/128/5303/5303479.png", name: "Apps Center", url: "#", isApps: true },
                { logoUrl: "https://cdn-icons-png.flaticon.com/128/9592/9592247.png", name: "Ads Center", url: "#", isAds: true },
                { logoUrl: "https://cdn-icons-png.flaticon.com/128/2767/2767325.png", name: "View Apps", url: "#", isViewApps: true },
                { logoUrl: "https://cdn-icons-png.flaticon.com/128/2767/2767325.png", name: "View Ads", url: "#", isViewAds: true },
                { logoUrl: "https://cdn-icons-png.flaticon.com/128/4225/4225690.png", name: "Video Management", url: "#", isVideoManagement: true },
                { logoUrl: "https://cdn-icons-png.flaticon.com/128/3405/3405247.png", name: "Settings", url: "#", isSettings: true },
                { logoUrl: "https://cdn-icons-png.flaticon.com/128/18392/18392966.png", name: "Online Service", url: "#" },
                { logoUrl: "https://cdn-icons-png.flaticon.com/128/2312/2312342.png", name: "Privacy Policy", url: "#" },
                { logoUrl: "https://cdn-icons-png.flaticon.com/128/2838/2838694.png", name: "Help & Support", url: "#" },
            ];
            urlLogos.forEach(item => {
                const sidebarItem = document.createElement('div');
                sidebarItem.className = 'sidebar-item';
                
                if (item.isUpload) {
                    // Director Center with upload functionality
                    sidebarItem.onclick = checkUploadPassword;
                } else if (item.isApps) {
                    // Apps Center
                    sidebarItem.onclick = openAppsCenter;
                } else if (item.isAds) {
                    // Ads Center
                    sidebarItem.onclick = openAdsCenter;
                } else if (item.isViewApps) {
                    // View Apps
                    sidebarItem.onclick = viewApps;
                } else if (item.isViewAds) {
                    // View Ads
                    sidebarItem.onclick = viewAds;
                } else if (item.isVideoManagement) {
                    // Video Management
                    sidebarItem.onclick = checkVideoManagementPassword;
                } else if (item.isSettings) {
                    // Settings
                    sidebarItem.onclick = checkSettingsPassword;
                } else {
                    sidebarItem.onclick = () => window.open(item.url, '_blank');
                }
                
                const img = document.createElement('img');
                img.src = item.logoUrl;
                img.alt = item.name;
                const span = document.createElement('span');
                span.textContent = item.name;
                sidebarItem.appendChild(img);
                sidebarItem.appendChild(span);
                sidebarList.appendChild(sidebarItem);
            });
        };
        // Call the function to populate the sidebar on page load
        populateSidebar();
        
        // Function to shuffle array
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }
        
        // Create carousel using the data array - Updated to match screenshot
        const createCarousel = () => {
            const carousel = document.getElementById("carousel");
            const dotsContainer = document.getElementById("dots");
            carousel.innerHTML = '';
            dotsContainer.innerHTML = '';
            
            // Use the first 5 items for carousel
            const carouselData = data.slice(0, 5);
            
            carouselData.forEach((item, index) => {
                const slide = document.createElement("div");
                slide.className = "slide";
                
                // Format tags for display
                const tagsDisplay = item.tags ? item.tags.join("  ") : "";
                
                // Use carouselCover if available, otherwise fall back to imgUrl
                const carouselImage = item.carouselCover || item.imgUrl;
                
                // Determine if it's a series or movie
                const isSeries = item.type === 'series' || item.type === 'anime';
                const typeIcon = isSeries ? 
                    '<i class="fas fa-tv" style="margin-right: 5px; color: #00b300;"></i>' : 
                    '<i class="fas fa-film" style="margin-right: 5px; color: #00b300;"></i>';
                
                slide.innerHTML = `
                    <img src="${carouselImage}" alt="${item.title}">
                    <div class="overlay"></div>
                    <div class="video-title" style="color: white;">${typeIcon}${item.title}</div>
                    <div class="video-info">
                        ${isSeries ? 'Series' : 'Movie'} | ${item.year || '2025'} | ${item.category || 'N/A'} | ${item.country || 'N/A'}
                    </div>
                    <button class="download-btn">
                        <i class="fas fa-download"></i> Download
                    </button>
                `;
                
                // Add click event to open modal
                slide.onclick = () => openVideoNav(item.videoUrl, item.title, item);
                
                carousel.appendChild(slide);
                
                const dot = document.createElement("div");
                dot.className = "dot";
                if (index === 0) dot.classList.add("active");
                dot.addEventListener("click", () => goToSlide(index));
                dotsContainer.appendChild(dot);
            });
        };
        
        const createDiscoverSection = () => {
            const discoverScroll = document.getElementById('discover-scroll');
            discoverScroll.innerHTML = '';
            
            // Use items from index 5 to 24 (20 items) for discover section
            const discoverData = data.slice(5, 25);
            
            discoverData.forEach(item => {
                const discoverItem = document.createElement('div');
                discoverItem.className = 'discover-item';
                const img = document.createElement('img');
                img.src = item.imgUrl; // Use movie cover for discover section
                img.alt = item.title;
                const content = document.createElement('div');
                content.className = 'content';
                content.innerHTML = `
                    <h2>${item.title}</h2>
                    <p>${item.description}</p>
                `;
                
                // Add click event to the entire discover item
                discoverItem.onclick = () => openVideoNav(item.videoUrl, item.title, item);
                
                discoverItem.appendChild(img);
                discoverItem.appendChild(content);
                discoverScroll.appendChild(discoverItem);
            });
        };
        const createCategories = () => {
            const categories = [...new Set(data.map(item => item.category))]; // Get unique categories
            const container = document.getElementById('categories-container');
            container.innerHTML = '';
            categories.forEach(category => {
                const categoryData = data.filter(item => item.category === category); // Use original data
                const categoryContainer = document.createElement('div');
                categoryContainer.className = 'category-container';
                const categoryTitle = document.createElement('div');
                categoryTitle.className = 'category-title';
                categoryTitle.innerHTML = `
                    <span>
                        ${category}
                        <i class="fas fa-chevron-right"></i> <!-- Right arrow icon -->
                    </span>
                    <button onclick="showAllVideos('${category}')">All <i class="fas fa-chevron-right"></i></button>
                `;
                // Make the entire title clickable
                categoryTitle.onclick = () => showAllVideos(category);
                const categoryScroll = document.createElement('div');
                categoryScroll.className = 'category-scroll';
                // Display all videos in the category (no slice limit)
                categoryData.forEach(item => {
                    const frame = createFrame(item);
                    categoryScroll.appendChild(frame);
                });
                categoryContainer.appendChild(categoryTitle);
                categoryContainer.appendChild(categoryScroll);
                container.appendChild(categoryContainer);
            });
        };
        
        // Function to show all videos in grid layout
        const showAllVideosGrid = () => {
            // Reset scroll position
            window.scrollTo(0, 0);
            
            // Set flag and push state for grid view
            inGridView = true;
            history.pushState({ gridView: true }, '');
            
            const gridContainer = document.getElementById('grid-container');
            gridContainer.innerHTML = '';
            gridContainer.scrollTop = 0; // Reset grid container scroll
            
            // Hide other sections
            document.getElementById('discover-container').style.display = 'none';
            document.getElementById('categories-container').style.display = 'none';
            gridContainer.style.display = 'grid';
            
            // Add all videos to the grid
            data.forEach(item => {
                const frame = createFrame(item);
                gridContainer.appendChild(frame);
            });
        };
        
        const showTrendingVideos = () => {
            // Reset scroll position
            window.scrollTo(0, 0);
            
            // Set flag and push state for grid view
            inGridView = true;
            history.pushState({ gridView: true }, '');
            
            const trendingData = data.filter(item => item.trending); // Filter trending videos
            currentGridData = trendingData; // Set current grid data for filtering
            
            const gridContainer = document.getElementById('grid-container');
            gridContainer.innerHTML = '';
            gridContainer.scrollTop = 0; // Reset grid container scroll
            
            // Hide other sections
            document.getElementById('discover-container').style.display = 'none';
            document.getElementById('categories-container').style.display = 'none';
            gridContainer.style.display = 'grid';
            
            // Add filter section
            const filterSection = createFilterSection();
            gridContainer.insertBefore(filterSection, gridContainer.firstChild);
            
            // Add trending videos to the grid
            if (trendingData.length > 0) {
                trendingData.forEach(item => {
                    const frame = createFrame(item);
                    gridContainer.appendChild(frame);
                });
            } else {
                showNotification('No trending movies found.', 'warning');
            }
        };
        
        const showProfileSection = () => {
            // Reset scroll position
            window.scrollTo(0, 0);
            
            // Set flag and push state for grid view
            inGridView = true;
            history.pushState({ gridView: true }, '');
            
            const gridContainer = document.getElementById('grid-container');
            gridContainer.innerHTML = '';
            gridContainer.scrollTop = 0; // Reset grid container scroll
            
            // Hide other sections
            document.getElementById('discover-container').style.display = 'none';
            document.getElementById('categories-container').style.display = 'none';
            gridContainer.style.display = 'block'; // Use block for list layout
            
            // Create Apps section with count
            const appsSection = document.createElement('div');
            appsSection.className = 'view-section';
            appsSection.innerHTML = `
                <div class="view-section-header">
                    <h3 class="view-section-title">Apps Center</h3>
                    <span class="view-section-count">${profileApps ? profileApps.length : 0} apps</span>
                </div>
                <div class="view-section-content" id="apps-section-content">
                    <!-- Apps will be added here -->
                </div>
            `;
            
            // Create Ads section with count
            const adsSection = document.createElement('div');
            adsSection.className = 'view-section';
            adsSection.innerHTML = `
                <div class="view-section-header">
                    <h3 class="view-section-title">Ads Center</h3>
                    <span class="view-section-count">${adsData ? adsData.length : 0} ads</span>
                </div>
                <div class="view-section-content" id="ads-section-content">
                    <!-- Ads will be added here -->
                </div>
            `;
            
            gridContainer.appendChild(appsSection);
            gridContainer.appendChild(adsSection);
            
            // Add apps to the apps section
            const appsContent = document.getElementById('apps-section-content');
            if (profileApps && profileApps.length > 0) {
                profileApps.forEach(item => {
                    const appItem = createProfileItem(item);
                    appsContent.appendChild(appItem);
                });
            } else {
                appsContent.innerHTML = '<p>No apps available</p>';
            }
            
            // Add ads to the ads section
            const adsContent = document.getElementById('ads-section-content');
            if (adsData && adsData.length > 0) {
                adsData.forEach(item => {
                    const adItem = createProfileAdItem(item);
                    adsContent.appendChild(adItem);
                });
            } else {
                adsContent.innerHTML = '<p>No ads available</p>';
            }
        };
        
        const showHomeVideos = () => {
            // Reset scroll position
            window.scrollTo(0, 0);
            
            // Set flag and push state for grid view
            inGridView = true;
            history.pushState({ gridView: true }, '');
            
            const homeData = data; // Use the entire data array for home videos
            currentGridData = homeData; // Set current grid data for filtering
            
            const gridContainer = document.getElementById('grid-container');
            gridContainer.innerHTML = '';
            gridContainer.scrollTop = 0; // Reset grid container scroll
            
            // Hide other sections
            document.getElementById('discover-container').style.display = 'none';
            document.getElementById('categories-container').style.display = 'none';
            gridContainer.style.display = 'grid';
            
            // Add filter section
            const filterSection = createFilterSection();
            gridContainer.insertBefore(filterSection, gridContainer.firstChild);
            
            // Add home videos to the grid
            if (homeData.length > 0) {
                homeData.forEach(item => {
                    const frame = createFrame(item);
                    gridContainer.appendChild(frame);
                });
            } else {
                showNotification('No movies found.', 'warning');
            }
        };
        
        const showMyList = () => {
            // Reset scroll position
            window.scrollTo(0, 0);
            
            // Set flag and push state for grid view
            inGridView = true;
            history.pushState({ gridView: true }, '');
            
            const gridContainer = document.getElementById('grid-container');
            gridContainer.innerHTML = '';
            gridContainer.scrollTop = 0; // Reset grid container scroll
            
            // Hide other sections
            document.getElementById('discover-container').style.display = 'none';
            document.getElementById('categories-container').style.display = 'none';
            gridContainer.style.display = 'block'; // Use block for list layout
            
            // Get saved movies from localStorage
            const savedMoviesData = data.filter(item => savedMovies.includes(item.title));
            
            if (savedMoviesData.length > 0) {
                savedMoviesData.forEach(item => {
                    const listItem = createUnlockedListItem(item);
                    gridContainer.appendChild(listItem);
                });
            } else {
                showNotification('No saved movies found. Save some movies to see them here.', 'warning');
            }
        };
        
        // Function to show the Discover section with carousel
        const showDiscoverSection = () => {
            // Reset scroll position
            window.scrollTo(0, 0);
            
            // Set flag and push state for discover view
            inGridView = false;
            history.pushState({ gridView: false, discoverView: true }, '');
            
            // Show discover and categories containers
            document.getElementById('discover-container').style.display = 'block';
            document.getElementById('categories-container').style.display = 'block';
            
            // Hide grid container
            document.getElementById('grid-container').style.display = 'none';
        };
        
        // Function to create filter section
        const createFilterSection = () => {
            const filterSection = document.createElement('div');
            filterSection.className = 'filter-section';
            
            // Get unique genres, countries, and years from currentGridData
            const genres = [...new Set(currentGridData.map(item => item.genre).filter(Boolean))];
            const countries = [...new Set(currentGridData.map(item => item.country).filter(Boolean))];
            const years = [...new Set(currentGridData.map(item => item.year).filter(Boolean))].sort((a, b) => b - a);
            
            // Create genre dropdown
            const genreDropdown = document.createElement('select');
            genreDropdown.className = 'filter-dropdown';
            genreDropdown.id = 'genre-filter';
            
            const genreDefault = document.createElement('option');
            genreDefault.value = '';
            genreDefault.textContent = 'All Category'; // Changed from "All Genres"
            genreDropdown.appendChild(genreDefault);
            
            genres.forEach(genre => {
                const option = document.createElement('option');
                option.value = genre;
                option.textContent = genre;
                genreDropdown.appendChild(option);
            });
            
            // Create country dropdown
            const countryDropdown = document.createElement('select');
            countryDropdown.className = 'filter-dropdown';
            countryDropdown.id = 'country-filter';
            
            const countryDefault = document.createElement('option');
            countryDefault.value = '';
            countryDefault.textContent = 'All Countries';
            countryDropdown.appendChild(countryDefault);
            
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                countryDropdown.appendChild(option);
            });
            
            // Create year dropdown
            const yearDropdown = document.createElement('select');
            yearDropdown.className = 'filter-dropdown';
            yearDropdown.id = 'year-filter';
            
            const yearDefault = document.createElement('option');
            yearDefault.value = '';
            yearDefault.textContent = 'All Years';
            yearDropdown.appendChild(yearDefault);
            
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearDropdown.appendChild(option);
            });
            
            // Add event listeners to apply filters automatically when selection changes
            genreDropdown.addEventListener('change', applyGridFilters);
            countryDropdown.addEventListener('change', applyGridFilters);
            yearDropdown.addEventListener('change', applyGridFilters);
            
            // Add elements to filter section
            filterSection.appendChild(genreDropdown);
            filterSection.appendChild(countryDropdown);
            filterSection.appendChild(yearDropdown);
            
            return filterSection;
        };
        
        // Function to apply grid filters
        const applyGridFilters = () => {
            const genreValue = document.getElementById('genre-filter').value;
            const countryValue = document.getElementById('country-filter').value;
            const yearValue = document.getElementById('year-filter').value;
            
            let filteredData = currentGridData;
            
            if (genreValue) {
                filteredData = filteredData.filter(item => item.genre === genreValue);
            }
            
            if (countryValue) {
                filteredData = filteredData.filter(item => item.country === countryValue);
            }
            
            if (yearValue) {
                filteredData = filteredData.filter(item => item.year == yearValue);
            }
            
            // Update the grid with filtered data
            const gridContainer = document.getElementById('grid-container');
            
            // Remove existing frames but keep the filter section
            const filterSection = gridContainer.querySelector('.filter-section');
            gridContainer.innerHTML = '';
            if (filterSection) {
                gridContainer.appendChild(filterSection);
            }
            
            if (filteredData.length > 0) {
                filteredData.forEach(item => {
                    const frame = createFrame(item);
                    gridContainer.appendChild(frame);
                });
            } else {
                showNotification('No movies found with the selected filters.', 'warning');
            }
        };
        
        const createProfileItem = (item) => {
            const profileItem = document.createElement('div');
            profileItem.className = 'profile-item';
            profileItem.style.display = 'flex';
            profileItem.style.alignItems = 'center';
            profileItem.style.gap = '10px';
            profileItem.style.padding = '10px';
            profileItem.style.borderBottom = '1px solid #333';
            
            const icon = document.createElement('img');
            icon.src = item.icon || 'https://picsum.photos/seed/app/50/50.jpg';
            icon.alt = item.name;
            icon.style.width = '50px';
            icon.style.height = '50px';
            icon.style.borderRadius = '8px';
            
            const content = document.createElement('div');
            content.style.flex = '1';
            
            const name = document.createElement('h4');
            name.textContent = item.name;
            name.style.margin = '0';
            name.style.fontSize = '13px';
            name.style.color = '#ccc';
            
            const description = document.createElement('p');
            description.textContent = item.description;
            description.style.margin = '0';
            description.style.fontSize = '10px';
            description.style.color = '#888';
            
            const openButton = document.createElement('button');
            openButton.textContent = 'Install';
            openButton.style.backgroundColor = '#00b300';
            openButton.style.color = '#fff';
            openButton.style.border = 'none';
            openButton.style.padding = '6px 12px';
            openButton.style.borderRadius = '5px';
            openButton.style.cursor = 'pointer';
            openButton.style.fontSize = '14px';
            
            openButton.onclick = async () => {
                try {
                    // Get the app document
                    const appRef = db.collection('apps').doc(item.id);
                    const appDoc = await appRef.get();
                    
                    if (appDoc.exists) {
                        // Get current view count
                        const currentViews = appDoc.data().views || 0;
                        const newViews = currentViews + 1;
                        
                        // Update view count in Firestore
                        await appRef.update({ views: newViews });
                        
                        // Update button text to show view count
                        openButton.textContent = `${formatViewCount(newViews)} views`;
                        
                        // Update local data
                        item.views = newViews;
                    } else {
                        // If document doesn't exist, create it with view count
                        await appRef.set({ 
                            views: 1,
                            ...item 
                        });
                        openButton.textContent = '1 views';
                        item.views = 1;
                    }
                    
                    // Open the app link
                    window.open(item.link, '_blank');
                } catch (error) {
                    console.error('Error updating app view count:', error);
                    showNotification('Error updating view count', 'error');
                    
                    // Still open the link even if there's an error
                    window.open(item.link, '_blank');
                }
            };
            
            content.appendChild(name);
            content.appendChild(description);
            profileItem.appendChild(icon);
            profileItem.appendChild(content);
            profileItem.appendChild(openButton);
            
            return profileItem;
        };
        
        const createProfileAdItem = (item) => {
            const profileItem = document.createElement('div');
            profileItem.className = 'profile-item';
            profileItem.style.display = 'flex';
            profileItem.style.alignItems = 'center';
            profileItem.style.gap = '10px';
            profileItem.style.padding = '10px';
            profileItem.style.borderBottom = '1px solid #333';
            
            const icon = document.createElement('img');
            icon.src = item.image || 'https://picsum.photos/seed/ad/50/50.jpg';
            icon.alt = item.title;
            icon.style.width = '50px';
            icon.style.height = '50px';
            icon.style.borderRadius = '8px';
            
            const content = document.createElement('div');
            content.style.flex = '1';
            
            const name = document.createElement('h4');
            name.textContent = item.title;
            name.style.margin = '0';
            name.style.fontSize = '13px';
            name.style.color = '#ccc';
            
            const description = document.createElement('p');
            description.textContent = item.description;
            description.style.margin = '0';
            description.style.fontSize = '10px';
            description.style.color = '#888';
            
            const openButton = document.createElement('button');
            openButton.textContent = 'Install';
            openButton.style.backgroundColor = '#00b300';
            openButton.style.color = '#fff';
            openButton.style.border = 'none';
            openButton.style.padding = '6px 12px';
            openButton.style.borderRadius = '5px';
            openButton.style.cursor = 'pointer';
            openButton.style.fontSize = '14px';
            
            openButton.onclick = async () => {
                try {
                    // Get the ad document
                    const adRef = db.collection('ads').doc(item.id);
                    const adDoc = await adRef.get();
                    
                    if (adDoc.exists) {
                        // Get current view count
                        const currentViews = adDoc.data().views || 0;
                        const newViews = currentViews + 1;
                        
                        // Update view count in Firestore
                        await adRef.update({ views: newViews });
                        
                        // Update button text to show view count
                        openButton.textContent = `${formatViewCount(newViews)} views`;
                        
                        // Update local data
                        item.views = newViews;
                    } else {
                        // If document doesn't exist, create it with view count
                        await adRef.set({ 
                            views: 1,
                            ...item 
                        });
                        openButton.textContent = '1 views';
                        item.views = 1;
                    }
                    
                    // Open the ad link
                    window.open(item.link, '_blank');
                } catch (error) {
                    console.error('Error updating ad view count:', error);
                    showNotification('Error updating view count', 'error');
                    
                    // Still open the link even if there's an error
                    window.open(item.link, '_blank');
                }
            };
            
            content.appendChild(name);
            content.appendChild(description);
            profileItem.appendChild(icon);
            profileItem.appendChild(content);
            profileItem.appendChild(openButton);
            
            return profileItem;
        };
        
        const createFrame = (item) => {
            const frame = document.createElement('div');
            frame.className = 'frame';
            const img = document.createElement('img');
            img.src = item.imgUrl; // Use movie cover for frame
            img.alt = item.title;
            const content = document.createElement('div');
            content.className = 'content';
            const title = document.createElement('h2');
            title.textContent = item.title;
            
            // Add click event to the entire frame
            frame.onclick = () => openVideoNav(item.videoUrl, item.title, item);
            
            content.appendChild(title);
            frame.appendChild(img);
            frame.appendChild(content);
            return frame;
        };
        
        const createUnlockedListItem = (item) => {
            const listItem = document.createElement('div');
            listItem.className = 'unlocked-item';
            listItem.style.display = 'flex';
            listItem.style.alignItems = 'center';
            listItem.style.gap = '10px';
            listItem.style.padding = '10px';
            listItem.style.borderBottom = '1px solid #333';
            listItem.style.cursor = 'pointer';
            
            const img = document.createElement('img');
            img.src = item.imgUrl; // Use movie cover for list item
            img.alt = item.title;
            img.style.width = '80px';
            img.style.height = '115px';
            img.style.objectFit = 'cover';
            img.style.borderRadius = '5px';
            
            const content = document.createElement('div');
            content.style.flex = '1';
            
            const title = document.createElement('h4');
            title.textContent = item.title;
            title.style.margin = '0';
            title.style.fontSize = '14px';
            title.style.color = '#ccc';
            
            const description = document.createElement('p');
            description.textContent = item.description;
            description.style.margin = '0';
            description.style.fontSize = '12px';
            description.style.color = '#777';
            
            // Add click event to the entire list item
            listItem.onclick = () => openVideoNav(item.videoUrl, item.title, item);
            
            content.appendChild(title);
            content.appendChild(description);
            listItem.appendChild(img);
            listItem.appendChild(content);
            return listItem;
        };
        
        // Track current movie in modal
        let currentMovieInModal = null;
        
        // Modified checkVideoIdInUrl function to wait for ads data
        const checkVideoIdInUrl = async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const videoId = urlParams.get('videoId');
            
            if (videoId) {
                // Show direct link message
                const directLinkMessage = document.getElementById('direct-link-message');
                directLinkMessage.style.display = 'block';
                
                // Set flag that we're opening a direct link
                openingDirectLink = true;
                
                try {
                    // Fetch videos from Firestore
                    const fetchedVideos = await fetchVideosFromFirestore();
                    if (fetchedVideos.length > 0) {
                        data = shuffleArray(fetchedVideos);
                        
                        // Fetch ads from Firestore to ensure they're loaded
                        const fetchedAds = await fetchAdsFromFirestore();
                        if (fetchedAds.length > 0) {
                            adsData = fetchedAds;
                            updateAdDisplay();
                        }
                        
                        // Find the video with the matching ID
                        const video = data.find(item => item.id == videoId);
                        if (video) {
                            // Hide the direct link message after a short delay
                            setTimeout(() => {
                                directLinkMessage.style.display = 'none';
                            }, 2000);
                            
                            // Open video modal immediately without delay
                            openVideoNav(video.videoUrl, video.title, video);
                        } else {
                            // Video not found
                            directLinkMessage.textContent = 'Video not found. Redirecting to home page...';
                            setTimeout(() => {
                                directLinkMessage.style.display = 'none';
                                showDiscoverSection();
                            }, 3000);
                        }
                    } else {
                        // No videos available
                        directLinkMessage.textContent = 'No videos available. Please check back later.';
                        setTimeout(() => {
                            directLinkMessage.style.display = 'none';
                        }, 3000);
                    }
                } catch (error) {
                    console.error("Error fetching videos for direct link:", error);
                    directLinkMessage.textContent = 'Error loading video. Please try again later.';
                    setTimeout(() => {
                        directLinkMessage.style.display = 'none';
                    }, 3000);
                }
            }
        };
        
        // Modified openVideoNav function to ensure ads are displayed
        const openVideoNav = async (videoUrl, videoId, item) => {
            // Check network connection before opening video
            if (!navigator.onLine) {
                showNetworkWarning();
                return;
            }
            
            // Validate video URL
            if (!isValidVideoUrl(videoUrl)) {
                showNotification('Invalid video URL', 'warning');
                return;
            }
            
            // Display the video navigation modal
            document.getElementById('video-nav').style.display = 'flex';
            
            // Check if the iframe exists, if not create it
            const navBody = document.querySelector('.nav-body');
            const iframeContainer = navBody.querySelector('div[style*="position: relative"]');
            let videoPlayer = document.getElementById('video-player');
            
            if (!videoPlayer) {
                // Create a new iframe
                videoPlayer = document.createElement('iframe');
                videoPlayer.id = 'video-player';
                videoPlayer.setAttribute('frameborder', '0');
                videoPlayer.setAttribute('allowfullscreen', '');
                videoPlayer.style.width = '100%';
                videoPlayer.style.height = '100%';
                iframeContainer.appendChild(videoPlayer);
            }
            
            // Process the video URL based on its source
            let processedUrl = videoUrl;
            
            // Check if it's a YouTube embed URL
            if (videoUrl.includes('youtube.com/embed/')) {
                // Add autoplay=1 parameter for YouTube to autoplay with sound
                const separator = videoUrl.includes('?') ? '&' : '?';
                processedUrl = videoUrl + separator + 'autoplay=1&mute=0';
            } 
            // Check if it's a Vimeo embed URL
            else if (videoUrl.includes('player.vimeo.com/video/')) {
                // Add autoplay parameter for Vimeo
                const separator = videoUrl.includes('?') ? '&' : '?';
                processedUrl = videoUrl + separator + 'autoplay=1&muted=0';
            }
            // Check if it's a Dailymotion embed URL
            else if (videoUrl.includes('dailymotion.com/embed/video/')) {
                // Add autoplay parameters for Dailymotion
                const separator = videoUrl.includes('?') ? '&' : '?';
                processedUrl = videoUrl + separator + 'autoplay=1&muted=0';
            }
            // For direct video files (mp4, webm, etc.)
            else if (videoUrl.match(/\.(mp4|webm|ogg|avi|mov)(\?.*)?$/i)) {
                // Create a video element instead of iframe for direct video files
                const existingVideo = iframeContainer.querySelector('video');
                if (existingVideo) {
                    existingVideo.remove();
                }
                
                const videoElement = document.createElement('video');
                videoElement.id = 'video-player';
                videoElement.controls = true;
                videoElement.autoplay = true;
                videoElement.style.width = '100%';
                videoElement.style.height = '100%';
                
                const sourceElement = document.createElement('source');
                sourceElement.src = videoUrl;
                
                // Determine video type based on file extension
                if (videoUrl.includes('.mp4')) {
                    sourceElement.type = 'video/mp4';
                } else if (videoUrl.includes('.webm')) {
                    sourceElement.type = 'video/webm';
                } else if (videoUrl.includes('.ogg')) {
                    sourceElement.type = 'video/ogg';
                }
                
                videoElement.appendChild(sourceElement);
                iframeContainer.appendChild(videoElement);
                
                // Set the processed URL to the original URL
                processedUrl = videoUrl;
            }
            // For Google Drive preview or other embeddable services
            else if (videoUrl.includes('drive.google.com/file/d/')) {
                // Google Drive preview doesn't autoplay by default, so no changes needed
                processedUrl = videoUrl;
            }
            // For any other URL, use as is
            else {
                processedUrl = videoUrl;
            }
            
            // Set the processed video URL in the iframe if it's still an iframe
            if (videoPlayer.tagName === 'IFRAME') {
                videoPlayer.src = processedUrl;
            }
            
            // Track current movie
            currentMovieInModal = item;
            
            // Update save button state
            updateSaveButton();
            
            // Show/hide download button based on whether download URL is available
            const downloadBtn = document.getElementById('video-download-btn');
            if (item.downloadUrl) {
                // Show download button if download URL is available
                downloadBtn.style.display = 'flex';
                downloadBtn.onclick = () => downloadVideo(item.downloadUrl);
            } else {
                // Hide download button if no download URL is available
                downloadBtn.style.display = 'none';
            }
            
            // Ensure ads data is available before initializing ad rotation
            if (!adsData || adsData.length === 0) {
                try {
                    const fetchedAds = await fetchAdsFromFirestore();
                    if (fetchedAds.length > 0) {
                        adsData = fetchedAds;
                        updateAdDisplay();
                    }
                } catch (error) {
                    console.error('Error fetching ads for video modal:', error);
                }
            }
            
            // Initialize video ad rotation
            initVideoAdRotation();
            
            // Update view count
            if (item && item.id) {
                try {
                    // Get the video document
                    const videoRef = db.collection('videos').doc(item.id);
                    const videoDoc = await videoRef.get();
                    
                    if (videoDoc.exists) {
                        // Get current view count
                        const currentViews = videoDoc.data().views || 0;
                        const newViews = currentViews + 1;
                        
                        // Update view count in Firestore
                        await videoRef.update({ views: newViews });
                        
                        // Update view count display with icon only
                        document.getElementById('view-count').innerHTML = `<i class="fas fa-eye"></i> ${formatViewCount(newViews)}`;
                        
                        // Update local data
                        item.views = newViews;
                    } else {
                        // If document doesn't exist, create it with view count
                        await videoRef.set({ 
                            views: 1,
                            ...item 
                        });
                        document.getElementById('view-count').innerHTML = `<i class="fas fa-eye"></i> 1`;
                        item.views = 1;
                    }
                } catch (error) {
                    console.error('Error updating view count:', error);
                    document.getElementById('view-count').innerHTML = `<i class="fas fa-eye"></i> Error`;
                }
            } else {
                document.getElementById('view-count').innerHTML = `<i class="fas fa-eye"></i> 0`;
            }
            
            // Only push state if we're not already in the modal
            if (!inVideoModal) {
                history.pushState({ videoOpen: true }, '');
                inVideoModal = true;
            }
            
            // Check if this is a series with episodes
            const episodeFooter = document.getElementById('episode-footer');
            if (item && item.isSeries && item.seasons) {
                // Show episode footer
                episodeFooter.style.display = 'block';
                
                // Set current season index (if not set, default to 0)
                if (typeof item.currentSeason === 'undefined') {
                    item.currentSeason = 0;
                }
                
                // Update episode title to include season
                document.getElementById('episode-title').textContent = `${item.title} - Season ${item.seasons[item.currentSeason].seasonNumber}`;
                
                // Update episode count for the current season
                document.getElementById('episode-count').textContent = `${item.seasons[item.currentSeason].episodes.length} Episodes`;
                
                // Clear existing episodes
                const episodeScroller = document.getElementById('episode-scroller');
                episodeScroller.innerHTML = '';
                
                // Add Previous Season button if not the first season
                if (item.currentSeason > 0) {
                    const prevSeasonBtn = document.createElement('div');
                    prevSeasonBtn.className = 'season-nav-btn prev-season';
                    prevSeasonBtn.innerHTML = `
                        <span class="season-nav-text">Prev</span>
                        <span class="season-number">S${item.seasons[item.currentSeason - 1].seasonNumber}</span>
                    `;
                    
                    prevSeasonBtn.onclick = () => {
                        goToSeason(item.currentSeason - 1);
                    };
                    
                    episodeScroller.appendChild(prevSeasonBtn);
                }
                
                // Add episode buttons for the current season
                item.seasons[item.currentSeason].episodes.forEach((episode, index) => {
                    const episodeBtn = document.createElement('div');
                    episodeBtn.className = 'episode-btn';
                    if (index === 0) episodeBtn.classList.add('active');
                    
                    const epNum = document.createElement('div');
                    epNum.className = 'ep-num';
                    epNum.textContent = `EP`;
                    
                    const epNumber = document.createElement('div');
                    epNumber.textContent = episode.number;
                    
                    episodeBtn.appendChild(epNum);
                    episodeBtn.appendChild(epNumber);
                    
                    // Add click event
                    episodeBtn.onclick = () => {
                        // Set flag to indicate we're navigating episodes
                        isEpisodeNavigation = true;
                        
                        // Remove active class from all buttons
                        document.querySelectorAll('.episode-btn').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        
                        // Add active class to clicked button
                        episodeBtn.classList.add('active');
                        
                        // Process episode URL based on its type
                        let episodeUrl = episode.url;
                        
                        // Check if it's a YouTube embed URL
                        if (episodeUrl.includes('youtube.com/embed/')) {
                            const separator = episodeUrl.includes('?') ? '&' : '?';
                            episodeUrl = episodeUrl + separator + 'autoplay=1&mute=0';
                        }
                        // Check if it's a Vimeo embed URL
                        else if (episodeUrl.includes('player.vimeo.com/video/')) {
                            const separator = episodeUrl.includes('?') ? '&' : '?';
                            episodeUrl = episodeUrl + separator + 'autoplay=1&muted=0';
                        }
                        // Check if it's a Dailymotion embed URL
                        else if (episodeUrl.includes('dailymotion.com/embed/video/')) {
                            const separator = episodeUrl.includes('?') ? '&' : '?';
                            episodeUrl = episodeUrl + separator + 'autoplay=1&muted=0';
                        }
                        // For direct video files
                        else if (episodeUrl.match(/\.(mp4|webm|ogg|avi|mov)(\?.*)?$/i)) {
                            // Create a video element instead of iframe for direct video files
                            const existingVideo = iframeContainer.querySelector('video');
                            if (existingVideo) {
                                existingVideo.remove();
                            }
                            
                            const videoElement = document.createElement('video');
                            videoElement.id = 'video-player';
                            videoElement.controls = true;
                            videoElement.autoplay = true;
                            videoElement.style.width = '100%';
                            videoElement.style.height = '100%';
                            
                            const sourceElement = document.createElement('source');
                            sourceElement.src = episode.url;
                            
                            // Determine video type based on file extension
                            if (episode.url.includes('.mp4')) {
                                sourceElement.type = 'video/mp4';
                            } else if (episode.url.includes('.webm')) {
                                sourceElement.type = 'video/webm';
                            } else if (episode.url.includes('.ogg')) {
                                sourceElement.type = 'video/ogg';
                            }
                            
                            videoElement.appendChild(sourceElement);
                            iframeContainer.appendChild(videoElement);
                            
                            // Reset flag after a short delay
                            setTimeout(() => {
                                isEpisodeNavigation = false;
                            }, 100);
                            return;
                        }
                        
                        // Load episode in iframe
                        if (videoPlayer.tagName === 'IFRAME') {
                            videoPlayer.src = episodeUrl;
                        }
                        
                        // Update download button for this episode
                        const downloadBtn = document.getElementById('video-download-btn');
                        if (episode.downloadUrl && episode.downloadUrl.trim() !== '') {
                            downloadBtn.style.display = 'flex';
                            downloadBtn.onclick = () => downloadVideo(episode.downloadUrl);
                        } else {
                            downloadBtn.style.display = 'none';
                        }
                        
                        // Reset flag after a short delay
                        setTimeout(() => {
                            isEpisodeNavigation = false;
                        }, 100);
                    };
                    
                    episodeScroller.appendChild(episodeBtn);
                });
                
                // Add Next Season button if not the last season
                if (item.currentSeason < item.seasons.length - 1) {
                    const nextSeasonBtn = document.createElement('div');
                    nextSeasonBtn.className = 'season-nav-btn next-season';
                    nextSeasonBtn.innerHTML = `
                        <span class="season-nav-text">Next</span>
                        <span class="season-number">S${item.seasons[item.currentSeason + 1].seasonNumber}</span>
                    `;
                    
                    nextSeasonBtn.onclick = () => {
                        goToSeason(item.currentSeason + 1);
                    };
                    
                    episodeScroller.appendChild(nextSeasonBtn);
                }
            } else {
                // Hide episode footer for non-series content
                episodeFooter.style.display = 'none';
            }
            
            // Add the video to the history
            addToHistory(videoId);
        };
        
        // Function to download video
        const downloadVideo = (downloadUrl) => {
            if (!downloadUrl) {
                showNotification('Download URL not available', 'warning');
                return;
            }
            
            // Open the download URL in a new tab
            window.open(downloadUrl, '_blank');
            
            // Show notification
            showNotification('Download started', 'success');
        };
        
        // Function to go to a specific season
        const goToSeason = (seasonIndex) => {
            if (!currentMovieInModal || !currentMovieInModal.isSeries || !currentMovieInModal.seasons) return;
            
            // Set flag to indicate we're navigating episodes
            isEpisodeNavigation = true;
            
            // Update current season
            currentMovieInModal.currentSeason = seasonIndex;
            
            // Update the episode scroller for the new season
            const currentSeason = currentMovieInModal.seasons[seasonIndex];
            document.getElementById('episode-title').textContent = `${currentMovieInModal.title} - Season ${currentSeason.seasonNumber}`;
            document.getElementById('episode-count').textContent = `${currentSeason.episodes.length} Episodes`;
            
            // Clear and repopulate episode scroller
            const episodeScroller = document.getElementById('episode-scroller');
            episodeScroller.innerHTML = '';
            
            // Add Previous Season button if not the first season
            if (seasonIndex > 0) {
                const prevSeasonBtn = document.createElement('div');
                prevSeasonBtn.className = 'season-nav-btn prev-season';
                prevSeasonBtn.innerHTML = `
                    <span class="season-nav-text">PREV</span>
                    <span class="season-number">S${currentMovieInModal.seasons[seasonIndex - 1].seasonNumber}</span>
                `;
                
                prevSeasonBtn.onclick = () => {
                    goToSeason(seasonIndex - 1);
                };
                
                episodeScroller.appendChild(prevSeasonBtn);
            }
            
            // Add episode buttons for the current season
            currentSeason.episodes.forEach((episode, index) => {
                const episodeBtn = document.createElement('div');
                episodeBtn.className = 'episode-btn';
                if (index === 0) episodeBtn.classList.add('active');
                
                const epNum = document.createElement('div');
                epNum.className = 'ep-num';
                epNum.textContent = `EP`;
                
                const epNumber = document.createElement('div');
                epNumber.textContent = episode.number;
                
                episodeBtn.appendChild(epNum);
                episodeBtn.appendChild(epNumber);
                
                episodeBtn.onclick = () => {
                    // Set flag to indicate we're navigating episodes
                    isEpisodeNavigation = true;
                    
                    document.querySelectorAll('.episode-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    episodeBtn.classList.add('active');
                    
                    // Process episode URL if it's a YouTube video
                    let episodeUrl = episode.url;
                    if (episodeUrl.includes('youtube.com/embed/')) {
                        const separator = episodeUrl.includes('?') ? '&' : '?';
                        episodeUrl = episodeUrl + separator + 'autoplay=1&mute=0';
                    }
                    
                    document.getElementById('video-player').src = episodeUrl;
                    
                    // Update download button for this episode
                    const downloadBtn = document.getElementById('video-download-btn');
                    if (episode.downloadUrl && episode.downloadUrl.trim() !== '') {
                        downloadBtn.style.display = 'flex';
                        downloadBtn.onclick = () => downloadVideo(episode.downloadUrl);
                    } else {
                        downloadBtn.style.display = 'none';
                    }
                    
                    // Reset flag after a short delay
                    setTimeout(() => {
                        isEpisodeNavigation = false;
                    }, 100);
                };
                
                episodeScroller.appendChild(episodeBtn);
            });
            
            // Add Next Season button if not the last season
            if (seasonIndex < currentMovieInModal.seasons.length - 1) {
                const nextSeasonBtn = document.createElement('div');
                nextSeasonBtn.className = 'season-nav-btn next-season';
                nextSeasonBtn.innerHTML = `
                    <span class="season-nav-text">NEXT</span>
                    <span class="season-number">S${currentMovieInModal.seasons[seasonIndex + 1].seasonNumber}</span>
                `;
                
                nextSeasonBtn.onclick = () => {
                    goToSeason(seasonIndex + 1);
                };
                
                episodeScroller.appendChild(nextSeasonBtn);
            }
            
            // Load the first episode of the new season
            if (currentSeason.episodes.length > 0) {
                let firstEpisodeUrl = currentSeason.episodes[0].url;
                // Process URL if it's a YouTube video
                if (firstEpisodeUrl.includes('youtube.com/embed/')) {
                    const separator = firstEpisodeUrl.includes('?') ? '&' : '?';
                    firstEpisodeUrl = firstEpisodeUrl + separator + 'autoplay=1&mute=0';
                }
                document.getElementById('video-player').src = firstEpisodeUrl;
                
                // Update download button for first episode
                const firstEpisode = currentSeason.episodes[0];
                const downloadBtn = document.getElementById('video-download-btn');
                if (firstEpisode.downloadUrl && firstEpisode.downloadUrl.trim() !== '') {
                    downloadBtn.style.display = 'flex';
                    downloadBtn.onclick = () => downloadVideo(firstEpisode.downloadUrl);
                } else {
                    downloadBtn.style.display = 'none';
                }
            }
            
            // Scroll to the beginning of the episode scroller
            episodeScroller.scrollLeft = 0;
            
            // Reset flag after a short delay
            setTimeout(() => {
                isEpisodeNavigation = false;
            }, 100);
        };
        
        // Function to update save button state
        const updateSaveButton = () => {
            const saveBtn = document.getElementById('save-btn');
            if (currentMovieInModal && savedMovies.includes(currentMovieInModal.title)) {
                saveBtn.textContent = 'Added';
                saveBtn.style.backgroundColor = '#ff0000';
            } else {
                saveBtn.textContent = 'Add to list';
                saveBtn.style.backgroundColor = '#00b300';
            }
        };
        
        // Function to toggle save status
        const toggleSaveStatus = () => {
            if (!currentMovieInModal) return;
            
            const movieTitle = currentMovieInModal.title;
            const saveBtn = document.getElementById('save-btn');
            
            if (savedMovies.includes(movieTitle)) {
                // Remove from saved list
                savedMovies = savedMovies.filter(title => title !== movieTitle);
                saveBtn.textContent = 'Add to list';
                saveBtn.style.backgroundColor = '#00b300';
                showNotification('Removed from My List', 'success');
            } else {
                // Add to saved list
                savedMovies.push(movieTitle);
                saveBtn.textContent = 'Added';
                saveBtn.style.backgroundColor = '#ff0000';
                showNotification('Added to My List', 'success');
            }
            
            // Update localStorage
            localStorage.setItem('savedMovies', JSON.stringify(savedMovies));
        };
        
        const addToHistory = (videoId) => {
            const history = JSON.parse(localStorage.getItem('videoHistory')) || [];
            const video = data.find(item => item.title === videoId);
            if (video) {
                // Remove duplicate entries
                const filteredHistory = history.filter(item => item.title !== videoId);
                // Add the new entry at the beginning
                filteredHistory.unshift(video);
                // Save the updated history
                localStorage.setItem('videoHistory', JSON.stringify(filteredHistory));
                // Update the history list
                updateHistoryList();
            }
        };
        
        const updateHistoryList = () => {
            const history = JSON.parse(localStorage.getItem('videoHistory')) || [];
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';
            if (history.length === 0) {
                historyList.innerHTML = '<p>No history available.</p>';
                return;
            }
            history.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                const img = document.createElement('img');
                img.src = item.imgUrl;
                img.alt = item.title;
                const content = document.createElement('div');
                content.className = 'content';
                content.innerHTML = `
                    <h4>${item.title}</h4>
                    <p>${item.description}</p>
                `;
                
                // Add click event to the entire history item that closes the history modal
                historyItem.onclick = () => {
                    // Close the history modal first
                    toggleHistoryModal();
                    // Then open the video
                    openVideoNav(item.videoUrl, item.title, item);
                };
                
                historyItem.appendChild(img);
                historyItem.appendChild(content);
                historyList.appendChild(historyItem);
            });
        };
        
        const clearHistory = () => {
            localStorage.removeItem('videoHistory');
            updateHistoryList();
            showNotification('All history has been cleared.', 'success');
        };
        
        const showAllVideos = (category) => {
            // Reset scroll position
            window.scrollTo(0, 0);
            
            // Set flag and push state for grid view
            inGridView = true;
            history.pushState({ gridView: true }, '');
            
            const categoryData = data.filter(item => item.category === category);
            currentGridData = categoryData; // Set current grid data for filtering
            
            const gridContainer = document.getElementById('grid-container');
            gridContainer.innerHTML = '';
            gridContainer.scrollTop = 0; // Reset grid container scroll
            
            // Hide other sections
            document.getElementById('discover-container').style.display = 'none';
            document.getElementById('categories-container').style.display = 'none';
            gridContainer.style.display = 'grid';
            
            // Add filter section
            const filterSection = createFilterSection();
            gridContainer.insertBefore(filterSection, gridContainer.firstChild);
            
            // Add videos to the grid
            categoryData.forEach(item => {
                const frame = createFrame(item);
                gridContainer.appendChild(frame);
            });
        };
        
        // Enhanced search function to search by title, genre, tags, and keywords
        const handleSearch = () => {
            const searchTerm = document.getElementById('search-bar').value.toLowerCase();
            currentSearchTerm = searchTerm;
            
            // Clear any existing timeout
            clearTimeout(searchTimeout);
            
            // Set a new timeout to delay the search
            searchTimeout = setTimeout(() => {
                // Reset scroll position
                window.scrollTo(0, 0);
                
                // Set flag and push state for grid view
                inGridView = true;
                history.pushState({ gridView: true }, '');
                
                // Filter data based on search term across multiple fields
                const filteredData = data.filter(item => {
                    // Search in title
                    if (item.title && item.title.toLowerCase().includes(searchTerm)) {
                        return true;
                    }
                    
                    // Search in genre
                    if (item.genre && item.genre.toLowerCase().includes(searchTerm)) {
                        return true;
                    }
                    
                    // Search in tags
                    if (item.tags && Array.isArray(item.tags)) {
                        for (const tag of item.tags) {
                            if (tag.toLowerCase().includes(searchTerm)) {
                                return true;
                            }
                        }
                    }
                    
                    // Search in description (keywords)
                    if (item.description && item.description.toLowerCase().includes(searchTerm)) {
                        return true;
                    }
                    
                    // Search in category
                    if (item.category && item.category.toLowerCase().includes(searchTerm)) {
                        return true;
                    }
                    
                    // Search in year
                    if (item.year && item.year.toString().includes(searchTerm)) {
                        return true;
                    }
                    
                    // Search in type (Movie, Series, etc.)
                    if (item.type && item.type.toLowerCase().includes(searchTerm)) {
                        return true;
                    }
                    
                    return false;
                });
                
                currentGridData = filteredData; // Set current grid data for filtering
                
                const gridContainer = document.getElementById('grid-container');
                gridContainer.innerHTML = '';
                gridContainer.scrollTop = 0; // Reset grid container scroll
                
                // Hide other sections
                document.getElementById('discover-container').style.display = 'none';
                document.getElementById('categories-container').style.display = 'none';
                gridContainer.style.display = 'grid';
                
                // Add filter section
                const filterSection = createFilterSection();
                gridContainer.insertBefore(filterSection, gridContainer.firstChild);
                
                // Add search results to the grid
                if (filteredData.length > 0) {
                    filteredData.forEach(item => {
                        const frame = createFrame(item);
                        gridContainer.appendChild(frame);
                    });
                } else {
                    showNotification('No movies found matching your search.', 'warning');
                }
            }, 300); // 300ms delay for better performance
        };
        
        // Function to show search suggestions
        const showSearchSuggestions = () => {
            const searchTerm = document.getElementById('search-bar').value.toLowerCase();
            const suggestionsContainer = document.getElementById('search-suggestions');
            
            if (searchTerm.length < 2) {
                suggestionsContainer.innerHTML = '';
                suggestionsContainer.classList.remove('show');
                return;
            }
            
            // Get unique suggestions from various fields
            const suggestions = new Set();
            
            data.forEach(item => {
                // Title suggestions
                if (item.title && item.title.toLowerCase().includes(searchTerm)) {
                    suggestions.add({
                        text: item.title,
                        type: 'Title',
                        item: item
                    });
                }
                
                // Genre suggestions
                if (item.genre && item.genre.toLowerCase().includes(searchTerm)) {
                    suggestions.add({
                        text: item.genre,
                        type: 'Genre',
                        item: item
                    });
                }
                
                // Tag suggestions
                if (item.tags && Array.isArray(item.tags)) {
                    item.tags.forEach(tag => {
                        if (tag.toLowerCase().includes(searchTerm)) {
                            suggestions.add({
                                text: tag,
                                type: 'Tag',
                                item: item
                            });
                        }
                    });
                }
                
                // Category suggestions
                if (item.category && item.category.toLowerCase().includes(searchTerm)) {
                    suggestions.add({
                        text: item.category,
                        type: 'Category',
                        item: item
                    });
                }
            });
            
            // Convert to array and limit to 5 suggestions
            const suggestionsArray = Array.from(suggestions).slice(0, 5);
            
            // Clear and populate suggestions container
            suggestionsContainer.innerHTML = '';
            
            if (suggestionsArray.length > 0) {
                suggestionsArray.forEach(suggestion => {
                    const suggestionItem = document.createElement('div');
                    suggestionItem.className = 'search-suggestion-item';
                    suggestionItem.innerHTML = `
                        ${suggestion.text}
                        <span class="suggestion-type">${suggestion.type}</span>
                    `;
                    
                    suggestionItem.onclick = () => {
                        document.getElementById('search-bar').value = suggestion.text;
                        handleSearch();
                        suggestionsContainer.classList.remove('show');
                    };
                    
                    suggestionsContainer.appendChild(suggestionItem);
                });
                
                suggestionsContainer.classList.add('show');
            } else {
                suggestionsContainer.classList.remove('show');
            }
        };
        
        // Function to hide search suggestions with delay
        const hideSearchSuggestions = () => {
            setTimeout(() => {
                document.getElementById('search-suggestions').classList.remove('show');
            }, 200);
        };
        
        // Improved notification system - Updated to center
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            // Position fixed at center
            notification.style.position = 'fixed';
            notification.style.top = '50%';
            notification.style.left = '50%';
            notification.style.transform = 'translate(-50%, -50%)';
            notification.style.zIndex = '10000';
            notification.style.padding = '15px 25px';
            notification.style.borderRadius = '8px';
            notification.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
            notification.style.maxWidth = '80%';
            notification.style.textAlign = 'center';
            
            // Style based on type
            switch(type) {
                case 'success':
                    notification.style.backgroundColor = '#4CAF50';
                    notification.style.color = 'white';
                    break;
                case 'warning':
                    notification.style.backgroundColor = '#FF9800';
                    notification.style.color = 'white';
                    break;
                case 'error':
                    notification.style.backgroundColor = '#F44336';
                    notification.style.color = 'white';
                    break;
                default:
                    notification.style.backgroundColor = '#2196F3';
                    notification.style.color = 'white';
            }
            
            document.body.appendChild(notification);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s ease';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 500);
            }, 3000);
        }
        
        // New functions for added features
        
        // Apply filters
        const applyFilters = () => {
            // Reset scroll position
            window.scrollTo(0, 0);
            
            // Set flag and push state for grid view
            inGridView = true;
            history.pushState({ gridView: true }, '');
            
            // Get selected filters
            const selectedCategory = document.querySelector('.filter-option[data-category].active')?.dataset.category || 'All';
            const selectedSort = document.querySelector('.filter-option[data-sort].active')?.dataset.sort || 'Newest';
            
            // Apply filters to data
            let filteredData = data;
            
            if (selectedCategory !== 'All') {
                // Filter by category field instead of genre
                filteredData = filteredData.filter(item => item.category === selectedCategory);
            }
            
            // Sort data
            if (selectedSort === 'Newest') {
                filteredData.sort((a, b) => b.id - a.id);
            } else if (selectedSort === 'Popular') {
                filteredData.sort((a, b) => (b.views || 0) - (a.views || 0));
            } else if (selectedSort === 'Rating') {
                filteredData.sort((a, b) => (b.rating || 0) - (a.rating || 0));
            } else if (selectedSort === 'A-Z') {
                filteredData.sort((a, b) => a.title.localeCompare(b.title));
            }
            
            // Update UI with filtered data
            const gridContainer = document.getElementById('grid-container');
            
            // Remove existing frames but keep the filter section
            const filterSection = gridContainer.querySelector('.filter-section');
            gridContainer.innerHTML = '';
            if (filterSection) {
                gridContainer.appendChild(filterSection);
            }
            
            filteredData.forEach(item => {
                const frame = createFrame(item);
                gridContainer.appendChild(frame);
            });
            
            // Close filter modal
            toggleFilterModal();
        };
        
        // Share movie function - updated to use localhost
        const shareMovie = () => {
            // Create a URL with video ID parameter using localhost
            const baseUrl = window.location.origin; // This will automatically use the current domain (localhost when developing)
            const shareUrl = `${baseUrl}?videoId=${currentMovieInModal.id}`;
            
            if (navigator.share) {
                navigator.share({
                    title: currentMovieInModal.title,
                    text: 'Check out this movie on Hausa Movies!',
                    url: shareUrl
                })
                .then(() => console.log('Shared successfully'))
                .catch((error) => console.log('Error sharing:', error));
            } else {
                // Fallback - copy to clipboard
                const dummy = document.createElement('input');
                document.body.appendChild(dummy);
                dummy.value = shareUrl;
                dummy.select();
                document.execCommand('copy');
                document.body.removeChild(dummy);
                showNotification('Link copied to clipboard!', 'success');
            }
        };
        
        // Open Edit Profile Modal
        const openEditProfileModal = () => {
            const editProfileModal = document.getElementById('edit-profile-modal');
            editProfileModal.classList.add('open');
            
            // Set current user name in input
            document.getElementById('user-name-input').value = userProfile.name;
            
            // Set selected avatar
            document.querySelectorAll('.avatar-option').forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.avatar === userProfile.avatar) {
                    option.classList.add('selected');
                }
            });
        };
        
        // Close Edit Profile Modal
        const closeEditProfileModal = () => {
            const editProfileModal = document.getElementById('edit-profile-modal');
            editProfileModal.classList.remove('open');
        };
        
        // Save Profile
        const saveProfile = () => {
            // Get selected avatar
            const selectedAvatar = document.querySelector('.avatar-option.selected');
            if (selectedAvatar) {
                userProfile.avatar = selectedAvatar.dataset.avatar;
            }
            
            // Get user name
            const userName = document.getElementById('user-name-input').value;
            if (userName.trim() !== '') {
                userProfile.name = userName.trim();
            }
            
            // Save to localStorage
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
            
            // Update UI
            updateUserProfile();
            
            // Close modal
            closeEditProfileModal();
            
            // Show notification
            showNotification('Profile updated successfully!', 'success');
        };
        
        // Update User Profile UI
        const updateUserProfile = () => {
            // Update user name
            document.getElementById('user-name').textContent = userProfile.name;
            
            // Update user avatar
            const userAvatar = document.getElementById('user-avatar');
            userAvatar.innerHTML = '';
            
            if (userProfile.avatar) {
                const avatarImg = document.createElement('img');
                avatarImg.src = getAvatarUrl(userProfile.avatar);
                avatarImg.alt = 'User Avatar';
                userAvatar.appendChild(avatarImg);
            } else {
                const defaultIcon = document.createElement('i');
                defaultIcon.className = 'fas fa-user';
                defaultIcon.style.fontSize = '36px';
                userAvatar.appendChild(defaultIcon);
            }
        };
        
        // Get Avatar URL by ID
        const getAvatarUrl = (avatarId) => {
            const avatars = {
                '1': 'https://cdn-icons-png.flaticon.com/128/6997/6997666.png',
                '2': 'https://cdn-icons-png.flaticon.com/128/6997/6997662.png',
                '3': 'https://cdn-icons-png.flaticon.com/128/6997/6997661.png',
                '4': 'https://cdn-icons-png.flaticon.com/128/6997/6997664.png'
            };
            return avatars[avatarId] || avatars['1'];
        };
        
        // Network connection warning functions - Updated to match image
        const showNetworkWarning = () => {
            const networkWarning = document.getElementById('network-warning');
            networkWarning.classList.remove('hidden');
            
            // Hide app content when network warning is shown
            document.querySelector('header').style.display = 'none';
            document.getElementById('discover-container').style.display = 'none';
            document.getElementById('categories-container').style.display = 'none';
            document.getElementById('grid-container').style.display = 'none';
            document.querySelector('footer').style.display = 'none';
        };
        
        const hideNetworkWarning = () => {
            const networkWarning = document.getElementById('network-warning');
            networkWarning.classList.add('hidden');
            
            // Restore app content when network warning is hidden
            document.querySelector('header').style.display = 'flex';
            
            // Restore the appropriate section based on current state
            if (inGridView) {
                document.getElementById('grid-container').style.display = 'grid';
            } else {
                document.getElementById('discover-container').style.display = 'block';
                document.getElementById('categories-container').style.display = 'block';
            }
            
            document.querySelector('footer').style.display = 'flex';
        };
        
        // Check network connection status
        const checkNetworkConnection = () => {
            if (navigator.onLine) {
                hideNetworkWarning();
                showNotification('Network connection restored', 'success');
                // Attempt to reload data
                initializeApp();
            } else {
                // Still offline, keep showing the warning
                showNetworkWarning();
            }
        };
        
        // Ad logic
        const adContainer = document.getElementById('adContainer');
        const adContent = document.getElementById('adContent');
        const installButton = document.getElementById('installButton');
        let currentAdIndex = parseInt(localStorage.getItem('currentAdIndex')) || 0;
        function showAd(index) {
            if (!adsData || !Array.isArray(adsData) || adsData.length === 0) {
                console.warn("Ads data not available");
                return;
            }
            
            const app = adsData[index];
            adContent.innerHTML = `
                <div class="app-icon">
                    <img src="${app.image}" alt="App Icon" />
                </div>
                <div class="ad-info">
                    <div class="app-name">${app.title}</div>
                    <div class="ad-meta">
                        <span class="sponsored">Sponsored </span>
                        <span>${app.category}  FREE</span>
                    </div>
                </div>
            `;
            installButton.href = app.link;
            adContainer.style.display = 'flex';
            localStorage.setItem('currentAdIndex', index);
        }
        function rotateAds() {
            if (!adsData || !Array.isArray(adsData) || adsData.length === 0) {
                console.warn("Ads data not available, skipping rotation");
                return;
            }
            
            showAd(currentAdIndex);
            currentAdIndex = (currentAdIndex + 1) % adsData.length;
        }
        // Show first ad immediately and rotate
        rotateAds();
        setInterval(rotateAds, 15000);
        
        // Initialize all new features when the page loads
        window.addEventListener('load', () => {
            // Initialize filter options
            document.querySelectorAll('.filter-option').forEach(option => {
                option.addEventListener('click', function() {
                    // Remove active class from siblings in the same filter-options container
                    const siblings = this.parentElement.querySelectorAll('.filter-option');
                    siblings.forEach(sib => sib.classList.remove('active'));
                    // Add active class to clicked option
                    this.classList.add('active');
                });
            });
            
            // Initialize avatar options
            document.querySelectorAll('.avatar-option').forEach(option => {
                option.addEventListener('click', function() {
                    // Remove selected class from all options
                    document.querySelectorAll('.avatar-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    // Add selected class to clicked option
                    this.classList.add('selected');
                });
            });
            
            // Update user profile UI
            updateUserProfile();
            
            // Check for video ID in URL immediately
            checkVideoIdInUrl();
            
            // Check network connection on load
            checkNetworkConnection();
            
            // Add event listeners for online/offline events
            window.addEventListener('online', () => {
                hideNetworkWarning();
                showNotification('Network connection restored', 'success');
            });
            
            window.addEventListener('offline', () => {
                showNetworkWarning();
            });
            
            // Add event listener to close modal when clicking outside
            document.getElementById('upload-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeUploadModal();
                }
            });
            
            document.getElementById('ad-upload-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeAdUploadModal();
                }
            });
            
            document.getElementById('app-upload-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeAppUploadModal();
                }
            });
            
            document.getElementById('password-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closePasswordModal();
                }
            });
            
            document.getElementById('video-management-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeVideoManagementModal();
                }
            });
            
            document.getElementById('create-folder-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeCreateFolderModal();
                }
            });
            
            document.getElementById('edit-folder-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeEditFolderModal();
                }
            });
            
            document.getElementById('video-folder-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeVideoFolderModal();
                }
            });
            
            document.getElementById('settings-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeSettingsModal();
                }
            });
            
            // Add keyboard event to close modal with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && inUploadModal) {
                    closeUploadModal();
                }
                if (e.key === 'Escape' && inAdUploadModal) {
                    closeAdUploadModal();
                }
                if (e.key === 'Escape' && inAppUploadModal) {
                    closeAppUploadModal();
                }
                if (e.key === 'Escape' && inPasswordModal) {
                    closePasswordModal();
                }
                if (e.key === 'Escape' && inVideoManagementModal) {
                    closeVideoManagementModal();
                }
                if (e.key === 'Escape' && inCreateFolderModal) {
                    closeCreateFolderModal();
                }
                if (e.key === 'Escape' && inEditFolderModal) {
                    closeEditFolderModal();
                }
                if (e.key === 'Escape' && inVideoFolderModal) {
                    closeVideoFolderModal();
                }
                if (e.key === 'Escape' && inSettingsModal) {
                    closeSettingsModal();
                }
            });
            
            // Initialize the app
            initializeApp();
            
            // Add category button click handlers
            const categoryButtons = document.querySelectorAll('.category-btn');
            categoryButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Remove active class from all buttons
                    categoryButtons.forEach(btn => btn.classList.remove('active'));
                    // Add active class to clicked button
                    this.classList.add('active');
                    
                    // Filter content based on selected category
                    const selectedCategory = this.dataset.category;
                    if (selectedCategory === 'All') {
                        // Show all discover videos when "All" category is selected
                        createDiscoverSection();
                    } else {
                        filterContentByCategory(selectedCategory);
                    }
                });
            });
            
            // Add event listeners to form inputs to save data on change
            const uploadForm = document.getElementById('upload-form');
            if (uploadForm) {
                // Save data on input change
                uploadForm.addEventListener('input', () => {
                    saveUploadFormData();
                });
                
                // Save data on select change
                uploadForm.addEventListener('change', () => {
                    saveUploadFormData();
                });
            }
        });
        
        // Function to initialize ad rotation in the video modal
        function initVideoAdRotation() {
            // Ensure ads data is available
            if (!adsData || !Array.isArray(adsData) || adsData.length === 0) {
                console.warn("Ads data not available for video modal, trying to fetch...");
                // Try to fetch ads data if not available
                fetchAdsFromFirestore().then(fetchedAds => {
                    if (fetchedAds && fetchedAds.length > 0) {
                        adsData = fetchedAds;
                        updateAdDisplay();
                        // Now initialize ad rotation
                        initializeAdRotation();
                    }
                }).catch(error => {
                    console.error('Error fetching ads for video modal:', error);
                });
                return;
            }
            
            // If ads data is available, initialize ad rotation
            initializeAdRotation();
        }
        
        // Helper function to initialize ad rotation
        function initializeAdRotation() {
            let currentVideoAdIndex = 0;
            
            function showVideoAd() {
                const ad = adsData[currentVideoAdIndex];
                const adContent = document.getElementById('video-ad-content');
                const installButton = document.getElementById('video-install-button');
                const adContainer = document.getElementById('video-ad-container');
                
                adContent.innerHTML = `
                    <div class="app-icon">
                        <img src="${ad.image}" alt="App Icon" />
                    </div>
                    <div class="ad-info">
                        <div class="app-name">${ad.title}</div>
                        <div class="ad-meta">
                            <span class="sponsored">Sponsored </span>
                            <span>${ad.category}  FREE</span>
                        </div>
                    </div>
                `;
                
                // Update install button click handler to track views
                installButton.onclick = async () => {
                    try {
                        // Get the ad document
                        const adRef = db.collection('ads').doc(ad.id);
                        const adDoc = await adRef.get();
                        
                        if (adDoc.exists) {
                            // Get current view count
                            const currentViews = adDoc.data().views || 0;
                            const newViews = currentViews + 1;
                            
                            // Update view count in Firestore
                            await adRef.update({ views: newViews });
                            
                            // Update local data
                            ad.views = newViews;
                            
                            // Open the ad link
                            window.open(ad.link, '_blank');
                        } else {
                            // If document doesn't exist, create it with view count
                            await adRef.set({ 
                                views: 1,
                                ...ad 
                            });
                            ad.views = 1;
                            
                            // Open the ad link
                            window.open(ad.link, '_blank');
                        }
                    } catch (error) {
                        console.error('Error updating ad view count:', error);
                        showNotification('Error updating view count', 'error');
                        
                        // Still open the link even if there's an error
                        window.open(ad.link, '_blank');
                    }
                };
                
                // Ensure the ad container is displayed
                adContainer.style.display = 'flex';
                
                currentVideoAdIndex = (currentVideoAdIndex + 1) % adsData.length;
            }
            
            // Show first ad immediately
            showVideoAd();
            
            // Rotate ads every 15 seconds
            setInterval(showVideoAd, 15000);
        }
        
        // Initialize the page
        async function initializeApp() {
            try {
                showLoading();
                
                // Fetch videos from Firestore
                const fetchedVideos = await fetchVideosFromFirestore();
                if (fetchedVideos.length > 0) {
                    data = shuffleArray(fetchedVideos);
                    combinedData = data;
                    createCarousel();
                    createDiscoverSection();
                    createCategories();
                    updateHistoryList();
                    initCarousel();
                } else {
                    showNotification('No videos available. Please check back later.', 'warning');
                }
                
                // Fetch ads from Firestore
                const fetchedAds = await fetchAdsFromFirestore();
                if (fetchedAds.length > 0) {
                    adsData = fetchedAds;
                    updateAdDisplay();
                }
                
                // Fetch apps from Firestore
                const fetchedApps = await fetchAppsFromFirestore();
                if (fetchedApps.length > 0) {
                    profileApps = shuffleArray(fetchedApps);
                }
                
                hideLoading();
            } catch (error) {
                console.error("App initialization failed:", error);
                showNotification("Failed to load content. Please check your connection.", 'warning');
                hideLoading();
            }
        }
        
        // Add category button click handlers
        document.addEventListener('DOMContentLoaded', () => {
            const categoryButtons = document.querySelectorAll('.category-btn');
            categoryButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Remove active class from all buttons
                    categoryButtons.forEach(btn => btn.classList.remove('active'));
                    // Add active class to clicked button
                    this.classList.add('active');
                    
                    // Filter content based on selected category
                    const selectedCategory = this.dataset.category;
                    if (selectedCategory === 'All') {
                        createDiscoverSection();
                    } else {
                        filterContentByCategory(selectedCategory);
                    }
                });
            });
        });
        
        // Function to filter content by category
        const filterContentByCategory = (category) => {
            const discoverScroll = document.getElementById('discover-scroll');
            discoverScroll.innerHTML = '';
            
            // Filter data by category
            const filteredData = data.filter(item => {
                // Check if item matches the selected category
                if (category === 'Hollywood') return item.category === 'Hollywood';
                if (category === 'Nollywood') return item.category === 'Nollywood';
                if (category === 'Bollywood') return item.category === 'Bollywood';
                if (category === 'Kannywood') return item.category === 'Kannywood';
                if (category === 'Action') return item.genre === 'Action';
                if (category === 'Short-Drama') return item.genre === 'Short-Drama';
                if (category === 'Comedy') return item.genre === 'Comedy';
                if (category === 'Adventure') return item.genre === 'Adventure';
                if (category === 'Horror') return item.genre === 'Horror';
                if (category === 'Sci-Fi') return item.genre === 'Sci-Fi';
                if (category === 'Romance') return item.genre === 'Romance';
                if (category === 'Fantasy') return item.genre === 'Fantasy';
                if (category === 'Mystery') return item.genre === 'Mystery';
                if (category === 'Crime') return item.genre === 'Crime';
                if (category === 'Documentary') return item.genre === 'Documentary';
                if (category === 'Biography') return item.genre === 'Biography';
                if (category === 'Historical') return item.genre === 'Historical';
                if (category === 'War') return item.genre === 'War';
                if (category === 'Western') return item.genre === 'Western';
                if (category === 'Musical') return item.genre === 'Musical';
                if (category === 'Animation') return item.genre === 'Animation';
                if (category === 'Family') return item.genre === 'Family';
                if (category === 'Sports') return item.genre === 'Sports';
                if (category === 'Thriller') return item.genre === 'Thriller';
                return true;
            });
            
            // Add filtered items to discover section
            filteredData.forEach(item => {
                const discoverItem = document.createElement('div');
                discoverItem.className = 'discover-item';
                const img = document.createElement('img');
                img.src = item.imgUrl;
                img.alt = item.title;
                const content = document.createElement('div');
                content.className = 'content';
                content.innerHTML = `
                    <h2>${item.title}</h2>
                    <p>${item.description}</p>
                `;
                
                // Add click event to the entire discover item
                discoverItem.onclick = () => openVideoNav(item.videoUrl, item.title, item);
                
                discoverItem.appendChild(img);
                discoverItem.appendChild(content);
                discoverScroll.appendChild(discoverItem);
            });
        };
        
        let lastScrollTop = 0;
        window.addEventListener('scroll', () => {
            const footer = document.querySelector('footer');
            const currentScrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const windowHeight = window.innerHeight;
            const documentHeight = document.documentElement.scrollHeight;
            // Check if user has reached the bottom of the page
            const atPageEnd = (currentScrollTop + windowHeight) >= documentHeight;
            if (atPageEnd && currentScrollTop > lastScrollTop) {
                // Immediately hide footer when at the end of the page and scrolling down
                footer.classList.add('hide');
            } else {
                // Show footer when scrolling down anywhere else or when scrolling up
                footer.classList.remove('hide');
            }
            lastScrollTop = currentScrollTop;
        });
        
        // Carousel functionality
        let currentIndex = 0;
        let startX = 0;
        let moveX = 0;
        let isDragging = false;
        
        function updateCarousel() {
            const carousel = document.getElementById("carousel");
            carousel.style.transform = `translateX(-${currentIndex * 100}%)`;
            document.querySelectorAll(".dot").forEach((dot, index) => {
                dot.classList.toggle("active", index === currentIndex);
            });
        }
        
        function goToSlide(index) {
            currentIndex = index;
            updateCarousel();
        }
        
        function nextSlide() {
            const carouselData = data.slice(0, 5);
            currentIndex = (currentIndex + 1) % carouselData.length;
            updateCarousel();
        }
        
        function prevSlide() {
            const carouselData = data.slice(0, 5);
            currentIndex = (currentIndex - 1 + carouselData.length) % carouselData.length;
            updateCarousel();
        }
        
        function handleTouchStart(e) {
            startX = e.touches[0].clientX;
            isDragging = true;
        }
        
        function handleTouchMove(e) {
            if (!isDragging) return;
            moveX = e.touches[0].clientX - startX;
        }
        
        function handleTouchEnd() {
            isDragging = false;
            if (moveX > 50) {
                prevSlide();
            } else if (moveX < -50) {
                nextSlide();
            }
        }
        
        function handleMouseDown(e) {
            startX = e.clientX;
            isDragging = true;
        }
        
        function handleMouseMove(e) {
            if (!isDragging) return;
            moveX = e.clientX - startX;
        }
        
        function handleMouseUp() {
            isDragging = false;
            if (moveX > 50) {
                prevSlide();
            } else if (moveX < -50) {
                nextSlide();
            }
        }
        
        // Initialize carousel event listeners
        function initCarousel() {
            const carousel = document.getElementById("carousel");
            carousel.addEventListener("touchstart", handleTouchStart);
            carousel.addEventListener("touchmove", handleTouchMove);
            carousel.addEventListener("touchend", handleTouchEnd);
            carousel.addEventListener("mousedown", handleMouseDown);
            carousel.addEventListener("mousemove", handleMouseMove);
            carousel.addEventListener("mouseup", handleMouseUp);
            carousel.addEventListener("mouseleave", handleMouseUp);
            
            // Auto-slide every 5 seconds
            setInterval(nextSlide, 5000);
        }
        
        // Function to close the modal - optimized for immediate closing
        const closeModal = () => {
            // Stop the video immediately
            const videoPlayer = document.getElementById('video-player');
            const currentSrc = videoPlayer.src;
            
            // Clear the src to stop playback
            videoPlayer.src = 'about:blank'; // Use about:blank to unload
            
            // For YouTube videos, we need additional handling
            if (currentSrc && currentSrc.includes('youtube.com/embed/')) {
                // Create a temporary iframe to properly unload YouTube content
                const tempIframe = document.createElement('iframe');
                tempIframe.style.display = 'none';
                document.body.appendChild(tempIframe);
                tempIframe.src = 'about:blank';
                setTimeout(() => {
                    document.body.removeChild(tempIframe);
                }, 100);
            }
            
            // Hide the modal immediately
            document.getElementById('video-nav').style.display = 'none';
            
            // Hide the ad container
            document.getElementById('video-ad-container').style.display = 'none';
            
            // Reset state immediately
            currentMovieInModal = null;
            inVideoModal = false;
            isEpisodeNavigation = false; // Reset the flag
            
            // Clear any episode/season data
            const episodeFooter = document.getElementById('episode-footer');
            episodeFooter.style.display = 'none';
            
            // Remove the iframe from the DOM to completely stop the video
            const navBody = document.querySelector('.nav-body');
            const iframeContainer = navBody.querySelector('div[style*="position: relative"]');
            if (iframeContainer) {
                const oldIframe = iframeContainer.querySelector('iframe');
                if (oldIframe) {
                    oldIframe.remove();
                }
            }
        };
        // Modified closeNav function for immediate closing
        const closeNav = () => {
            if (inVideoModal) {
                // Close modal immediately without any delay
                closeModal();
                
                // Only use history.back() if we actually pushed a state
                if (window.history.state && window.history.state.videoOpen) {
                    // Use a small timeout to ensure the modal is fully closed before navigating back
                    setTimeout(() => {
                        window.history.back();
                    }, 10);
                }
            } else {
                closeModal();
            }
        };
        
        // Function to toggle series fields based on video type
        const toggleSeriesFields = () => {
            const videoType = document.getElementById('video-type').value;
            const seriesFields = document.getElementById('series-fields');
            
            if (videoType === 'series' || videoType === 'anime') {
                seriesFields.style.display = 'block';
                
                // Add at least one season if none exist
                if (seasons.length === 0) {
                    addSeason();
                }
            } else {
                seriesFields.style.display = 'none';
            }
        };
        
        // Function to add a new season
        const addSeason = () => {
            seasonCounter++;
            const seasonId = `season-${seasonCounter}`;
            
            const seasonData = {
                id: seasonId,
                seasonNumber: seasonCounter,
                episodes: []
            };
            
            seasons.push(seasonData);
            
            const seasonElement = document.createElement('div');
            seasonElement.className = 'seasons-container';
            seasonElement.id = seasonId;
            seasonElement.innerHTML = `
                <div class="season-header">
                    <div class="season-title">Season ${seasonCounter}</div>
                    <div class="season-actions">
                        <button type="button" class="season-btn" onclick="addEpisode('${seasonId}')">Add Episode</button>
                        <button type="button" class="season-btn remove" onclick="removeSeason('${seasonId}')">Remove</button>
                    </div>
                </div>
                <div class="episodes-container" id="${seasonId}-episodes">
                    <!-- Episodes will be added here dynamically -->
                </div>
            `;
            
            document.getElementById('seasons-list').appendChild(seasonElement);
            
            // Add at least one episode to the new season
            addEpisode(seasonId);
            
            // Save form data after adding season
            saveUploadFormData();
        };
        
        // Function to remove a season
        const removeSeason = (seasonId) => {
            // Remove from data array
            seasons = seasons.filter(season => season.id !== seasonId);
            
            // Remove from DOM
            document.getElementById(seasonId).remove();
            
            // If no seasons left, reset counter
            if (seasons.length === 0) {
                seasonCounter = 0;
            }
            
            // Save form data after removing season
            saveUploadFormData();
        };
        
        // Function to add a new episode to a season
        const addEpisode = (seasonId) => {
            const season = seasons.find(s => s.id === seasonId);
            if (!season) return;
            
            const episodeNumber = season.episodes.length + 1;
            const episodeId = `${seasonId}-episode-${episodeNumber}`;
            
            const episodeData = {
                id: episodeId,
                number: episodeNumber,
                title: `Episode ${episodeNumber}`,
                url: '',
                downloadUrl: ''
            };
            
            season.episodes.push(episodeData);
            
            const episodeElement = document.createElement('div');
            episodeElement.className = 'episode-item';
            episodeElement.id = episodeId;
            episodeElement.innerHTML = `
                <div class="episode-info">
                    <div class="episode-number">Episode ${episodeNumber}</div>
                    <div class="episode-title">
                        <input type="text" placeholder="Episode title" value="${episodeData.title}" onchange="updateEpisodeTitle('${episodeId}', this.value)">
                    </div>
                </div>
                <div class="episode-actions">
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        <input type="url" class="episode-input episode-url-input" placeholder="Enter any video URL" value="${episodeData.url}" onchange="updateEpisodeUrl('${episodeId}', this.value)">
                        <input type="url" class="episode-input episode-download-url-input" placeholder="Download URL (optional)" value="${episodeData.downloadUrl || ''}" onchange="updateEpisodeDownloadUrl('${episodeId}', this.value)">
                    </div>
                    <button type="button" class="episode-btn remove" onclick="removeEpisode('${seasonId}', '${episodeId}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            document.getElementById(`${seasonId}-episodes`).appendChild(episodeElement);
            
            // Save form data after adding episode
            saveUploadFormData();
        };
        
        // Function to remove an episode
        const removeEpisode = (seasonId, episodeId) => {
            const season = seasons.find(s => s.id === seasonId);
            if (!season) return;
            
            // Remove from data array
            season.episodes = season.episodes.filter(episode => episode.id !== episodeId);
            
            // Remove from DOM
            document.getElementById(episodeId).remove();
            
            // Renumber remaining episodes
            season.episodes.forEach((episode, index) => {
                episode.number = index + 1;
                episode.title = episode.title.replace(/Episode \d+/, `Episode ${index + 1}`);
                
                // Update DOM
                const episodeElement = document.getElementById(episode.id);
                if (episodeElement) {
                    episodeElement.querySelector('.episode-number').textContent = `Episode ${index + 1}`;
                    episodeElement.querySelector('.episode-title input').value = episode.title;
                }
            });
            
            // Save form data after removing episode
            saveUploadFormData();
        };
        
        // Function to update episode title
        const updateEpisodeTitle = (episodeId, title) => {
            for (const season of seasons) {
                const episode = season.episodes.find(e => e.id === episodeId);
                if (episode) {
                    episode.title = title;
                    break;
                }
            }
            
            // Save form data after updating episode title
            saveUploadFormData();
        };
        
        // Function to update episode URL
        const updateEpisodeUrl = (episodeId, url) => {
            for (const season of seasons) {
                const episode = season.episodes.find(e => e.id === episodeId);
                if (episode) {
                    episode.url = url;
                    break;
                }
            }
            
            // Save form data after updating episode URL
            saveUploadFormData();
        };
        
        // Function to update episode download URL
        const updateEpisodeDownloadUrl = (episodeId, downloadUrl) => {
            for (const season of seasons) {
                const episode = season.episodes.find(e => e.id === episodeId);
                if (episode) {
                    episode.downloadUrl = downloadUrl;
                    break;
                }
            }
            
            // Save form data after updating episode download URL
            saveUploadFormData();
        };
        
        // Handle form submission for video upload - Enhanced for series
        document.getElementById('upload-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Get form values
            const title = document.getElementById('video-title').value;
            const description = document.getElementById('video-description').value;
            const type = document.getElementById('video-type').value;
            const category = document.getElementById('video-category').value;
            const genre = document.getElementById('video-genre').value;
            const country = document.getElementById('video-country').value;
            const year = document.getElementById('video-year').value;
            const trending = document.getElementById('video-trending').checked;
            const videoUrl = document.getElementById('video-url').value;
            const downloadUrl = document.getElementById('video-download-url').value;
            const folderId = document.getElementById('video-folder').value;
            
            // Handle thumbnail upload
            const thumbnailFile = document.getElementById('video-thumbnail').files[0];
            let thumbnailUrl = document.getElementById('video-thumbnail-url').value;
            
            if (thumbnailFile) {
                thumbnailUrl = await uploadImage(thumbnailFile, 'thumbnails');
                if (!thumbnailUrl) {
                    showNotification('Failed to upload thumbnail. Please try again.', 'error');
                    return;
                }
            } else if (!thumbnailUrl) {
                // Generate a placeholder if no thumbnail is provided
                thumbnailUrl = `https://picsum.photos/seed/${Math.random().toString(36).substring(7)}/300/450.jpg`;
            }
            
            // Handle carousel thumbnail upload
            const carouselThumbnailFile = document.getElementById('video-carousel-thumbnail').files[0];
            let carouselThumbnailUrl = document.getElementById('video-carousel-thumbnail-url').value;
            
            if (carouselThumbnailFile) {
                carouselThumbnailUrl = await uploadImage(carouselThumbnailFile, 'carousel-thumbnails');
                if (!carouselThumbnailUrl) {
                    showNotification('Failed to upload carousel thumbnail. Please try again.', 'error');
                    return;
                }
            } else if (!carouselThumbnailUrl) {
                // Use regular thumbnail if carousel thumbnail is not provided
                carouselThumbnailUrl = thumbnailUrl;
            }
            
            try {
                showLoading();
                
                // Create video object
                const videoData = {
                    title,
                    description,
                    type,
                    category,
                    genre,
                    country,
                    year: parseInt(year),
                    trending,
                    videoUrl,
                    downloadUrl: downloadUrl || null,
                    imgUrl: thumbnailUrl,
                    carouselCover: carouselThumbnailUrl,
                    folderId: folderId || null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    uploadedBy: 'anonymous'
                };
                
                // If it's a series or anime, add seasons and episodes data
                if ((type === 'series' || type === 'anime') && seasons.length > 0) {
                    videoData.isSeries = true;
                    videoData.seasons = seasons.map(season => ({
                        seasonNumber: season.seasonNumber,
                        episodes: season.episodes.map(episode => ({
                            number: episode.number,
                            title: episode.title,
                            url: episode.url,
                            downloadUrl: episode.downloadUrl || ''
                        }))
                    }));
                    
                    // Validate that all episodes have URLs
                    let allEpisodesHaveUrls = true;
                    for (const season of videoData.seasons) {
                        for (const episode of season.episodes) {
                            if (!episode.url || !isValidVideoUrl(episode.url)) {
                                allEpisodesHaveUrls = false;
                                break;
                            }
                        }
                        if (!allEpisodesHaveUrls) break;
                    }
                    
                    if (!allEpisodesHaveUrls) {
                        showNotification('Please provide valid URLs for all episodes', 'warning');
                        hideLoading();
                        return;
                    }
                }
                
                // Check if we're editing an existing video
                const editingId = document.getElementById('upload-form').dataset.editingId;
                
                if (editingId) {
                    // Update existing video
                    await db.collection('videos').doc(editingId).update(videoData);
                    showNotification('Video updated successfully!', 'success');
                    
                    // Remove the editing flag
                    delete document.getElementById('upload-form').dataset.editingId;
                } else {
                    // Add new video
                    const docRef = await db.collection('videos').add(videoData);
                    showNotification('Video uploaded successfully!', 'success');
                    
                    // Add the new video to the local data array
                    const newVideo = {
                        id: docRef.id,
                        ...videoData
                    };
                    data.unshift(newVideo);
                }
                
                // Clear cache to force refresh
                clearAppCache();
                
                // Clear saved form data
                clearUploadFormData();
                
                // Clear form and previews
                document.getElementById('upload-form').reset();
                document.getElementById('video-thumbnail-preview').style.display = 'none';
                document.getElementById('video-carousel-thumbnail-preview').style.display = 'none';
                
                // Close modal
                closeUploadModal();
                
                // Refresh the UI
                createDiscoverSection();
                createCategories();
                
            } catch (error) {
                console.error('Error uploading/updating video:', error);
                showNotification('Error processing video. Please try again.', 'warning');
            } finally {
                hideLoading();
            }
        });
        
        // Video Management Functions
        // Function to open the video management modal
        const openVideoManagementModal = async () => {
            const videoManagementModal = document.getElementById('video-management-modal');
            const sidebarModal = document.getElementById('sidebar-modal');
            
            // Close sidebar modal first
            if (sidebarModal.classList.contains('open')) {
                sidebarModal.classList.remove('open');
                inSidebarModal = false;
            }
            
            // Open video management modal
            videoManagementModal.classList.add('open');
            inVideoManagementModal = true;
            
            // Reset current folder
            currentFolderId = null;
            currentFolderName = null;
            
            // Load folders and videos
            await loadManagementFolders();
            await loadManagementVideos();
            
            // Update header with total videos count
            await updateVideoManagementHeader();
            
            // Scroll to top of modal content
            setTimeout(() => {
                const videoManagementContent = document.querySelector('.video-management-content');
                if (videoManagementContent) {
                    videoManagementContent.scrollTop = 0;
                }
            }, 100);
        };
        
        // Function to update the video management header with total videos count
        const updateVideoManagementHeader = async () => {
            try {
                // Get total videos count
                const videosSnapshot = await db.collection('videos').get();
                const totalVideos = videosSnapshot.size;
                
                // Update the header with total count
                const headerTitle = document.getElementById('video-management-title');
                if (headerTitle) {
                    headerTitle.textContent = `Video Management (${totalVideos} videos)`;
                }
            } catch (error) {
                console.error('Error updating video management header:', error);
            }
        };
        
        // Function to close the video management modal
        const closeVideoManagementModal = () => {
            const videoManagementModal = document.getElementById('video-management-modal');
            videoManagementModal.classList.remove('open');
            inVideoManagementModal = false;
            
            // Reset current folder
            currentFolderId = null;
            currentFolderName = null;
        };
        
        // Function to load folders for management
        const loadManagementFolders = async () => {
            const folderList = document.getElementById('folder-list');
            folderList.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
            
            try {
                // Fetch folders from Firestore
                const folders = await fetchFoldersFromFirestore();
                
                // Clear loading indicator
                folderList.innerHTML = '';
                
                if (folders.length === 0) {
                    folderList.innerHTML = '<div class="no-videos">No folders found</div>';
                    return;
                }
                
                // Display folders
                folders.forEach(folder => {
                    const folderItem = createManagementFolderItem(folder);
                    folderList.appendChild(folderItem);
                });
            } catch (error) {
                console.error('Error loading folders for management:', error);
                folderList.innerHTML = '<div class="no-videos">Error loading folders</div>';
            }
        };
        
        // Function to create a folder item for the management list
        const createManagementFolderItem = (folder) => {
            const folderItem = document.createElement('div');
            folderItem.className = 'folder-item';
            if (currentFolderId === folder.id) {
                folderItem.classList.add('active');
            }
            
            const folderName = document.createElement('div');
            folderName.className = 'folder-name';
            folderName.textContent = folder.name;
            
            const folderDescription = document.createElement('div');
            folderDescription.className = 'folder-description';
            folderDescription.textContent = folder.description || 'No description';
            
            const folderMeta = document.createElement('div');
            folderMeta.className = 'folder-meta';
            
            // Format the creation date
            let createdDate = 'Unknown date';
            if (folder.createdAt) {
                const date = folder.createdAt.toDate ? folder.createdAt.toDate() : new Date(folder.createdAt);
                createdDate = date.toLocaleDateString();
            }
            
            folderMeta.innerHTML = `
                <span>Created: ${createdDate}</span>
                <div class="folder-actions-small">
                    <button class="folder-action-btn edit" onclick="editFolder('${folder.id}', '${folder.name}', '${folder.description || ''}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="folder-action-btn delete" onclick="confirmDeleteFolder('${folder.id}', '${folder.name}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            folderItem.appendChild(folderName);
            folderItem.appendChild(folderDescription);
            folderItem.appendChild(folderMeta);
            
            // Add click event to view videos in folder
            folderItem.onclick = (e) => {
                // Don't trigger if clicking on action buttons
                if (e.target.closest('.folder-actions-small')) return;
                
                showVideosInFolder(folder.id, folder.name);
            };
            
            return folderItem;
        };
        
        // Function to load videos for management
        const loadManagementVideos = async () => {
            const videoList = document.getElementById('video-management-list');
            videoList.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
            
            try {
                // Fetch videos from Firestore
                let query = db.collection('videos');
                
                // If a folder is selected, filter by folder
                if (currentFolderId) {
                    query = query.where('folderId', '==', currentFolderId);
                }
                
                const snapshot = await query.get();
                let videos = [];
                snapshot.forEach(doc => {
                    videos.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort videos by createdAt timestamp in descending order (newest first)
                videos.sort((a, b) => {
                    // Handle cases where createdAt might not exist
                    const aTime = a.createdAt ? (a.createdAt.toDate ? a.createdAt.toDate() : new Date(a.createdAt)) : new Date(0);
                    const bTime = b.createdAt ? (b.createdAt.toDate ? b.createdAt.toDate() : new Date(b.createdAt)) : new Date(0);
                    return bTime - aTime; // Sort in descending order (newest first)
                });
                
                // Clear loading indicator
                videoList.innerHTML = '';
                
                if (videos.length === 0) {
                    videoList.innerHTML = '<div class="no-videos">No videos found</div>';
                    return;
                }
                
                // Store videos for filtering
                window.managementVideos = videos;
                
                // Display videos
                videos.forEach(video => {
                    const videoItem = createManagementVideoItem(video);
                    videoList.appendChild(videoItem);
                });
            } catch (error) {
                console.error('Error loading videos for management:', error);
                videoList.innerHTML = '<div class="no-videos">Error loading videos</div>';
            }
        };
        
        // Function to create a video item for the management list
        const createManagementVideoItem = (video) => {
            const videoItem = document.createElement('div');
            videoItem.className = 'video-management-item';
            
            const thumbnail = document.createElement('img');
            thumbnail.src = video.imgUrl || 'https://picsum.photos/seed/video/80/120.jpg';
            thumbnail.alt = video.title;
            thumbnail.className = 'video-thumbnail';
            
            const videoInfo = document.createElement('div');
            videoInfo.className = 'video-info';
            
            const title = document.createElement('div');
            title.className = 'video-title';
            title.textContent = video.title;
            
            const meta = document.createElement('div');
            meta.className = 'video-meta';
            
            // Format the creation date
            let createdDate = 'Unknown date';
            if (video.createdAt) {
                const date = video.createdAt.toDate ? video.createdAt.toDate() : new Date(video.createdAt);
                createdDate = date.toLocaleDateString();
            }
            
            // Get folder name if available
            let folderName = 'No Folder';
            if (video.folderId) {
                // This would need to be fetched from the folders collection
                // For now, we'll just show the folder ID
                folderName = `Folder: ${video.folderId}`;
            }
            
            meta.textContent = `${video.type || 'Movie'} | ${video.category || 'Unknown'} | ${video.year || 'Unknown'} | ${folderName} | Added: ${createdDate}`;
            
            videoInfo.appendChild(title);
            videoInfo.appendChild(meta);
            
            const actions = document.createElement('div');
            actions.className = 'video-actions';
            
            const editBtn = document.createElement('button');
            editBtn.className = 'edit-btn';
            editBtn.textContent = 'Edit';
            editBtn.onclick = () => editVideo(video);
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.textContent = 'Delete';
            deleteBtn.onclick = () => deleteVideo(video.id, video.title);
            
            const folderBtn = document.createElement('button');
            folderBtn.className = 'edit-btn';
            folderBtn.textContent = 'Folder';
            folderBtn.style.marginTop = '5px';
            folderBtn.onclick = () => openVideoFolderModal(video.id, video.folderId);
            
            actions.appendChild(editBtn);
            actions.appendChild(deleteBtn);
            actions.appendChild(folderBtn);
            
            videoItem.appendChild(thumbnail);
            videoItem.appendChild(videoInfo);
            videoItem.appendChild(actions);
            
            return videoItem;
        };
        
        // Function to filter videos in the management list
        const filterManagementVideos = () => {
            const searchTerm = document.getElementById('video-management-search').value.toLowerCase();
            const videoList = document.getElementById('video-management-list');
            
            if (!window.managementVideos || window.managementVideos.length === 0) {
                return;
            }
            
            // Clear current list
            videoList.innerHTML = '';
            
            // Filter videos based on search term
            const filteredVideos = window.managementVideos.filter(video => {
                return video.title.toLowerCase().includes(searchTerm) ||
                       (video.category && video.category.toLowerCase().includes(searchTerm)) ||
                       (video.genre && video.genre.toLowerCase().includes(searchTerm));
            });
            
            if (filteredVideos.length === 0) {
                videoList.innerHTML = '<div class="no-videos">No videos match your search</div>';
                return;
            }
            
            // Display filtered videos
            filteredVideos.forEach(video => {
                const videoItem = createManagementVideoItem(video);
                videoList.appendChild(videoItem);
            });
        };
        
        // Function to edit a video
        const editVideo = (video) => {
            // Close video management modal
            closeVideoManagementModal();
            
            // Open upload modal
            openUploadModal();
            
            // Populate form with video data
            setTimeout(() => {
                document.getElementById('video-title').value = video.title || '';
                document.getElementById('video-description').value = video.description || '';
                document.getElementById('video-type').value = video.type || 'movie';
                document.getElementById('video-category').value = video.category || 'Hollywood';
                document.getElementById('video-genre').value = video.genre || 'Action';
                document.getElementById('video-country').value = video.country || 'United States';
                document.getElementById('video-year').value = video.year || '';
                document.getElementById('video-trending').checked = video.trending || false;
                document.getElementById('video-url').value = video.videoUrl || '';
                document.getElementById('video-download-url').value = video.downloadUrl || '';
                document.getElementById('video-folder').value = video.folderId || '';
                
                // Set thumbnail URL and preview
                document.getElementById('video-thumbnail-url').value = video.imgUrl || '';
                if (video.imgUrl) {
                    const preview = document.getElementById('video-thumbnail-preview');
                    preview.src = video.imgUrl;
                    preview.style.display = 'block';
                }
                
                // Set carousel thumbnail URL and preview
                document.getElementById('video-carousel-thumbnail-url').value = video.carouselCover || '';
                if (video.carouselCover) {
                    const preview = document.getElementById('video-carousel-thumbnail-preview');
                    preview.src = video.carouselCover;
                    preview.style.display = 'block';
                }
                
                // Set a flag to indicate we're editing an existing video
                document.getElementById('upload-form').dataset.editingId = video.id;
                
                // If it's a series, populate seasons and episodes
                if ((video.type === 'series' || video.type === 'anime') && video.seasons) {
                    toggleSeriesFields();
                    
                    // Clear existing seasons
                    seasons = [];
                    seasonCounter = 0;
                    document.getElementById('seasons-list').innerHTML = '';
                    
                    // Recreate seasons
                    video.seasons.forEach(seasonData => {
                        addSeason();
                        const currentSeason = seasons[seasons.length - 1];
                        
                        // Update season number
                        currentSeason.seasonNumber = seasonData.seasonNumber;
                        document.querySelector(`#${currentSeason.id} .season-title`).textContent = `Season ${seasonData.seasonNumber}`;
                        
                        // Clear default episode and add saved episodes
                        currentSeason.episodes = [];
                        const episodesContainer = document.getElementById(`${currentSeason.id}-episodes`);
                        episodesContainer.innerHTML = '';
                        
                        seasonData.episodes.forEach(episodeData => {
                            addEpisode(currentSeason.id);
                            const currentEpisode = currentSeason.episodes[currentSeason.episodes.length - 1];
                            
                            // Update episode data
                            currentEpisode.number = episodeData.number;
                            currentEpisode.title = episodeData.title;
                            currentEpisode.url = episodeData.url;
                            currentEpisode.downloadUrl = episodeData.downloadUrl || '';
                            
                            // Update DOM
                            const episodeElement = document.getElementById(currentEpisode.id);
                            episodeElement.querySelector('.episode-title input').value = episodeData.title;
                            episodeElement.querySelector('.episode-url-input').value = episodeData.url;
                            episodeElement.querySelector('.episode-download-url-input').value = episodeData.downloadUrl || '';
                        });
                    });
                }
            }, 100);
        };
        
        // Function to delete a video
        const deleteVideo = async (videoId, videoTitle) => {
            if (confirm(`Are you sure you want to delete "${videoTitle}"? This action cannot be undone.`)) {
                try {
                    showLoading();
                    
                    // Delete video from Firestore
                    await db.collection('videos').doc(videoId).delete();
                    
                    // Clear cache to force refresh
                    clearAppCache();
                    
                    // Show success message
                    showNotification(`"${videoTitle}" has been deleted successfully.`, 'success');
                    
                    // Reload videos in management modal
                    await loadManagementVideos();
                    
                    // Also refresh the main app data
                    await initializeApp();
                    
                    hideLoading();
                } catch (error) {
                    console.error('Error deleting video:', error);
                    showNotification('Error deleting video. Please try again.', 'error');
                    hideLoading();
                }
            }
        };
        
        // Folder Management Functions
        
        // Function to open the create folder modal
        const openCreateFolderModal = () => {
            const createFolderModal = document.getElementById('create-folder-modal');
            createFolderModal.classList.add('open');
            inCreateFolderModal = true;
            
            // Reset form
            document.getElementById('create-folder-form').reset();
            
            // Focus on folder name input
            setTimeout(() => {
                document.getElementById('folder-name').focus();
            }, 100);
        };
        
        // Function to close the create folder modal
        const closeCreateFolderModal = () => {
            const createFolderModal = document.getElementById('create-folder-modal');
            createFolderModal.classList.remove('open');
            inCreateFolderModal = false;
        };
        
        // Function to open the edit folder modal
        const openEditFolderModal = (folderId, folderName, folderDescription) => {
            const editFolderModal = document.getElementById('edit-folder-modal');
            editFolderModal.classList.add('open');
            inEditFolderModal = true;
            
            // Populate form with folder data
            document.getElementById('edit-folder-name').value = folderName;
            document.getElementById('edit-folder-description').value = folderDescription;
            
            // Store folder ID for submission
            document.getElementById('edit-folder-form').dataset.folderId = folderId;
            
            // Focus on folder name input
            setTimeout(() => {
                document.getElementById('edit-folder-name').focus();
            }, 100);
        };
        
        // Function to close the edit folder modal
        const closeEditFolderModal = () => {
            const editFolderModal = document.getElementById('edit-folder-modal');
            editFolderModal.classList.remove('open');
            inEditFolderModal = false;
        };
        
        // Function to create a new folder
        const createFolderSubmit = async (event) => {
            event.preventDefault();
            
            const folderName = document.getElementById('folder-name').value.trim();
            const folderDescription = document.getElementById('folder-description').value.trim();
            
            if (!folderName) {
                showNotification('Please enter a folder name', 'warning');
                return;
            }
            
            try {
                showLoading();
                
                // Create folder in Firestore
                const folderData = {
                    name: folderName,
                    description: folderDescription,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const docRef = await db.collection('folders').add(folderData);
                
                // Clear cache to force refresh
                clearAppCache();
                
                // Show success message
                showNotification('Folder created successfully!', 'success');
                
                // Close modal
                closeCreateFolderModal();
                
                // Reload folders
                await loadManagementFolders();
                
                hideLoading();
            } catch (error) {
                console.error('Error creating folder:', error);
                showNotification('Error creating folder. Please try again.', 'error');
                hideLoading();
            }
        };
        
        // Function to edit a folder
        const editFolderSubmit = async (event) => {
            event.preventDefault();
            
            const folderId = document.getElementById('edit-folder-form').dataset.folderId;
            const folderName = document.getElementById('edit-folder-name').value.trim();
            const folderDescription = document.getElementById('edit-folder-description').value.trim();
            
            if (!folderName) {
                showNotification('Please enter a folder name', 'warning');
                return;
            }
            
            try {
                showLoading();
                
                // Update folder in Firestore
                await db.collection('folders').doc(folderId).update({
                    name: folderName,
                    description: folderDescription
                });
                
                // Clear cache to force refresh
                clearAppCache();
                
                // Show success message
                showNotification('Folder updated successfully!', 'success');
                
                // Close modal
                closeEditFolderModal();
                
                // Reload folders
                await loadManagementFolders();
                
                hideLoading();
            } catch (error) {
                console.error('Error updating folder:', error);
                showNotification('Error updating folder. Please try again.', 'error');
                hideLoading();
            }
        };
        
        // Function to edit a folder (wrapper for opening modal)
        const editFolder = (folderId, folderName, folderDescription) => {
            openEditFolderModal(folderId, folderName, folderDescription);
        };
        
        // Function to confirm delete folder
        const confirmDeleteFolder = (folderId, folderName) => {
            if (confirm(`Are you sure you want to delete "${folderName}"? All videos in this folder will also be deleted. This action cannot be undone.`)) {
                deleteFolder(folderId);
            }
        };
        
        // Function to delete a folder
        const deleteFolder = async (folderId) => {
            try {
                showLoading();
                
                // First, get all videos in this folder
                const videosSnapshot = await db.collection('videos').where('folderId', '==', folderId).get();
                
                // Batch delete
                const batch = db.batch();
                
                // Delete the folder
                batch.delete(db.collection('folders').doc(folderId));
                
                // Delete all videos in the folder
                videosSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                await batch.commit();
                
                // Clear cache to force refresh
                clearAppCache();
                
                // Show success message
                showNotification('Folder and its videos deleted successfully!', 'success');
                
                // Reload folders and videos
                await loadManagementFolders();
                await loadManagementVideos();
                
                // If we were viewing the deleted folder, go back to all videos
                if (currentFolderId === folderId) {
                    showAllVideosInManagement();
                }
                
                hideLoading();
            } catch (error) {
                console.error('Error deleting folder:', error);
                showNotification('Error deleting folder. Please try again.', 'error');
                hideLoading();
            }
        };
        
        // Function to show videos in a specific folder
        const showVideosInFolder = async (folderId, folderName) => {
            // Set current folder
            currentFolderId = folderId;
            currentFolderName = folderName;
            
            // Update breadcrumb
            const breadcrumb = document.getElementById('folder-breadcrumb');
            breadcrumb.innerHTML = `
                <div class="breadcrumb-item" onclick="showAllVideosInManagement()">All Videos</div>
                <span class="breadcrumb-separator">></span>
                <div class="breadcrumb-current">${folderName}</div>
            `;
            
            // Update folder list to show active state
            document.querySelectorAll('.folder-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.folder-item[onclick*="${folderId}"]`)?.classList.add('active');
            
            // Load videos for this folder
            await loadManagementVideos();
        };
        
        // Function to show all videos in management
        const showAllVideosInManagement = async () => {
            // Reset current folder
            currentFolderId = null;
            currentFolderName = null;
            
            // Update breadcrumb
            const breadcrumb = document.getElementById('folder-breadcrumb');
            breadcrumb.innerHTML = `
                <div class="breadcrumb-current">All Videos</div>
            `;
            
            // Update folder list to remove active state
            document.querySelectorAll('.folder-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Load all videos
            await loadManagementVideos();
        };
        
        // Function to open the video folder modal
        const openVideoFolderModal = (videoId, currentFolderId) => {
            const videoFolderModal = document.getElementById('video-folder-modal');
            videoFolderModal.classList.add('open');
            inVideoFolderModal = true;
            
            // Store video ID for submission
            document.getElementById('video-folder-form').dataset.videoId = videoId;
            
            // Set current selection
            document.getElementById('video-folder-select').value = currentFolderId || '';
            
            // Focus on select
            setTimeout(() => {
                document.getElementById('video-folder-select').focus();
            }, 100);
        };
        
        // Function to close the video folder modal
        const closeVideoFolderModal = () => {
            const videoFolderModal = document.getElementById('video-folder-modal');
            videoFolderModal.classList.remove('open');
            inVideoFolderModal = false;
        };
        
        // Function to change video folder
        const changeVideoFolderSubmit = async (event) => {
            event.preventDefault();
            
            const videoId = document.getElementById('video-folder-form').dataset.videoId;
            const folderId = document.getElementById('video-folder-select').value;
            
            try {
                showLoading();
                
                // Update video in Firestore
                await db.collection('videos').doc(videoId).update({
                    folderId: folderId || null
                });
                
                // Clear cache to force refresh
                clearAppCache();
                
                // Show success message
                showNotification('Video folder updated successfully!', 'success');
                
                // Close modal
                closeVideoFolderModal();
                
                // Reload videos
                await loadManagementVideos();
                
                hideLoading();
            } catch (error) {
                console.error('Error updating video folder:', error);
                showNotification('Error updating video folder. Please try again.', 'error');
                hideLoading();
            }
        };
        
        // Function to load folders for upload form
        const loadFoldersForUpload = async () => {
            const folderSelect = document.getElementById('video-folder');
            
            // Clear existing options except the first one
            while (folderSelect.children.length > 1) {
                folderSelect.removeChild(folderSelect.lastChild);
            }
            
            try {
                // Fetch folders from Firestore
                const folders = await fetchFoldersFromFirestore();
                
                // Add folders to select
                folders.forEach(folder => {
                    const option = document.createElement('option');
                    option.value = folder.id;
                    option.textContent = folder.name;
                    folderSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading folders for upload:', error);
            }
        };
        
        // Function to load folders for video folder modal
        const loadFoldersForVideoFolderModal = async () => {
            const folderSelect = document.getElementById('video-folder-select');
            
            // Clear existing options except the first one
            while (folderSelect.children.length > 1) {
                folderSelect.removeChild(folderSelect.lastChild);
            }
            
            try {
                // Fetch folders from Firestore
                const folders = await fetchFoldersFromFirestore();
                
                // Add folders to select
                folders.forEach(folder => {
                    const option = document.createElement('option');
                    option.value = folder.id;
                    option.textContent = folder.name;
                    folderSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading folders for video folder modal:', error);
            }
        };
        
        // Initialize folder loading for video folder modal when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            // Load folders for video folder modal
            loadFoldersForVideoFolderModal();
        });
        
        // Function to update ad display
        function updateAdDisplay() {
            if (!adsData || adsData.length === 0) return;
            
            // If we're not in the video modal, update the main ad display
            if (!inVideoModal) {
                showAd(currentAdIndex);
            }
        }
        
        // Handle ad upload form submission
        document.getElementById('ad-upload-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Get form values
            const title = document.getElementById('ad-title').value;
            const description = document.getElementById('ad-description').value;
            const image = document.getElementById('ad-image').value;
            const link = document.getElementById('ad-link').value;
            const category = document.getElementById('ad-category').value;
            
            try {
                showLoading();
                
                // Create ad object
                const adData = {
                    title,
                    description,
                    image,
                    link,
                    category,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    uploadedBy: 'anonymous'
                };
                
                // Add new ad
                const docRef = await db.collection('ads').add(adData);
                showNotification('Ad uploaded successfully!', 'success');
                
                // Add the new ad to the local data array
                const newAd = {
                    id: docRef.id,
                    ...adData
                };
                adsData.unshift(newAd);
                
                // Clear cache to force refresh
                clearAppCache();
                
                // Clear form
                document.getElementById('ad-upload-form').reset();
                
                // Close modal
                closeAdUploadModal();
                
                // Refresh the UI
                updateAdDisplay();
                
            } catch (error) {
                console.error('Error uploading ad:', error);
                showNotification('Error processing ad. Please try again.', 'warning');
            } finally {
                hideLoading();
            }
        });
        
        // Handle app upload form submission
        document.getElementById('app-upload-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Get form values
            const name = document.getElementById('app-name').value;
            const description = document.getElementById('app-description').value;
            const icon = document.getElementById('app-icon').value;
            const link = document.getElementById('app-link').value;
            const category = document.getElementById('app-category').value;
            const rating = parseFloat(document.getElementById('app-rating').value);
            
            try {
                showLoading();
                
                // Create app object
                const appData = {
                    name,
                    description,
                    icon,
                    link,
                    category,
                    rating,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    uploadedBy: 'anonymous'
                };
                
                // Add new app
                const docRef = await db.collection('apps').add(appData);
                showNotification('App uploaded successfully!', 'success');
                
                // Add the new app to the local data array
                const newApp = {
                    id: docRef.id,
                    ...appData
                };
                profileApps.unshift(newApp);
                
                // Clear cache to force refresh
                clearAppCache();
                
                // Clear form
                document.getElementById('app-upload-form').reset();
                
                // Close modal
                closeAppUploadModal();
                
            } catch (error) {
                console.error('Error uploading app:', error);
                showNotification('Error processing app. Please try again.', 'warning');
            } finally {
                hideLoading();
            }
        });
    </script>
</body>
</html>
