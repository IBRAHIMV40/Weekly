<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Nest</title>
    <!-- Add Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <style>
        /* CSS remains the same as before */
        :root {
            --bg-color: #141414;
            --text-color: #ffffff;
            --card-bg: #2c2c2c;
            --border-color: #444;
            --primary-color: #00b300;
            --light-bg: #2c2c2c;
            --gradient-3: linear-gradient(to right, #004d00, #00b300);
            --text-muted: #aaaaaa;
            --gradient-1: linear-gradient(to right, #004d00, #00b300);
        }
        
        /* Hide all scrollbars globally */
        * {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none;  /* IE and Edge */
        }
        *::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Edge */
        }
        
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow-x: hidden;
        }
        header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 48px;
            background: linear-gradient(to right, #141414, #141414);
            display: flex;
            border: 1px solid #333;
            border-radius: 0px;
            flex-direction: column;
            align-items: center;
            padding: 0px 0px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        /* Logo Image */
        .logo img {
            height: 45px;
            border-radius: 8px;
            margin-left: 6px;
            border: 1px solid #;
        }
        .search-container {
            display: flex;
            align-items: center;
            background-color: #333;
            border: 2px solid #444;
            border-radius: 18px;
            padding: 5px 5px;
            margin-right: 7px;
            width: fit-content;
        }
        .search-container i {
            color: #fff;
            margin-right: 8px;
            font-size: 16px;
        }
        #search-bar {
            border: none;
            outline: none;
            background: transparent;
            font-size: 14px;
            color: #fff;
            width: 160px;
        }
        .icons {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .history-icon {
            font-size: 21px;
            margin-right: 10px;
            cursor: pointer;
            color: #777777;
            position: relative;
        }
        .history-icon:hover {
            color: #00b300;
        }
        /* Notification Badge */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ff0000;
            color: white;
            font-size: 10px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        /* History Modal */
        .history-modal {
            display: none;
            position: fixed;
            top: 80px;
            right: 10px;
            width: 320px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            padding: 10px;
        }
        .history-modal.open {
            display: block;
        }
        .history-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .history-modal-header h3 {
            font-size: 16px;
            margin: 0;
            color: #333;
        }
        .history-modal-header button {
            background: none;
            border: none;
            color: #333;
            font-size: 16px;
            cursor: pointer;
        }
        .history-modal-header button:hover {
            color: #007bff;
        }
        .history-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .history-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .history-item:last-child {
            border-bottom: none;
        }
        .history-item img {
            width: 80px;
            height: 115px;
            object-fit: cover;
            border-radius: 5px;
        }
        .history-item .content {
            flex: 1;
        }
        .history-item h4 {
            font-size: 14px;
            margin: 0;
            color: #333;
        }
        .history-item p {
            font-size: 0px;
            margin: 0;
            color: #777;
        }
        .clear-history-button {
            width: 100%;
            background: linear-gradient(to right, #004d00, #00b300);
            color: #fff;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
        }
        .clear-history-button:hover {
            background-color: #00b300;
        }
        
        /* Carousel Styles - Updated to match screenshot */
        .carousel-container {
            width: 100%;
            max-width: 600px;
            overflow: hidden;
            position: relative;
            border-radius: 10px;
            touch-action: pan-y;
            height: 320px; /* Fixed height */
            margin: 0 auto 15px; /* Centered with margin */
            z-index: 10;
        }
        .carousel {
            display: flex;
            transition: transform 0.4s ease-in-out;
            will-change: transform;
            height: 100%;
        }
        .slide {
            min-width: 100%;
            position: relative;
            user-select: none;
            height: 100%;
            cursor: pointer;
        }
        .slide img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
        }
        .overlay {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 40%;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.9), transparent);
            border-radius: 10px;
        }
        .video-title {
            position: absolute;
            bottom: 75px;
            left: 15px;
            font-size: 22px;
            font-weight: bold;
            color: white;
        }
        .video-info {
            position: absolute;
            bottom: 50px;
            left: 15px;
            font-size: 14px;
            color: #ccc;
        }
        .download-btn {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background-color: #00b300;
            color: white;
            font-size: 12px;
            padding: 8px 12px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .download-btn img {
            width: 20px;
            height: 20px;
        }
        .dots {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 5px;
        }
        .dot {
            width: 11px;
            height: 11px;
            background-color: gray;
            border-radius: 50%;
            cursor: pointer;
            transition: 0.3s;
        }
        .dot.active {
            background-color: white;
        }
        
        /* Categories Section - New section based on screenshot */
        .categories-section {
            margin-top: 15px;
            padding: 0 15px;
        }
        .categories-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        .categories-scroll {
            display: flex;
            overflow-x: auto;
            gap: 8px;
            padding-bottom: 10px;
        }
        .category-btn {
            flex: 0 0 auto;
            padding: 8px 16px;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            color: var(--text-color);
            font-size: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .category-btn.active {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        .category-btn:hover {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        /* Discover Section */
        .discover-container {
            margin-top: 38px;
            padding: 8px;
        }
        .discover-scroll {
            display: flex;
            overflow-x: auto;
            gap: 8px;
            padding-bottom: 10px;
        }
        .discover-item {
            flex: 0 0 auto;
            width: 130px;
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            text-align: center;
            position: relative;
            cursor: pointer;
        }
        .discover-item img {
            width: 100%;
            aspect-ratio: 16 / 23;
            object-fit: cover;
            border-radius: 5px;
        }
        .discover-item .content {
            padding: 0px;
        }
        .discover-item .content h2 {
            font-weight: 400;
            font-size: 0.60rem;
            margin: 0;
            color: var(--text-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }
        .discover-item .content p {
            font-size: 0px;
            color: var(--text-muted);
            margin: 0px 0;
        }
        /* Category Section */
        .category-container {
            margin-top: 8px;
            padding: 2px;
        }
        .category-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            margin-left: 7px;
            color: var(--text-color);
            justify-content: space-between;
            align-items: center;
        }
        .category-title button {
            background-color: var(--light-bg);
            border: none;
            padding: 5px 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-color);
            cursor: pointer;
            font-size: 13px;
        }
        .category-title button:hover {
            background-color: var(--light-bg);
        }
        .category-scroll {
            display: flex;
            overflow-x: auto;
            gap: 4px;
            padding-bottom: 10px;
        }
        
        .frame {
            flex: 0 0 auto;
            width: 112px;
            background-color: var(--card-bg);
            border-radius: 8px;
            margin-left: 4px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            text-align: center;
            cursor: pointer;
        }
        .frame img {
            width: 100%;
            aspect-ratio: 16 / 24;
            object-fit: cover;
            border-radius: 5px;
        }
        .frame .content h2 {
            font-weight: 400;
            font-size: 0.60rem;
            color: var(--text-color);
            text-align: center;
            margin-top: 0px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }
        /* Grid Layout for View All and Search Results */
        .grid-container {
            margin-top: 35px;
            padding: 10px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            max-height: calc(100vh - 120px);
            overflow-y: auto;
        }
        .grid-container .frame {
            width: 100%;
        }
        
        /* Filter Section for Grid View */
        .filter-section {
            background-color: #;
            padding: 0px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            grid-column: 1 / -1; /* Span all columns */
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filter-dropdown {
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 8px 8px;
            font-size: 8px;
            cursor: pointer;
            outline: none;
        }
        
        .filter-dropdown:focus {
            border-color: var(--primary-color);
        }
        
        .filter-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 15px;
            font-size: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .filter-button:hover {
            background-color: #009900;
        }
        
        /* Navigation Modal Styles */
        .nav-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height:  90%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .nav-content {
            background-color: #141414;
            width: 100%;
            height: 100%;
            max-width: 800px;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .nav-header {
            background-color: #141414;
            color: #fff;
            padding: 10px;
            text-align: right;
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .nav-header button {
            background: none;
            border: none;
            color: #fff;
            font-size: 16px;
            border: 1px solid #333;
            border-radius: 50px;
            cursor: pointer;
            padding: 0 10px;
            margin: 0 5px;
        }
        .nav-header button:hover {
            color: #fff;
        }
        .save-btn {
            background-color: #00b300;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 14px;
        }
        .save-btn:hover {
            background-color: #ff0000;
        }
        .nav-body {
            flex-grow: 1;
            overflow: hidden;
            position: relative;
        }
        .nav-body iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        /* Episode Footer Styles */
        .episode-footer {
            background: #141414;    
            padding: 20px 0 10px;
            border-top: 1px solid var(--border-color);
            z-index: 310;
        }
        .episode-header {
            display: flex;
            padding: 0 20px 15px;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        .episode-title {
            font-size: 18px;
            font-weight: 700;
            max-width: 70%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: white;
        }
        .episode-count {
            font-size: 16px;
            color: var(--primary-color);
            font-weight: 600;
        }
        .episode-scroller {
            display: flex;
            overflow-x: auto;
            padding: 15px 20px;
            gap: 15px;
        }
        .episode-btn {
            flex: 0 0 auto;
            width: 65px;
            height: 65px;
            border-radius: 15px;
            background: #222;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 20px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        .episode-btn:hover {
            background: var(--light-bg);
            transform: translateY(-3px);
        }
        .episode-btn.active {
            background: var(--gradient-3);
            border-color: white;
            transform: scale(1.1);
            color: white;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
        }
        .episode-btn .ep-num {
            font-size: 12px;
            position: absolute;
            top: 5px;
            left: 5px;
            color: var(--text-muted);
        }
        .episode-btn.active .ep-num {
            color: white;
            font-weight: 700;
        }
        
        /* Season Navigation Buttons */
        .season-nav-btn {
            background: var(--gradient-1) !important;
            color: white !important;
            border: 2px solid white !important;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            width: 65px;
            height: 65px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
        }
        
        .season-nav-btn .season-nav-text {
            position: absolute;
            top: 2px;
            left: 8px;
            font-size: 12px;
            font-weight: 700;
            color: white;
        }
        
        .season-nav-btn .season-number {
            font-size: 20px;
            font-weight: 700;
        }
        
        .season-nav-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(255, 77, 77, 0.5);
        }
        
        .season-nav-btn.prev-season {
            margin-right: 5px;
        }
        
        .season-nav-btn.next-season {
            margin-left: 5px;
        }
        
        /* Notification Styles */
        .notification {
            padding: 20px 25px;
            font-size: 13px;
            font-weight: bold;
            color: #333;
            border-radius: 8px;
            border: 1px solid #ccc;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            animation: fadeInOut 3s ease-in-out;
        }
        .notification.success {
            background-color: #fff;
        }
        .notification.warning {
            background-color: #fff;
        }
        .notification.info {
            background-color: #2196f3;
        }
        @keyframes fadeInOut {
            0% {
                opacity: 0;
                transform: translate(-50%, -60%);
            }
            10% {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
            90% {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -40%);
            }
        }
        #social-media {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 25px 0;
        }
        /* Social Media Descriptions */
        #social-media-descriptions {
            text-align: center;
            margin-bottom: 5px;
        }
        #social-media-descriptions h2 {
            font-size: 15px;
            color: #ccc;
            margin: 5;
        }
        /* Social Media Icons */
        #social-media {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }
        .social-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(to right, #004d00, #00b300);
            color: white;
            font-size: 18px;
            cursor: pointer;
            text-decoration: none;
            transition: background-color 0.3s ease;
        }
        .social-icon:hover {
            background-color: #555;
        }
        .notification-bar {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            background: linear-gradient(to right, #004d00, #00b300);
            color: white;
            padding: 10px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            z-index: 1000;
        }
        .notification-bar img {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            margin-right: 10px;
        }
        .notification-text {
            flex: 1;
            font-size: 11px;
            text-align: left;
        }
        .notification-button {
            background: #ccff00;
            color: #000;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            border: none;
        }
        .close-button {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            margin-left: 10px;
        }
        /* Sidebar Modal */
        .sidebar-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 300px;
            height: 100%;
            background-color: #fff;
            border-right: 1px solid #ccc;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            overflow-y: auto;
            padding: 10px;
        }
        .sidebar-modal.open {
            display: block;
        }
        .sidebar-modal-header {
            display: flex;
            background: linear-gradient(to right, #004d00, #00b300);
            justify-content: space-between;
            align-items: center;
            padding: 6px;
            border-radius: 20px;
            border-bottom: 1px solid #ccc;
            margin-bottom: 10px;
        }
        .sidebar-modal-header h3 {
            font-size: 18px;
            margin: 0;
            color: #333;
        }
        .sidebar-modal-header button {
            background: #fff;
            border: none;
            color: #333;
            border-bottom: 1px solid #ccc;
            font-size: 16px;
            border-radius: 50px;
            cursor: pointer;
        }
        .sidebar-modal-header button:hover {
            color: #007bff;
        }
        .sidebar-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .sidebar-item img {
            width: 30px;
            height: 30px;
            object-fit: cover;
            border-radius: 5px;
        }
        .sidebar-item span {
            font-size: 14px;
            color: #333;
        }
        /* Bars Icon */
        .bars-icon {
            font-size: 22px;
            cursor: pointer;
            color: #777777;
            margin-left: 15px;
        }
        .bars-icon:hover {
            color: #00b300;
        }
        
        /* Bottom Navigation Bar */
        footer {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px 0;
            border-radius: 0px;
            background-color: #141414;
            border-bottom: 1px solid #;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 100;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        footer .nav-icon {
            flex: 1;
            text-align: center;
            color: #777777;
            transition: all 0.3s ease-in-out;
            cursor: pointer;
            font-size: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        footer .nav-icon i {
            font-size: 21px;
            transition: 0.3s;
        }
        footer .nav-icon.active,
        footer .nav-icon:hover {
            color: #00b300;
        }
        footer .nav-icon.active i,
        footer .nav-icon:hover i {
            transform: scale(1.2);
        }
        /* Hide Footer */
        footer.hide {
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
        }
        
        /* New styles for added features */
        .filter-container {
            display: none;
            position: fixed;
            top: 60px;
            right: 10px;
            width: 280px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            padding: 15px;
        }
        .filter-container.open {
            display: block;
        }
        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .filter-header h3 {
            font-size: 16px;
            margin: 0;
            color: #333;
        }
        .filter-header button {
            background: none;
            border: none;
            color: #333;
            font-size: 16px;
            cursor: pointer;
        }
        .filter-section {
            margin-bottom: 15px;
        }
        .filter-section h4 {
            font-size: 14px;
            margin-bottom: 8px;
            color: #333;
        }
        .filter-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .filter-option {
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 15px;
            padding: 5px 10px;
            color: black;
            font-size: 12px;
            cursor: pointer;
        }
        .filter-option.active {
            background-color: #00b300;
            color: white;
        }
        .apply-filter-btn {
            width: 100%;
            background: linear-gradient(to right, #004d00, #00b300);
            color: #fff;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        /* Video quality selector */
        .quality-selector {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            z-index: 100;
        }
        
        /* User profile section */
        .user-profile {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #00b300;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
        }
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .user-info h3 {
            margin: 0 0 5px;
            font-size: 16px;
            color: #333;
            text-align: center;
        }
        .user-info p {
            margin: 0 0 10px;
            font-size: 12px;
            color: #777;
            text-align: center;
        }
        .edit-profile-btn {
            background-color: #00b300;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .edit-profile-btn i {
            font-size: 12px;
        }
        
        /* Video player controls */
        .player-controls {
            position: absolute;
            bottom: 0px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
        }
        .player-controls button {
            background: none;
            border: none;
            color: #;
            font-size: 0px;
            cursor: pointer;
        }
        .player-timeline {
            flex: 1;
            height: 4px;
            background-color: rgba(255,255,255,0.3);
            margin: 0 15px;
            border-radius: 2px;
            position: relative;
        }
        .player-progress {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background-color: #00b300;
            width: 0%;
        }
        
        /* Edit Profile Modal */
        .edit-profile-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }
        .edit-profile-modal.open {
            display: flex;
        }
        .edit-profile-content {
            background-color: #fff;
            width: 90%;
            max-width: 400px;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .edit-profile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .edit-profile-header h3 {
            font-size: 18px;
            margin: 0;
            color: #333';
        }
        .edit-profile-header button {
            background: none;
            border: none;
            color: #333';
            font-size: 16px;
            cursor: pointer;
        }
        .avatar-selection {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        .avatar-option {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 0 5px;
            cursor: pointer;
            border: 2px solid transparent;
            overflow: hidden;
        }
        .avatar-option.selected {
            border-color: #00b300;
        }
        .avatar-option img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #333';
        }
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .save-profile-btn {
            width: 100%;
            background: linear-gradient(to right, #004d00, #00b300);
            color: #fff;
            border: none;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        /* Upload Modal Styles - Updated for scrolling */
        .upload-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            justify-content: center;
            align-items: center;
            overflow-y: auto; /* Enable scrolling for the modal background */
            padding: 20px 0; /* Add padding for better scrolling */
        }
        .upload-modal.open {
            display: flex;
        }
        .upload-content {
            background-color: #fff;
            width: 90%;
            max-width: 500px;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-height: 90vh; /* Limit height to 90% of viewport */
            overflow-y: auto; /* Enable scrolling for content */
            margin: auto; /* Center the modal */
        }
        .upload-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: sticky; /* Make header stick to top */
            top: 0;
            background-color: #fff;
            z-index: 10; /* Ensure header stays above content */
            padding-bottom: 10px;
        }
        .upload-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        .form-group label {
            font-size: 14px;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }
        .form-group input,
        .form-group textarea,
        .form-group select {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #00b300;
            box-shadow: 0 0 0 2px rgba(0, 179, 0, 0.2);
        }
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
            max-height: 150px; /* Limit textarea height */
        }
        .upload-btn {
            background: linear-gradient(to right, #004d00, #00b300);
            color: #fff;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        .upload-btn:hover {
            background: linear-gradient(to right, #003d00, #009900);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .upload-btn:active {
            transform: translateY(0);
        }
        .upload-example {
            margin-top: 15px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 4px;
            font-size: 12px;
            border-left: 4px solid #00b300;
        }
        .upload-example h4 {
            margin: 0 0 8px;
            color: #333;
            font-size: 14px;
        }
        .upload-example p {
            margin: 0 0 5px;
            color: #666;
            line-height: 1.4;
        }
        
        /* Add smooth scrolling */
        .upload-content {
            scroll-behavior: smooth;
        }
        
        /* Style for scrollbar in Webkit browsers */
        .upload-content::-webkit-scrollbar {
            width: 8px;
        }
        .upload-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .upload-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .upload-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Network Warning Styles - Updated to match image */
        .network-warning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }
        .network-warning.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .network-warning-icon {
            font-size: 80px;
            color: #ff0000;
            margin-bottom: 20px;
        }
        .network-warning-text {
            color: #ffffff;
            font-size: 20px;
            margin-bottom: 30px;
            text-align: center;
        }
        .network-warning-retry {
            background-color: #00b300;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 30px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }
        .network-warning-retry:hover {
            background-color: #009900;
        }
        
        /* Search Suggestions */
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background-color: #333;
            border-radius: 0 0 10px 10px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }
        .search-suggestions.show {
            display: block;
        }
        .search-suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            color: #fff;
            border-bottom: 1px solid #444;
        }
        .search-suggestion-item:last-child {
            border-bottom: none;
        }
        .search-suggestion-item:hover {
            background-color: #444;
        }
        .search-suggestion-item .suggestion-type {
            font-size: 12px;
            color: #aaa;
            margin-left: 5px;
        }
        
        /* Loading Spinner */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #00b300;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Improved Notifications */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            font-weight: 500;
            transition: opacity 0.5s ease;
            max-width: 80%;
            text-align: center;
        }
        .notification.success {
            background-color: #4CAF50;
            color: white;
        }
        .notification.warning {
            background-color: #FF9800;
            color: white;
        }
        .notification.error {
            background-color: #F44336;
            color: white;
        }
        .notification.info {
            background-color: #2196F3;
            color: white;
        }
        
        /* Season and Episode Management Styles */
        .seasons-container {
            margin-top: 15px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 8px;
        }
        
        .season-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .season-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }
        
        .season-actions {
            display: flex;
            gap: 10px;
        }
        
        .season-btn {
            background-color: #00b300;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .season-btn.remove {
            background-color: #ff0000;
        }
        
        .episodes-container {
            margin-top: 10px;
            padding: 10px;
            background-color: #fff;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        .episode-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        
        .episode-item:last-child {
            border-bottom: none;
        }
        
        .episode-info {
            flex: 1;
        }
        
        .episode-number {
            font-weight: bold;
            font-size: 14px;
            color: #333;
        }
        
        .episode-title {
            font-size: 12px;
            color: #666;
        }
        
        .episode-actions {
            display: flex;
            gap: 5px;
        }
        
        .episode-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: #666;
        }
        
        .episode-btn.remove {
            color: #ff0000;
        }
        
        .add-episode-btn {
            width: 100%;
            background-color: #f0f0f0;
            border: 1px dashed #ccc;
            color: #666;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }
        
        .add-episode-btn:hover {
            background-color: #e0e0e0;
        }
        
        .add-season-btn {
            width: 100%;
            background-color: #f0f0f0;
            border: 1px dashed #ccc;
            color: #666;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }
        
        .add-season-btn:hover {
            background-color: #e0e0e0;
        }
        
        /* Direct video link styles */
        .direct-link-message {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: rgba(0, 179, 0, 0.9);
            color: white;
            padding: 10px;
            text-align: center;
            z-index: 1001;
            font-size: 14px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        /* Password Modal */
        .password-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 4000;
            justify-content: center;
            align-items: center;
        }
        .password-modal.open {
            display: flex;
        }
        .password-content {
            background-color: #fff;
            width: 90%;
            max-width: 400px;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .password-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .password-header h3 {
            font-size: 18px;
            margin: 0;
            color: #333;
        }
        .password-header button {
            background: none;
            border: none;
            color: #333;
            font-size: 16px;
            cursor: pointer;
        }
        .password-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .password-input {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .password-submit {
            background: linear-gradient(to right, #004d00, #00b300);
            color: #fff;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        .password-error {
            color: #ff0000;
            font-size: 14px;
            text-align: center;
            margin-top: 10px;
        }
        
        /* File upload styling */
        .file-upload {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }
        .file-upload input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        .file-upload-label {
            display: block;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
            color: #333;
            font-size: 14px;
            text-align: center;
            transition: all 0.3s ease;
        }
        .file-upload:hover .file-upload-label {
            background-color: #f0f0f0;
            border-color: #00b300;
        }
        .file-preview {
            margin-top: 10px;
            text-align: center;
        }
        .file-preview img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <!-- Loading Spinner -->
    <div id="loading" class="loading" style="display: none;">
        <div class="loading-spinner"></div>
    </div>
    <!-- Hidden radio buttons for navigation -->
    <input type="radio" name="nav" id="nav-discover" class="nav-radio" checked>
    <input type="radio" name="nav" id="nav-movies" class="nav-radio">
    <input type="radio" name="nav" id="nav-trending" class="nav-radio">
    <input type="radio" name="nav" id="nav-mylist" class="nav-radio">
    <input type="radio" name="nav" id="nav-apps" class="nav-radio">
    
    <!-- Network Warning - Updated to match image -->
    <div class="network-warning hidden" id="network-warning">
        <i class="fas fa-wifi-slash network-warning-icon"></i>
        <div class="network-warning-text">No network connection found</div>
        <button class="network-warning-retry" onclick="checkNetworkConnection()">Try Again</button>
    </div>
    
    <!-- Direct Link Message -->
    <div id="direct-link-message" class="direct-link-message" style="display: none;">
        Opening shared video...
    </div>
    
    <header>
        <div class="header-top">
            <!-- Bars Icon -->
            <div class="bars-icon" onclick="toggleSidebarModal()">
                <i class="fas fa-bars"></i>
            </div>
            <!-- Logo as Image -->
            <div class="logo">
                <img src="https://ucarecdn.com/cee71935-3e43-44cb-a532-f962e8a311d1/-/preview/1000x1000/" alt="Movie Nest Logo" />
            </div>
            <!-- History Icon -->
            <div class="history-icon" onclick="toggleHistoryModal()">
                <i class="fas fa-history"></i>
                <span class="notification-badge">3</span>
            </div>
            <!-- Search Bar Container -->
            <div class="search-container" style="position: relative;">
                <i class="fas fa-search"></i>
                <input type="text" id="search-bar" placeholder="Search movies..." oninput="handleSearch()" onfocus="showSearchSuggestions()" onblur="hideSearchSuggestions()" />
                <i class="fas fa-filter" onclick="toggleFilterModal()" style="margin-left: 10px; cursor: pointer;"></i>
                <!-- Search Suggestions -->
                <div class="search-suggestions" id="search-suggestions"></div>
            </div>
        </div>
    </header>
    
    <!-- Filter Modal -->
    <div class="filter-container" id="filter-modal">
        <div class="filter-header">
            <h3>Filter & Sort</h3>
            <button onclick="toggleFilterModal()"></button>
        </div>
        <div class="filter-section">
            <h4>Genre</h4>
            <div class="filter-options">
                <div class="filter-option active" data-genre="All">All</div>
                <div class="filter-option" data-genre="Action">Action</div>
                <div class="filter-option" data-genre="Drama">Drama</div>
                <div class="filter-option" data-genre="Comedy">Comedy</div>
                <div class="filter-option" data-genre="Romance">Romance</div>
                <div class="filter-option" data-genre="Thriller">Thriller</div>
            </div>
        </div>
        <div class="filter-section">
            <h4>Sort By</h4>
            <div class="filter-options">
                <div class="filter-option active" data-sort="Newest">Newest</div>
                <div class="filter-option" data-sort="Popular">Popular</div>
                <div class="filter-option" data-sort="Rating">Rating</div>
                <div class="filter-option" data-sort="A-Z">A-Z</div>
            </div>
        </div>
        <button class="apply-filter-btn" onclick="applyFilters()">Apply Filters</button>
    </div>
    
    <!-- Sidebar Modal -->
    <div class="sidebar-modal" id="sidebar-modal">
        <div class="sidebar-modal-header">
            <h3></h3>
            <button onclick="toggleSidebarModal()"></button>
        </div>
        
        <!-- User Profile Section -->
        <div class="user-profile">
            <div class="user-avatar" id="user-avatar">
                <i class="fas fa-user" style="font-size: 36px;"></i>
            </div>
            <div class="user-info">
                <h3 id="user-name">Movie Nest User</h3>
                <p>Free Account</p>
            </div>
            <button class="edit-profile-btn" onclick="openEditProfileModal()">
                <i class="fas fa-edit"></i> Edit Profile
            </button>
        </div>
        
        <div class="sidebar-list" id="sidebar-list">
            <!-- Director Center - Now with upload functionality -->
            <div class="sidebar-item" onclick="checkPasswordAndOpenUpload()">
                <img src="https://cdn-icons-png.flaticon.com/128/18831/18831648.png" alt="Director Center">
                <span>Director Center</span>
            </div>
            <!-- Apps Center - Changed from Earn Rewards -->
            <div class="sidebar-item" onclick="checkPasswordAndOpenApps()">
                <img src="https://cdn-icons-png.flaticon.com/128/5303/5303479.png" alt="Apps Center">
                <span>Apps Center</span>
            </div>
            <!-- Ads Center - Changed from Viewer Gift -->
            <div class="sidebar-item" onclick="checkPasswordAndOpenAds()">
                <img src="https://cdn-icons-png.flaticon.com/128/9592/9592247.png" alt="Ads Center">
                <span>Ads Center</span>
            </div>
            <div class="sidebar-item">
                <img src="https://cdn-icons-png.flaticon.com/128/18392/18392966.png" alt="Online Service">
                <span>Online Service</span>
            </div>
            <div class="sidebar-item">
                <img src="https://cdn-icons-png.flaticon.com/128/2312/2312342.png" alt="Privacy Policy">
                <span>Privacy Policy</span>
            </div>
            <!-- New items -->
            <div class="sidebar-item">
                <img src="https://cdn-icons-png.flaticon.com/128/3405/3405247.png" alt="Settings">
                <span>Settings</span>
            </div>
            <div class="sidebar-item">
                <img src="https://cdn-icons-png.flaticon.com/128/2838/2838694.png" alt="Help">
                <span>Help & Support</span>
            </div>
        </div>
    </div>
    
    <!-- Password Modal -->
    <div class="password-modal" id="password-modal">
        <div class="password-content">
            <div class="password-header">
                <h3>Enter Password</h3>
                <button onclick="closePasswordModal()"></button>
            </div>
            <form class="password-form" id="password-form" onsubmit="validatePassword(event)">
                <input type="password" id="password-input" class="password-input" placeholder="Enter password" required>
                <button type="submit" class="password-submit">Submit</button>
                <div id="password-error" class="password-error"></div>
            </form>
        </div>
    </div>
    
    <!-- Upload Modal -->
    <div class="upload-modal" id="upload-modal">
        <div class="upload-content">
            <div class="upload-header">
                <h3>Upload Video</h3>
                <button onclick="closeUploadModal()"></button>
            </div>
            <form class="upload-form" id="upload-form">
                <div class="form-group">
                    <label for="video-title">Video Title</label>
                    <input type="text" id="video-title" placeholder="Enter video title" required>
                </div>
                <div class="form-group">
                    <label for="video-description">Description</label>
                    <textarea id="video-description" placeholder="Enter video description"></textarea>
                </div>
                <div class="form-group">
                    <label for="video-type">Video Type</label>
                    <select id="video-type" required onchange="toggleSeriesFields()">
                        <option value="movie">Movie</option>
                        <option value="series">Series</option>
                        <option value="anime">Anime</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="video-category">Category</label>
                    <select id="video-category" required>
                        <option value="Hollywood">Hollywood</option>
                        <option value="Nollywood">Nollywood</option>
                        <option value="Bollywood">Bollywood</option>
                        <option value="Kannywood">Kannywood</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="video-genre">Genre</label>
                    <select id="video-genre" required>
                        <option value="Action">Action</option>
                        <option value="Drama">Drama</option>
                        <option value="Comedy">Comedy</option>
                        <option value="Romance">Romance</option>
                        <option value="Thriller">Thriller</option>
                    </select>
                </div>
                <!-- New Countries field -->
                <div class="form-group">
                    <label for="video-country">Country</label>
                    <select id="video-country" required>
                        <option value="USA">USA</option>
                        <option value="Nigeria">Nigeria</option>
                        <option value="India">India</option>
                        <option value="UK">UK</option>
                        <option value="Canada">Canada</option>
                        <option value="France">France</option>
                        <option value="Germany">Germany</option>
                        <option value="Japan">Japan</option>
                        <option value="South Korea">South Korea</option>
                        <option value="China">China</option>
                        <option value="Australia">Australia</option>
                        <option value="Brazil">Brazil</option>
                        <option value="Mexico">Mexico</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <!-- New Trending field -->
                <div class="form-group">
                    <label for="video-trending">Trending</label>
                    <select id="video-trending" required>
                        <option value="false">No</option>
                        <option value="true">Yes</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="video-year">Year</label>
                    <input type="number" id="video-year" min="1900" max="2030" placeholder="2023" required>
                </div>
                <div class="form-group">
                    <label for="video-url">Video URL (YouTube embed or Google Drive preview)</label>
                    <input type="url" id="video-url" placeholder="https://www.youtube.com/embed/VIDEO_ID or https://drive.google.com/file/d/FILE_ID/preview" required>
                </div>
                <!-- Changed from URL to File upload -->
                <div class="form-group">
                    <label for="video-thumbnail">Thumbnail File</label>
                    <div class="file-upload">
                        <input type="file" id="video-thumbnail" accept="image/*" onchange="previewThumbnail(this)">
                        <label for="video-thumbnail" class="file-upload-label">Choose an image file</label>
                    </div>
                    <div id="thumbnail-preview" class="file-preview"></div>
                </div>
                
                <!-- Series-specific fields - initially hidden -->
                <div id="series-fields" style="display: none;">
                    <div class="seasons-container" id="seasons-container">
                        <div class="season-header">
                            <div class="season-title">Seasons</div>
                            <button type="button" class="season-btn" onclick="addSeason()">Add Season</button>
                        </div>
                        <div id="seasons-list">
                            <!-- Seasons will be added here dynamically -->
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="upload-btn">Upload Video</button>
                <div class="upload-example">
                    <h4>Example URLs:</h4>
                    <p>YouTube: https://www.youtube.com/embed/MN4hHqWWpwU</p>
                    <p>Google Drive: https://drive.google.com/file/d/1CWOELtePqeDDI-t07aWB0NAWQXlvH-ul/preview</p>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Apps Upload Modal -->
    <div class="upload-modal" id="apps-upload-modal">
        <div class="upload-content">
            <div class="upload-header">
                <h3>Upload App</h3>
                <button onclick="closeAppsUploadModal()"></button>
            </div>
            <form class="upload-form" id="apps-upload-form">
                <div class="form-group">
                    <label for="app-name">App Name</label>
                    <input type="text" id="app-name" placeholder="Enter app name" required>
                </div>
                <div class="form-group">
                    <label for="app-description">Description</label>
                    <textarea id="app-description" placeholder="Enter app description"></textarea>
                </div>
                <div class="form-group">
                    <label for="app-category">Category</label>
                    <select id="app-category" required>
                        <option value="Games">Games</option>
                        <option value="Productivity">Productivity</option>
                        <option value="Social">Social</option>
                        <option value="Entertainment">Entertainment</option>
                        <option value="Education">Education</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="app-link">App Link</label>
                    <input type="url" id="app-link" placeholder="https://example.com/app" required>
                </div>
                <div class="form-group">
                    <label for="app-icon">App Icon</label>
                    <div class="file-upload">
                        <input type="file" id="app-icon" accept="image/*" onchange="previewAppIcon(this)">
                        <label for="app-icon" class="file-upload-label">Choose an image file</label>
                    </div>
                    <div id="app-icon-preview" class="file-preview"></div>
                </div>
                <button type="submit" class="upload-btn">Upload App</button>
            </form>
        </div>
    </div>
    
    <!-- Ads Upload Modal -->
    <div class="upload-modal" id="ads-upload-modal">
        <div class="upload-content">
            <div class="upload-header">
                <h3>Upload Ad</h3>
                <button onclick="closeAdsUploadModal()"></button>
            </div>
            <form class="upload-form" id="ads-upload-form">
                <div class="form-group">
                    <label for="ad-title">Ad Title</label>
                    <input type="text" id="ad-title" placeholder="Enter ad title" required>
                </div>
                <div class="form-group">
                    <label for="ad-description">Description</label>
                    <textarea id="ad-description" placeholder="Enter ad description"></textarea>
                </div>
                <div class="form-group">
                    <label for="ad-link">Ad Link</label>
                    <input type="url" id="ad-link" placeholder="https://example.com/ad" required>
                </div>
                <div class="form-group">
                    <label for="ad-image">Ad Image</label>
                    <div class="file-upload">
                        <input type="file" id="ad-image" accept="image/*" onchange="previewAdImage(this)">
                        <label for="ad-image" class="file-upload-label">Choose an image file</label>
                    </div>
                    <div id="ad-image-preview" class="file-preview"></div>
                </div>
                <button type="submit" class="upload-btn">Upload Ad</button>
            </form>
        </div>
    </div>
    
    <!-- Edit Profile Modal -->
    <div class="edit-profile-modal" id="edit-profile-modal">
        <div class="edit-profile-content">
            <div class="edit-profile-header">
                <h3>Edit Profile</h3>
                <button onclick="closeEditProfileModal()"></button>
            </div>
            <div class="avatar-selection">
                <div class="avatar-option" data-avatar="1">
                    <img src="https://cdn-icons-png.flaticon.com/128/6997/6997666.png" alt="Avatar 1">
                </div>
                <div class="avatar-option" data-avatar="2">
                    <img src="https://cdn-icons-png.flaticon.com/128/6997/6997662.png" alt="Avatar 2">
                </div>
                <div class="avatar-option" data-avatar="3">
                    <img src="https://cdn-icons-png.flaticon.com/128/6997/6997661.png" alt="Avatar 3">
                </div>
                <div class="avatar-option" data-avatar="4">
                    <img src="https://cdn-icons-png.flaticon.com/128/6997/6997664.png" alt="Avatar 4">
                </div>
            </div>
            <div class="form-group">
                <label for="user-name-input">Name</label>
                <input type="text" id="user-name-input" placeholder="Enter your name">
            </div>
            <button class="save-profile-btn" onclick="saveProfile()">Save Changes</button>
        </div>
    </div>
    
    <div class="notification-bar" id="notification-bar">
        <img src="https://bit.ly/434z6xR" alt="App Logo">
        <div class="notification-text">Enjoy more movies download movie nest app.</div>
        <button class="notification-button" onclick="window.open('https://www.appcreator24.com/app3501058-ks4rfa', '_blank')">OPEN</button>
        <button class="close-button" onclick="closeNotification()"></button>
    </div>
    <!-- History Modal -->
    <div class="history-modal" id="history-modal">
        <div class="history-modal-header">
            <h3>Recently Watched</h3>
            <button onclick="toggleHistoryModal()"></button>
        </div>
        <div class="history-list" id="history-list"></div>
        <button class="clear-history-button" onclick="clearHistory()">Clear All History</button>
    </div>
    <!-- Discover Section -->
    <div class="discover-container" id="discover-container">
        <!-- Carousel Section - Now inside discover section -->
        <div class="carousel-container">
            <div class="carousel" id="carousel"></div>
            <div class="dots" id="dots"></div>
        </div>
        
        <!-- Categories Section - New section based on screenshot -->
        <div class="categories-section">
            <div class="categories-title">Categories</div>
            <div class="categories-scroll" id="categories-scroll">
                <div class="category-btn active" data-category="All">All</div>
                <div class="category-btn" data-category="Hollywood">Hollywood</div>
                <div class="category-btn" data-category="Nollywood">Nollywood</div>
                <div class="category-btn" data-category="Bollywood">Bollywood</div>
                <div class="category-btn" data-category="Kannywood">Kannywood</div>
                <div class="category-btn" data-category="Action">Action</div>
                <div class="category-btn" data-category="Drama">Drama</div>
                <div class="category-btn" data-category="Comedy">Comedy</div>
            </div>
        </div>
        
        <div class="discover-scroll" id="discover-scroll"></div>
    </div>        
    <!-- Categories Section -->
    <div id="categories-container"></div>
    <!-- Grid Layout for View All and Search Results -->
    <div id="grid-container" class="grid-container" style="display: none;"></div>
    <!-- Navigation Modal -->
    <div class="nav-container" id="video-nav">
        <div class="nav-content">
            <div class="nav-header">
                <button id="close-btn" onclick="closeNav()"><i class="fas fa-arrow-left"></i></button>
                <div>
                    <button id="share-btn" onclick="shareMovie()"><i class="fas fa-share-alt"></i> Share</button>
                    <button id="save-btn" class="save-btn" onclick="toggleSaveStatus()">Add to list</button>
                </div>
            </div>
            <div class="nav-body">
                <div style="position: relative; width: 100%; height: 100%;">
                    <button class="quality-selector">HD <i class="fas fa-chevron-down"></i></button>
                    <iframe id="video-player" src="" frameborder="0" allowfullscreen style="width: 100%; height: 100%;"></iframe>
                    <div class="player-controls">
                        <button><i class="fas fa-backward"></i></button>
                        <div class="player-timeline">
                            <div class="player-progress"></div>
                        </div>
                        <button><i class="fas fa-forward"></i></button>
                    </div>
                </div>
            </div>
            <!-- Episode Footer -->
            <div class="episode-footer" id="episode-footer" style="display: none;">
                <div class="episode-header">
                    <div class="episode-title" id="episode-title">Episodes</div>
                    <div class="episode-count" id="episode-count">0 Episodes</div>
                </div>
                <div class="episode-scroller" id="episode-scroller">
                    <!-- Episode buttons will be dynamically added here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Social Media Descriptions -->
    <div id="social-media-descriptions">
        <h2>Follow us on social media:</h2>
    </div>
    <!-- Social Media Icons -->
    <div id="social-media">
        <a href="https://www.facebook.com/share/1AQXgVMP49/" target="_blank" class="social-icon">
            <i class="fab fa-facebook-f"></i>
        </a>
        <a href="#" target="_blank" class="social-icon">
            <i class="fab fa-twitter"></i>
        </a>
        <a href="#" target="_blank" class="social-icon">
            <i class="fab fa-telegram"></i>
        </a>
        <a href="#" target="_blank" class="social-icon">
            <i class="fab fa-instagram"></i>
        </a>
        <a href="#" target="_blank" class="social-icon">
            <i class="fab fa-youtube"></i>
        </a>
        <a href="#" target="_blank" class="social-icon">
            <i class="fab fa-whatsapp"></i>
        </a>
        <a href="#" target="_blank" class="social-icon">
            <i class="fab fa-tiktok"></i>
        </a>
    </div>
    <!-- Bottom Navigation Bar -->
    <footer>
        <label for="nav-discover" class="nav-icon" onclick="showDiscoverSection();">
            <i class="fas fa-compass"></i>
            <span>Discover</span>
        </label>
        <label for="nav-movies" class="nav-icon" onclick="showHomeVideos();">
            <i class="fas fa-film"></i>
            <span>Movies</span>
        </label>
        <label for="nav-trending" class="nav-icon" onclick="showTrendingVideos();">
            <i class="fas fa-fire"></i>
            <span>Trending</span>
        </label>
        <label for="nav-mylist" class="nav-icon" onclick="showMyList();">
            <i class="fas fa-list"></i>
            <span>My List</span>
        </label>
        <label for="nav-apps" class="nav-icon" onclick="showProfileSection();">
            <i class="fab fa-app-store"></i>
            <span>Apps</span>
        </label>
    </footer>
    
    <script>
        // Initialize Firebase with your configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA9JK8BX2pAXpmW_d6GpXRZjFpTLkso1KI",
            authDomain: "movie-nest-77e6b.firebaseapp.com",
            projectId: "movie-nest-77e6b",
            storageBucket: "movie-nest-77e6b.firebasestorage.app",
            messagingSenderId: "513317696448",
            appId: "1:513317696448:web:c70c566151226ef55bce25"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();
        
        // Fetch videos from Firestore
        async function fetchVideosFromFirestore() {
            try {
                showLoading();
                const snapshot = await db.collection('videos').get();
                const videos = [];
                snapshot.forEach(doc => {
                    videos.push({ id: doc.id, ...doc.data() });
                });
                hideLoading();
                return videos;
            } catch (error) {
                console.error('Error fetching videos:', error);
                hideLoading();
                showNotification('Failed to load videos. Please check your connection.', 'error');
                return [];
            }
        }
        
        // Fetch apps from Firestore
        async function fetchAppsFromFirestore() {
            try {
                showLoading();
                const snapshot = await db.collection('apps').get();
                const apps = [];
                snapshot.forEach(doc => {
                    apps.push({ id: doc.id, ...doc.data() });
                });
                hideLoading();
                return apps;
            } catch (error) {
                console.error('Error fetching apps:', error);
                hideLoading();
                showNotification('Failed to load apps. Please check your connection.', 'error');
                return [];
            }
        }
        
        // Fetch ads from Firestore
        async function fetchAdsFromFirestore() {
            try {
                showLoading();
                const snapshot = await db.collection('ads').get();
                const ads = [];
                snapshot.forEach(doc => {
                    ads.push({ id: doc.id, ...doc.data() });
                });
                hideLoading();
                return ads;
            } catch (error) {
                console.error('Error fetching ads:', error);
                hideLoading();
                showNotification('Failed to load ads. Please check your connection.', 'error');
                return [];
            }
        }
        
        // Initialize saved movies from localStorage
        let savedMovies = JSON.parse(localStorage.getItem('savedMovies')) || [];
        
        // Initialize user profile from localStorage
        let userProfile = JSON.parse(localStorage.getItem('userProfile')) || {
            name: 'Movie Nest User',
            avatar: null
        };
        
        // Fallback data in case external files fail to load
        const fallbackData = [
            {
                id: 1,
                title: "Sample Movie",
                description: "A sample movie for testing",
                imgUrl: "https://picsum.photos/seed/movie1/300/450.jpg",
                videoUrl: "https://www.youtube.com/embed/MN4hHqWWpwU",
                category: "Hollywood",
                genre: "Action",
                year: 2023,
                type: "Movie"
            }
        ];
        
        // Data validation
        let videosData, seriesData, animeData, profileApps, adsData;
        
        function validateData() {
            if (!videosData || !Array.isArray(videosData)) {
                console.error("videosData is missing or invalid");
                return false;
            }
            if (!seriesData || !Array.isArray(seriesData)) {
                console.error("seriesData is missing or invalid");
                return false;
            }
            if (!animeData || !Array.isArray(animeData)) {
                console.error("animeData is missing or invalid");
                return false;
            }
            return true;
        }
        
        // Combine videos, series, and anime data and shuffle
        let combinedData;
        let data;
        
        try {
            if (validateData()) {
                combinedData = [...videosData, ...seriesData, ...animeData];
            } else {
                combinedData = fallbackData;
                console.warn("Using fallback data due to validation errors");
            }
            data = shuffleArray(combinedData);
        } catch (error) {
            console.error("Error combining data:", error);
            data = fallbackData;
        }
        
        // Track if we're currently in the video modal
        let inVideoModal = false;
        
        // Track if we're currently in a grid view
        let inGridView = false;
        
        // Track if we're currently in the filter modal
        let inFilterModal = false;
        
        // Track if we're currently in the history modal
        let inHistoryModal = false;
        
        // Track if we're currently in the sidebar modal
        let inSidebarModal = false;
        
        // Track if we're currently in the upload modal
        let inUploadModal = false;
        
        // Track if we're currently in the apps upload modal
        let inAppsUploadModal = false;
        
        // Track if we're currently in the ads upload modal
        let inAdsUploadModal = false;
        
        // Track if we're currently in the password modal
        let inPasswordModal = false;
        
        // Track current grid data for filtering
        let currentGridData = [];
        
        // Track if we're navigating episodes/seasons
        let isEpisodeNavigation = false;
        
        // Track search suggestions
        let searchTimeout;
        let currentSearchTerm = '';
        
        // Track seasons and episodes for upload
        let seasons = [];
        let seasonCounter = 0;
        
        // Track if we're opening a direct video link
        let openingDirectLink = false;
        
        // Track the current upload type (video, app, or ad)
        let currentUploadType = 'video';
        
        // Function to show/hide loading spinner
        function showLoading() {
            document.getElementById('loading').style.display = 'flex';
        }
        
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
        
        // Function to validate video URLs
        function isValidVideoUrl(url) {
            try {
                const urlObj = new URL(url);
                return (
                    urlObj.hostname.includes('youtube.com') || 
                    urlObj.hostname.includes('drive.google.com')
                );
            } catch (e) {
                return false;
            }
        }
        
        // Function to check password and open upload modal
        const checkPasswordAndOpenUpload = () => {
            currentUploadType = 'video';
            openPasswordModal();
        };
        
        // Function to check password and open apps upload modal
        const checkPasswordAndOpenApps = () => {
            currentUploadType = 'apps';
            openPasswordModal();
        };
        
        // Function to check password and open ads upload modal
        const checkPasswordAndOpenAds = () => {
            currentUploadType = 'ads';
            openPasswordModal();
        };
        
        // Function to open password modal
        const openPasswordModal = () => {
            const passwordModal = document.getElementById('password-modal');
            passwordModal.classList.add('open');
            inPasswordModal = true;
            
            // Clear previous error message
            document.getElementById('password-error').textContent = '';
            
            // Focus on password input
            setTimeout(() => {
                document.getElementById('password-input').focus();
            }, 100);
        };
        
        // Function to close password modal
        const closePasswordModal = () => {
            const passwordModal = document.getElementById('password-modal');
            passwordModal.classList.remove('open');
            inPasswordModal = false;
            
            // Clear password input
            document.getElementById('password-input').value = '';
            document.getElementById('password-error').textContent = '';
        };
        
        // Function to validate password
        const validatePassword = (event) => {
            event.preventDefault();
            
            const password = document.getElementById('password-input').value;
            const correctPassword = 'Mm&&0220';
            
            if (password === correctPassword) {
                // Password is correct, open the appropriate upload modal
                closePasswordModal();
                
                if (currentUploadType === 'video') {
                    openUploadModal();
                } else if (currentUploadType === 'apps') {
                    openAppsUploadModal();
                } else if (currentUploadType === 'ads') {
                    openAdsUploadModal();
                }
            } else {
                // Password is incorrect, show error message
                document.getElementById('password-error').textContent = 'Incorrect password. Please try again.';
                
                // Clear password input
                document.getElementById('password-input').value = '';
                
                // Focus on password input again
                setTimeout(() => {
                    document.getElementById('password-input').focus();
                }, 100);
            }
        };
        
        // Function to toggle the upload modal
        const openUploadModal = () => {
            const uploadModal = document.getElementById('upload-modal');
            const sidebarModal = document.getElementById('sidebar-modal');
            
            // Close sidebar modal first
            if (sidebarModal.classList.contains('open')) {
                sidebarModal.classList.remove('open');
                inSidebarModal = false;
            }
            
            // Open upload modal
            uploadModal.classList.add('open');
            inUploadModal = true;
            
            // Push state to history
            history.pushState({ uploadOpen: true }, '');
            
            // Reset form
            document.getElementById('upload-form').reset();
            
            // Reset thumbnail preview
            document.getElementById('thumbnail-preview').innerHTML = '';
            
            // Reset seasons data
            seasons = [];
            seasonCounter = 0;
            document.getElementById('seasons-list').innerHTML = '';
            
            // Scroll to top of modal content
            setTimeout(() => {
                const uploadContent = document.querySelector('.upload-content');
                if (uploadContent) {
                    uploadContent.scrollTop = 0;
                }
            }, 100);
        };
        
        const closeUploadModal = () => {
            const uploadModal = document.getElementById('upload-modal');
            uploadModal.classList.remove('open');
            inUploadModal = false;
            
            // Reset form
            document.getElementById('upload-form').reset();
            
            // Reset thumbnail preview
            document.getElementById('thumbnail-preview').innerHTML = '';
        };
        
        // Function to toggle the apps upload modal
        const openAppsUploadModal = () => {
            const appsUploadModal = document.getElementById('apps-upload-modal');
            const sidebarModal = document.getElementById('sidebar-modal');
            
            // Close sidebar modal first
            if (sidebarModal.classList.contains('open')) {
                sidebarModal.classList.remove('open');
                inSidebarModal = false;
            }
            
            // Open apps upload modal
            appsUploadModal.classList.add('open');
            inAppsUploadModal = true;
            
            // Push state to history
            history.pushState({ appsUploadOpen: true }, '');
            
            // Reset form
            document.getElementById('apps-upload-form').reset();
            
            // Reset app icon preview
            document.getElementById('app-icon-preview').innerHTML = '';
            
            // Scroll to top of modal content
            setTimeout(() => {
                const uploadContent = document.querySelector('.upload-content');
                if (uploadContent) {
                    uploadContent.scrollTop = 0;
                }
            }, 100);
        };
        
        const closeAppsUploadModal = () => {
            const appsUploadModal = document.getElementById('apps-upload-modal');
            appsUploadModal.classList.remove('open');
            inAppsUploadModal = false;
            
            // Reset form
            document.getElementById('apps-upload-form').reset();
            
            // Reset app icon preview
            document.getElementById('app-icon-preview').innerHTML = '';
        };
        
        // Function to toggle the ads upload modal
        const openAdsUploadModal = () => {
            const adsUploadModal = document.getElementById('ads-upload-modal');
            const sidebarModal = document.getElementById('sidebar-modal');
            
            // Close sidebar modal first
            if (sidebarModal.classList.contains('open')) {
                sidebarModal.classList.remove('open');
                inSidebarModal = false;
            }
            
            // Open ads upload modal
            adsUploadModal.classList.add('open');
            inAdsUploadModal = true;
            
            // Push state to history
            history.pushState({ adsUploadOpen: true }, '');
            
            // Reset form
            document.getElementById('ads-upload-form').reset();
            
            // Reset ad image preview
            document.getElementById('ad-image-preview').innerHTML = '';
            
            // Scroll to top of modal content
            setTimeout(() => {
                const uploadContent = document.querySelector('.upload-content');
                if (uploadContent) {
                    uploadContent.scrollTop = 0;
                }
            }, 100);
        };
        
        const closeAdsUploadModal = () => {
            const adsUploadModal = document.getElementById('ads-upload-modal');
            adsUploadModal.classList.remove('open');
            inAdsUploadModal = false;
            
            // Reset form
            document.getElementById('ads-upload-form').reset();
            
            // Reset ad image preview
            document.getElementById('ad-image-preview').innerHTML = '';
        };
        
        // Function to preview thumbnail
        const previewThumbnail = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const preview = document.getElementById('thumbnail-preview');
                    preview.innerHTML = `<img src="${e.target.result}" alt="Thumbnail preview">`;
                };
                
                reader.readAsDataURL(input.files[0]);
            }
        };
        
        // Function to preview app icon
        const previewAppIcon = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const preview = document.getElementById('app-icon-preview');
                    preview.innerHTML = `<img src="${e.target.result}" alt="App icon preview">`;
                };
                
                reader.readAsDataURL(input.files[0]);
            }
        };
        
        // Function to preview ad image
        const previewAdImage = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const preview = document.getElementById('ad-image-preview');
                    preview.innerHTML = `<img src="${e.target.result}" alt="Ad image preview">`;
                };
                
                reader.readAsDataURL(input.files[0]);
            }
        };
        
        // Function to upload file to Firebase Storage and get URL
        const uploadFileAndGetUrl = async (file, path) => {
            try {
                showLoading();
                
                // Check if file exists
                if (!file) {
                    throw new Error('No file selected');
                }
                
                // Check file size (limit to 10MB)
                if (file.size > 10 * 1024 * 1024) {
                    throw new Error('File size exceeds 10MB limit');
                }
                
                // Create a storage reference
                const storageRef = storage.ref();
                const fileRef = storageRef.child(path);
                
                // Upload file with metadata
                const metadata = {
                    contentType: file.type,
                    name: file.name
                };
                
                const uploadTask = fileRef.put(file, metadata);
                
                // Monitor upload progress
                uploadTask.on('state_changed', 
                    (snapshot) => {
                        // Progress indicator can be added here
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        console.log('Upload is ' + progress + '% done');
                    }, 
                    (error) => {
                        // Handle unsuccessful uploads
                        console.error('Upload error:', error);
                        hideLoading();
                        showNotification('Error uploading file: ' + error.message, 'error');
                        throw error;
                    }, 
                    () => {
                        // Handle successful uploads on complete
                        // For instance, get the download URL
                        uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                            console.log('File available at', downloadURL);
                            hideLoading();
                            return downloadURL;
                        });
                    }
                );
                
                // Wait for upload to complete and get URL
                const snapshot = await uploadTask;
                const downloadUrl = await snapshot.ref.getDownloadURL();
                
                hideLoading();
                return downloadUrl;
            } catch (error) {
                console.error('Error uploading file:', error);
                hideLoading();
                showNotification('Error uploading file: ' + error.message, 'error');
                throw error;
            }
        };
        
        // Function to toggle series fields based on video type
        const toggleSeriesFields = () => {
            const videoType = document.getElementById('video-type').value;
            const seriesFields = document.getElementById('series-fields');
            
            if (videoType === 'series' || videoType === 'anime') {
                seriesFields.style.display = 'block';
                
                // Add at least one season if none exist
                if (seasons.length === 0) {
                    addSeason();
                }
            } else {
                seriesFields.style.display = 'none';
            }
        };
        
        // Function to add a new season
        const addSeason = () => {
            seasonCounter++;
            const seasonId = `season-${seasonCounter}`;
            
            const seasonData = {
                id: seasonId,
                seasonNumber: seasonCounter,
                episodes: []
            };
            
            seasons.push(seasonData);
            
            const seasonElement = document.createElement('div');
            seasonElement.className = 'seasons-container';
            seasonElement.id = seasonId;
            seasonElement.innerHTML = `
                <div class="season-header">
                    <div class="season-title">Season ${seasonCounter}</div>
                    <div class="season-actions">
                        <button type="button" class="season-btn" onclick="addEpisode('${seasonId}')">Add Episode</button>
                        <button type="button" class="season-btn remove" onclick="removeSeason('${seasonId}')">Remove</button>
                    </div>
                </div>
                <div class="episodes-container" id="${seasonId}-episodes">
                    <!-- Episodes will be added here dynamically -->
                </div>
            `;
            
            document.getElementById('seasons-list').appendChild(seasonElement);
            
            // Add at least one episode to the new season
            addEpisode(seasonId);
        };
        
        // Function to remove a season
        const removeSeason = (seasonId) => {
            // Remove from data array
            seasons = seasons.filter(season => season.id !== seasonId);
            
            // Remove from DOM
            document.getElementById(seasonId).remove();
            
            // If no seasons left, reset counter
            if (seasons.length === 0) {
                seasonCounter = 0;
            }
        };
        
        // Function to add a new episode to a season
        const addEpisode = (seasonId) => {
            const season = seasons.find(s => s.id === seasonId);
            if (!season) return;
            
            const episodeNumber = season.episodes.length + 1;
            const episodeId = `${seasonId}-episode-${episodeNumber}`;
            
            const episodeData = {
                id: episodeId,
                number: episodeNumber,
                title: `Episode ${episodeNumber}`,
                url: ''
            };
            
            season.episodes.push(episodeData);
            
            const episodeElement = document.createElement('div');
            episodeElement.className = 'episode-item';
            episodeElement.id = episodeId;
            episodeElement.innerHTML = `
                <div class="episode-info">
                    <div class="episode-number">Episode ${episodeNumber}</div>
                    <div class="episode-title">
                        <input type="text" placeholder="Episode title" value="${episodeData.title}" onchange="updateEpisodeTitle('${episodeId}', this.value)">
                    </div>
                </div>
                <div class="episode-actions">
                    <input type="url" placeholder="Episode URL" style="width: 200px; padding: 5px; margin-right: 10px;" onchange="updateEpisodeUrl('${episodeId}', this.value)">
                    <button type="button" class="episode-btn remove" onclick="removeEpisode('${seasonId}', '${episodeId}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            document.getElementById(`${seasonId}-episodes`).appendChild(episodeElement);
        };
        
        // Function to remove an episode
        const removeEpisode = (seasonId, episodeId) => {
            const season = seasons.find(s => s.id === seasonId);
            if (!season) return;
            
            // Remove from data array
            season.episodes = season.episodes.filter(episode => episode.id !== episodeId);
            
            // Remove from DOM
            document.getElementById(episodeId).remove();
            
            // Renumber remaining episodes
            season.episodes.forEach((episode, index) => {
                episode.number = index + 1;
                episode.title = episode.title.replace(/Episode \d+/, `Episode ${index + 1}`);
                
                // Update DOM
                const episodeElement = document.getElementById(episode.id);
                if (episodeElement) {
                    episodeElement.querySelector('.episode-number').textContent = `Episode ${index + 1}`;
                    episodeElement.querySelector('.episode-title input').value = episode.title;
                }
            });
        };
        
        // Function to update episode title
        const updateEpisodeTitle = (episodeId, title) => {
            for (const season of seasons) {
                const episode = season.episodes.find(e => e.id === episodeId);
                if (episode) {
                    episode.title = title;
                    break;
                }
            }
        };
        
        // Function to update episode URL
        const updateEpisodeUrl = (episodeId, url) => {
            for (const season of seasons) {
                const episode = season.episodes.find(e => e.id === episodeId);
                if (episode) {
                    episode.url = url;
                    break;
                }
            }
        };
        
        // Handle form submission for video upload - Enhanced for series
        document.getElementById('upload-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Get form values
            const title = document.getElementById('video-title').value;
            const description = document.getElementById('video-description').value;
            const type = document.getElementById('video-type').value;
            const category = document.getElementById('video-category').value;
            const genre = document.getElementById('video-genre').value;
            const country = document.getElementById('video-country').value;
            const trending = document.getElementById('video-trending').value === 'true';
            const year = document.getElementById('video-year').value;
            const videoUrl = document.getElementById('video-url').value;
            const thumbnailFile = document.getElementById('video-thumbnail').files[0];
            
            // Validate URL format
            if (!isValidVideoUrl(videoUrl)) {
                showNotification('Please enter a valid YouTube embed or Google Drive preview URL', 'warning');
                return;
            }
            
            try {
                showLoading();
                
                // Upload thumbnail file and get URL
                let thumbnailUrl = `https://picsum.photos/seed/${Math.random().toString(36).substring(7)}/300/450.jpg`;
                if (thumbnailFile) {
                    const thumbnailPath = `thumbnails/${Date.now()}_${thumbnailFile.name}`;
                    thumbnailUrl = await uploadFileAndGetUrl(thumbnailFile, thumbnailPath);
                }
                
                // Create video object
                const videoData = {
                    title,
                    description,
                    type,
                    category,
                    genre,
                    country,
                    trending,
                    year: parseInt(year),
                    videoUrl,
                    imgUrl: thumbnailUrl,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    uploadedBy: 'anonymous' // Use 'anonymous' instead of user ID
                };
                
                // If it's a series or anime, add seasons and episodes data
                if ((type === 'series' || type === 'anime') && seasons.length > 0) {
                    videoData.isSeries = true;
                    videoData.seasons = seasons.map(season => ({
                        seasonNumber: season.seasonNumber,
                        episodes: season.episodes.map(episode => ({
                            number: episode.number,
                            title: episode.title,
                            url: episode.url
                        }))
                    }));
                    
                    // Validate that all episodes have URLs
                    let allEpisodesHaveUrls = true;
                    for (const season of videoData.seasons) {
                        for (const episode of season.episodes) {
                            if (!episode.url || !isValidVideoUrl(episode.url)) {
                                allEpisodesHaveUrls = false;
                                break;
                            }
                        }
                        if (!allEpisodesHaveUrls) break;
                    }
                    
                    if (!allEpisodesHaveUrls) {
                        showNotification('Please provide valid URLs for all episodes', 'warning');
                        hideLoading();
                        return;
                    }
                }
                
                // Add to Firestore
                const docRef = await db.collection('videos').add(videoData);
                
                // Show success message
                showNotification('Video uploaded successfully!', 'success');
                
                // Close modal
                closeUploadModal();
                
                // Add the new video to the local data array
                const newVideo = {
                    id: docRef.id,
                    ...videoData
                };
                data.unshift(newVideo);
                
                // Refresh the UI
                createDiscoverSection();
                createCategories();
                
            } catch (error) {
                console.error('Error uploading video:', error);
                showNotification('Error uploading video. Please try again.', 'warning');
            } finally {
                hideLoading();
            }
        });
        
        // Handle form submission for apps upload
        document.getElementById('apps-upload-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Get form values
            const name = document.getElementById('app-name').value;
            const description = document.getElementById('app-description').value;
            const category = document.getElementById('app-category').value;
            const link = document.getElementById('app-link').value;
            const iconFile = document.getElementById('app-icon').files[0];
            
            try {
                showLoading();
                
                // Upload icon file and get URL
                let iconUrl = `https://picsum.photos/seed/${Math.random().toString(36).substring(7)}/100/100.jpg`;
                if (iconFile) {
                    const iconPath = `app-icons/${Date.now()}_${iconFile.name}`;
                    iconUrl = await uploadFileAndGetUrl(iconFile, iconPath);
                }
                
                // Create app object
                const appData = {
                    name,
                    description,
                    category,
                    link,
                    icon: iconUrl,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    uploadedBy: 'anonymous' // Use 'anonymous' instead of user ID
                };
                
                // Add to Firestore
                const docRef = await db.collection('apps').add(appData);
                
                // Show success message
                showNotification('App uploaded successfully!', 'success');
                
                // Close modal
                closeAppsUploadModal();
                
                // Refresh the UI if on profile section
                if (inGridView && document.querySelector('.profile-item')) {
                    showProfileSection();
                }
                
            } catch (error) {
                console.error('Error uploading app:', error);
                showNotification('Error uploading app. Please try again.', 'warning');
            } finally {
                hideLoading();
            }
        });
        
        // Handle form submission for ads upload
        document.getElementById('ads-upload-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Get form values
            const title = document.getElementById('ad-title').value;
            const description = document.getElementById('ad-description').value;
            const link = document.getElementById('ad-link').value;
            const imageFile = document.getElementById('ad-image').files[0];
            
            try {
                showLoading();
                
                // Upload image file and get URL
                let imageUrl = `https://picsum.photos/seed/${Math.random().toString(36).substring(7)}/300/200.jpg`;
                if (imageFile) {
                    const imagePath = `ad-images/${Date.now()}_${imageFile.name}`;
                    imageUrl = await uploadFileAndGetUrl(imageFile, imagePath);
                }
                
                // Create ad object
                const adData = {
                    title,
                    description,
                    link,
                    image: imageUrl,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    uploadedBy: 'anonymous' // Use 'anonymous' instead of user ID
                };
                
                // Add to Firestore
                const docRef = await db.collection('ads').add(adData);
                
                // Show success message
                showNotification('Ad uploaded successfully!', 'success');
                
                // Close modal
                closeAdsUploadModal();
                
                // Refresh ads
                fetchAdsFromFirestore().then(ads => {
                    adsData = ads;
                });
                
            } catch (error) {
                console.error('Error uploading ad:', error);
                showNotification('Error uploading ad. Please try again.', 'warning');
            } finally {
                hideLoading();
            }
        });
        
        // Function to toggle the sidebar modal
        const toggleSidebarModal = () => {
            const sidebarModal = document.getElementById('sidebar-modal');
            const historyModal = document.getElementById('history-modal');
            const filterModal = document.getElementById('filter-modal');
            
            // If history modal is open, close it first
            if (historyModal.classList.contains('open')) {
                historyModal.classList.remove('open');
                inHistoryModal = false;
            }
            
            // If filter modal is open, close it first
            if (filterModal.classList.contains('open')) {
                filterModal.classList.remove('open');
                inFilterModal = false;
            }
            
            // Toggle the sidebar modal
            sidebarModal.classList.toggle('open');
            inSidebarModal = !inSidebarModal;
            
            // If opening the sidebar modal, push state to history
            if (inSidebarModal) {
                history.pushState({ sidebarOpen: true }, '');
            }
        };
        
        // Function to toggle the history modal
        const toggleHistoryModal = () => {
            const historyModal = document.getElementById('history-modal');
            const sidebarModal = document.getElementById('sidebar-modal');
            const filterModal = document.getElementById('filter-modal');
            
            // If sidebar modal is open, close it first
            if (sidebarModal.classList.contains('open')) {
                sidebarModal.classList.remove('open');
                inSidebarModal = false;
            }
            
            // If filter modal is open, close it first
            if (filterModal.classList.contains('open')) {
                filterModal.classList.remove('open');
                inFilterModal = false;
            }
            
            // Toggle the history modal
            historyModal.classList.toggle('open');
            inHistoryModal = !inHistoryModal;
            
            // If opening the history modal, push state to history
            if (inHistoryModal) {
                history.pushState({ historyOpen: true }, '');
            }
        };
        
        // Function to toggle the filter modal
        const toggleFilterModal = () => {
            const filterModal = document.getElementById('filter-modal');
            const sidebarModal = document.getElementById('sidebar-modal');
            const historyModal = document.getElementById('history-modal');
            
            // If sidebar modal is open, close it first
            if (sidebarModal.classList.contains('open')) {
                sidebarModal.classList.remove('open');
                inSidebarModal = false;
            }
            
            // If history modal is open, close it first
            if (historyModal.classList.contains('open')) {
                historyModal.classList.remove('open');
                inHistoryModal = false;
            }
            
            // Toggle the filter modal
            filterModal.classList.toggle('open');
            inFilterModal = !inFilterModal;
            
            // If opening the filter modal, push state to history
            if (inFilterModal) {
                history.pushState({ filterOpen: true }, '');
            }
        };
        
        // Function to populate the sidebar with URL logos
        const populateSidebar = () => {
            const sidebarList = document.getElementById('sidebar-list');
            sidebarList.innerHTML = '';
            // Example list of URL logos (replace with your own data)
            const urlLogos = [
                { logoUrl: "https://cdn-icons-png.flaticon.com/128/18831/18831648.png", name: "Director Center", url: "#", isUpload: true },
                { logoUrl: "https://cdn-icons-png.flaticon.com/128/5303/5303479.png", name: "Apps Center", url: "#", isApps: true },
                { logoUrl: "https://cdn-icons-png.flaticon.com/128/9592/9592247.png", name: "Ads Center", url: "#", isAds: true },
                { logoUrl: "https://cdn-icons-png.flaticon.com/128/18392/18392966.png", name: "Online Service", url: "#" },
                { logoUrl: "https://cdn-icons-png.flaticon.com/128/2312/2312342.png", name: "Privacy Policy", url: "#" },
                { logoUrl: "https://cdn-icons-png.flaticon.com/128/3405/3405247.png", name: "Settings", url: "#" },
                { logoUrl: "https://cdn-icons-png.flaticon.com/128/2838/2838694.png", name: "Help & Support", url: "#" },
            ];
            urlLogos.forEach(item => {
                const sidebarItem = document.createElement('div');
                sidebarItem.className = 'sidebar-item';
                
                if (item.isUpload) {
                    // Director Center with upload functionality
                    sidebarItem.onclick = checkPasswordAndOpenUpload;
                } else if (item.isApps) {
                    // Apps Center with upload functionality
                    sidebarItem.onclick = checkPasswordAndOpenApps;
                } else if (item.isAds) {
                    // Ads Center with upload functionality
                    sidebarItem.onclick = checkPasswordAndOpenAds;
                } else {
                    sidebarItem.onclick = () => window.open(item.url, '_blank');
                }
                
                const img = document.createElement('img');
                img.src = item.logoUrl;
                img.alt = item.name;
                const span = document.createElement('span');
                span.textContent = item.name;
                sidebarItem.appendChild(img);
                sidebarItem.appendChild(span);
                sidebarList.appendChild(sidebarItem);
            });
        };
        // Call the function to populate the sidebar on page load
        populateSidebar();
        
        // Function to shuffle array
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }
        
        // Create carousel using the data array - Updated to match screenshot
        const createCarousel = () => {
            const carousel = document.getElementById("carousel");
            const dotsContainer = document.getElementById("dots");
            carousel.innerHTML = '';
            dotsContainer.innerHTML = '';
            
            // Use the first 5 items for carousel
            const carouselData = data.slice(0, 5);
            
            carouselData.forEach((item, index) => {
                const slide = document.createElement("div");
                slide.className = "slide";
                
                // Format tags for display
                const tagsDisplay = item.tags ? item.tags.join("  ") : "";
                
                slide.innerHTML = `
                    <img src="${item.carouselCover || item.imgUrl}" alt="${item.title}">
                    <div class="overlay"></div>
                    <div class="video-title">${item.title}</div>
                    <div class="video-info">${item.type || 'Movie'} | ${item.year || '2025'} | ${tagsDisplay}</div>
                    <button class="download-btn">
                        <i class="fas fa-play"></i> Watch
                    </button>
                `;
                
                // Add click event to open modal
                slide.onclick = () => openVideoNav(item.videoUrl, item.title, item);
                
                carousel.appendChild(slide);
                
                const dot = document.createElement("div");
                dot.className = "dot";
                if (index === 0) dot.classList.add("active");
                dot.addEventListener("click", () => goToSlide(index));
                dotsContainer.appendChild(dot);
            });
        };
        
        const createDiscoverSection = () => {
            const discoverScroll = document.getElementById('discover-scroll');
            discoverScroll.innerHTML = '';
            
            // Use items from index 5 to 24 (20 items) for discover section
            const discoverData = data.slice(5, 25);
            
            discoverData.forEach(item => {
                const discoverItem = document.createElement('div');
                discoverItem.className = 'discover-item';
                const img = document.createElement('img');
                img.src = item.imgUrl; // Use movie cover for discover section
                img.alt = item.title;
                const content = document.createElement('div');
                content.className = 'content';
                content.innerHTML = `
                    <h2>${item.title}</h2>
                    <p>${item.description}</p>
                `;
                
                // Add click event to the entire discover item
                discoverItem.onclick = () => openVideoNav(item.videoUrl, item.title, item);
                
                discoverItem.appendChild(img);
                discoverItem.appendChild(content);
                discoverScroll.appendChild(discoverItem);
            });
        };
        const createCategories = () => {
            const categories = [...new Set(data.map(item => item.category))]; // Get unique categories
            const container = document.getElementById('categories-container');
            container.innerHTML = '';
            categories.forEach(category => {
                const categoryData = data.filter(item => item.category === category); // Use original data
                const categoryContainer = document.createElement('div');
                categoryContainer.className = 'category-container';
                const categoryTitle = document.createElement('div');
                categoryTitle.className = 'category-title';
                categoryTitle.innerHTML = `
                    <span>
                        ${category}
                        <i class="fas fa-chevron-right"></i> <!-- Right arrow icon -->
                    </span>
                    <button onclick="showAllVideos('${category}')">All <i class="fas fa-chevron-right"></i></button>
                `;
                // Make the entire title clickable
                categoryTitle.onclick = () => showAllVideos(category);
                const categoryScroll = document.createElement('div');
                categoryScroll.className = 'category-scroll';
                // Display all videos in the category (no slice limit)
                categoryData.forEach(item => {
                    const frame = createFrame(item);
                    categoryScroll.appendChild(frame);
                });
                categoryContainer.appendChild(categoryTitle);
                categoryContainer.appendChild(categoryScroll);
                container.appendChild(categoryContainer);
            });
        };
        
        // Function to show all videos in grid layout
        const showAllVideosGrid = () => {
            // Reset scroll position
            window.scrollTo(0, 0);
            
            // Set flag and push state for grid view
            inGridView = true;
            history.pushState({ gridView: true }, '');
            
            const gridContainer = document.getElementById('grid-container');
            gridContainer.innerHTML = '';
            gridContainer.scrollTop = 0; // Reset grid container scroll
            
            // Hide other sections
            document.getElementById('discover-container').style.display = 'none';
            document.getElementById('categories-container').style.display = 'none';
            gridContainer.style.display = 'grid';
            
            // Add all videos to the grid
            data.forEach(item => {
                const frame = createFrame(item);
                gridContainer.appendChild(frame);
            });
        };
        
        const showTrendingVideos = () => {
            // Reset scroll position
            window.scrollTo(0, 0);
            
            // Set flag and push state for grid view
            inGridView = true;
            history.pushState({ gridView: true }, '');
            
            const trendingData = data.filter(item => item.trending); // Filter trending videos
            currentGridData = trendingData; // Set current grid data for filtering
            
            const gridContainer = document.getElementById('grid-container');
            gridContainer.innerHTML = '';
            gridContainer.scrollTop = 0; // Reset grid container scroll
            
            // Hide other sections
            document.getElementById('discover-container').style.display = 'none';
            document.getElementById('categories-container').style.display = 'none';
            gridContainer.style.display = 'grid';
            
            // Add filter section
            const filterSection = createFilterSection();
            gridContainer.insertBefore(filterSection, gridContainer.firstChild);
            
            // Add trending videos to the grid
            if (trendingData.length > 0) {
                trendingData.forEach(item => {
                    const frame = createFrame(item);
                    gridContainer.appendChild(frame);
                });
            } else {
                showNotification('No trending movies found.', 'warning');
            }
        };
        
        const showProfileSection = async () => {
            // Reset scroll position
            window.scrollTo(0, 0);
            
            // Set flag and push state for grid view
            inGridView = true;
            history.pushState({ gridView: true }, '');
            
            const gridContainer = document.getElementById('grid-container');
            gridContainer.innerHTML = '';
            gridContainer.scrollTop = 0; // Reset grid container scroll
            
            // Hide other sections
            document.getElementById('discover-container').style.display = 'none';
            document.getElementById('categories-container').style.display = 'none';
            gridContainer.style.display = 'block'; // Use block for list layout
            
            // Fetch apps from Firestore
            const apps = await fetchAppsFromFirestore();
            if (apps.length > 0) {
                apps.forEach(item => {
                    const profileItem = createProfileItem(item);
                    gridContainer.appendChild(profileItem);
                });
            } else {
                showNotification('No apps available. Please check back later.', 'warning');
            }
        };
        
        const showHomeVideos = () => {
            // Reset scroll position
            window.scrollTo(0, 0);
            
            // Set flag and push state for grid view
            inGridView = true;
            history.pushState({ gridView: true }, '');
            
            const homeData = data; // Use the entire data array for home videos
            currentGridData = homeData; // Set current grid data for filtering
            
            const gridContainer = document.getElementById('grid-container');
            gridContainer.innerHTML = '';
            gridContainer.scrollTop = 0; // Reset grid container scroll
            
            // Hide other sections
            document.getElementById('discover-container').style.display = 'none';
            document.getElementById('categories-container').style.display = 'none';
            gridContainer.style.display = 'grid';
            
            // Add filter section
            const filterSection = createFilterSection();
            gridContainer.insertBefore(filterSection, gridContainer.firstChild);
            
            // Add home videos to the grid
            if (homeData.length > 0) {
                homeData.forEach(item => {
                    const frame = createFrame(item);
                    gridContainer.appendChild(frame);
                });
            } else {
                showNotification('No movies found.', 'warning');
            }
        };
        
        const showMyList = () => {
            // Reset scroll position
            window.scrollTo(0, 0);
            
            // Set flag and push state for grid view
            inGridView = true;
            history.pushState({ gridView: true }, '');
            
            const gridContainer = document.getElementById('grid-container');
            gridContainer.innerHTML = '';
            gridContainer.scrollTop = 0; // Reset grid container scroll
            
            // Hide other sections
            document.getElementById('discover-container').style.display = 'none';
            document.getElementById('categories-container').style.display = 'none';
            gridContainer.style.display = 'block'; // Use block for list layout
            
            // Get saved movies from localStorage
            const savedMoviesData = data.filter(item => savedMovies.includes(item.title));
            
            if (savedMoviesData.length > 0) {
                savedMoviesData.forEach(item => {
                    const listItem = createUnlockedListItem(item);
                    gridContainer.appendChild(listItem);
                });
            } else {
                showNotification('No saved movies found. Save some movies to see them here.', 'warning');
            }
        };
        
        // Function to show the Discover section with carousel
        const showDiscoverSection = () => {
            // Reset scroll position
            window.scrollTo(0, 0);
            
            // Set flag and push state for discover view
            inGridView = false;
            history.pushState({ gridView: false, discoverView: true }, '');
            
            // Show discover and categories containers
            document.getElementById('discover-container').style.display = 'block';
            document.getElementById('categories-container').style.display = 'block';
            
            // Hide grid container
            document.getElementById('grid-container').style.display = 'none';
        };
        
        // Function to create filter section
        const createFilterSection = () => {
            const filterSection = document.createElement('div');
            filterSection.className = 'filter-section';
            
            // Get unique genres, countries, and years from currentGridData
            const genres = [...new Set(currentGridData.map(item => item.genre).filter(Boolean))];
            const countries = [...new Set(currentGridData.map(item => item.country).filter(Boolean))];
            const years = [...new Set(currentGridData.map(item => item.year).filter(Boolean))].sort((a, b) => b - a);
            
            // Create genre dropdown
            const genreDropdown = document.createElement('select');
            genreDropdown.className = 'filter-dropdown';
            genreDropdown.id = 'genre-filter';
            
            const genreDefault = document.createElement('option');
            genreDefault.value = '';
            genreDefault.textContent = 'All Genres';
            genreDropdown.appendChild(genreDefault);
            
            genres.forEach(genre => {
                const option = document.createElement('option');
                option.value = genre;
                option.textContent = genre;
                genreDropdown.appendChild(option);
            });
            
            // Create country dropdown
            const countryDropdown = document.createElement('select');
            countryDropdown.className = 'filter-dropdown';
            countryDropdown.id = 'country-filter';
            
            const countryDefault = document.createElement('option');
            countryDefault.value = '';
            countryDefault.textContent = 'All Countries';
            countryDropdown.appendChild(countryDefault);
            
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                countryDropdown.appendChild(option);
            });
            
            // Create year dropdown
            const yearDropdown = document.createElement('select');
            yearDropdown.className = 'filter-dropdown';
            yearDropdown.id = 'year-filter';
            
            const yearDefault = document.createElement('option');
            yearDefault.value = '';
            yearDefault.textContent = 'All Years';
            yearDropdown.appendChild(yearDefault);
            
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearDropdown.appendChild(option);
            });
            
            // Create filter button
            const filterButton = document.createElement('button');
            filterButton.className = 'filter-button';
            filterButton.innerHTML = '<i class="fas fa-filter"></i> Apply';
            filterButton.onclick = applyGridFilters;
            
            // Add elements to filter section
            filterSection.appendChild(genreDropdown);
            filterSection.appendChild(countryDropdown);
            filterSection.appendChild(yearDropdown);
            filterSection.appendChild(filterButton);
            
            return filterSection;
        };
        
        // Function to apply grid filters
        const applyGridFilters = () => {
            const genreValue = document.getElementById('genre-filter').value;
            const countryValue = document.getElementById('country-filter').value;
            const yearValue = document.getElementById('year-filter').value;
            
            let filteredData = currentGridData;
            
            if (genreValue) {
                filteredData = filteredData.filter(item => item.genre === genreValue);
            }
            
            if (countryValue) {
                filteredData = filteredData.filter(item => item.country === countryValue);
            }
            
            if (yearValue) {
                filteredData = filteredData.filter(item => item.year == yearValue);
            }
            
            // Update the grid with filtered data
            const gridContainer = document.getElementById('grid-container');
            
            // Remove existing frames but keep the filter section
            const filterSection = gridContainer.querySelector('.filter-section');
            gridContainer.innerHTML = '';
            if (filterSection) {
                gridContainer.appendChild(filterSection);
            }
            
            if (filteredData.length > 0) {
                filteredData.forEach(item => {
                    const frame = createFrame(item);
                    gridContainer.appendChild(frame);
                });
            } else {
                showNotification('No movies found with the selected filters.', 'warning');
            }
        };
        
        const createProfileItem = (item) => {
            const profileItem = document.createElement('div');
            profileItem.className = 'profile-item';
            profileItem.style.display = 'flex';
            profileItem.style.alignItems = 'center';
            profileItem.style.gap = '10px';
            profileItem.style.padding = '10px';
            profileItem.style.borderBottom = '1px solid #333';
            const icon = document.createElement('img');
            icon.src = item.icon;
            icon.alt = item.name;
            icon.style.width = '50px';
            icon.style.height = '50px';
            icon.style.borderRadius = '8px';
            const content = document.createElement('div');
            content.style.flex = '1';
            const name = document.createElement('h4');
            name.textContent = item.name;
            name.style.margin = '0';
            name.style.fontSize = '13px';
            name.style.color = '#ccc';
            const description = document.createElement('p');
            description.textContent = item.description;
            description.style.margin = '0';
            description.style.fontSize = '10px';
            description.style.color = '#888';
            const openButton = document.createElement('button');
            openButton.textContent = 'Install';
            openButton.style.backgroundColor = '#00b300';
            openButton.style.color = '#fff';
            openButton.style.border = 'none';
            openButton.style.padding = '6px 12px';
            openButton.style.borderRadius = '5px';
            openButton.style.cursor = 'pointer';
            openButton.style.fontSize = '14px';
            openButton.onclick = () => window.open(item.link, '_blank');
            content.appendChild(name);
            content.appendChild(description);
            profileItem.appendChild(icon);
            profileItem.appendChild(content);
            profileItem.appendChild(openButton);
            return profileItem;
        };
        
        const createFrame = (item) => {
            const frame = document.createElement('div');
            frame.className = 'frame';
            const img = document.createElement('img');
            img.src = item.imgUrl; // Use movie cover for frame
            img.alt = item.title;
            const content = document.createElement('div');
            content.className = 'content';
            const title = document.createElement('h2');
            title.textContent = item.title;
            
            // Add click event to the entire frame
            frame.onclick = () => openVideoNav(item.videoUrl, item.title, item);
            
            content.appendChild(title);
            frame.appendChild(img);
            frame.appendChild(content);
            return frame;
        };
        
        const createUnlockedListItem = (item) => {
            const listItem = document.createElement('div');
            listItem.className = 'unlocked-item';
            listItem.style.display = 'flex';
            listItem.style.alignItems = 'center';
            listItem.style.gap = '10px';
            listItem.style.padding = '10px';
            listItem.style.borderBottom = '1px solid #333';
            listItem.style.cursor = 'pointer';
            
            const img = document.createElement('img');
            img.src = item.imgUrl; // Use movie cover for list item
            img.alt = item.title;
            img.style.width = '80px';
            img.style.height = '115px';
            img.style.objectFit = 'cover';
            img.style.borderRadius = '5px';
            
            const content = document.createElement('div');
            content.style.flex = '1';
            
            const title = document.createElement('h4');
            title.textContent = item.title;
            title.style.margin = '0';
            title.style.fontSize = '14px';
            title.style.color = '#ccc';
            
            const description = document.createElement('p');
            description.textContent = item.description;
            description.style.margin = '0';
            description.style.fontSize = '12px';
            description.style.color = '#777';
            
            // Add click event to the entire list item
            listItem.onclick = () => openVideoNav(item.videoUrl, item.title, item);
            
            content.appendChild(title);
            content.appendChild(description);
            listItem.appendChild(img);
            listItem.appendChild(content);
            return listItem;
        };
        
        // Track current movie in modal
        let currentMovieInModal = null;
        
        const openVideoNav = async (videoUrl, videoId, item) => {
            // Check network connection before opening video
            if (!navigator.onLine) {
                showNetworkWarning();
                return;
            }
            
            // Validate video URL
            if (!isValidVideoUrl(videoUrl)) {
                showNotification('Invalid video URL', 'warning');
                return;
            }
            
            // Display the video navigation modal
            document.getElementById('video-nav').style.display = 'flex';
            
            // Check if the iframe exists, if not create it
            const navBody = document.querySelector('.nav-body');
            const iframeContainer = navBody.querySelector('div[style*="position: relative"]');
            let videoPlayer = document.getElementById('video-player');
            
            if (!videoPlayer) {
                // Create a new iframe
                videoPlayer = document.createElement('iframe');
                videoPlayer.id = 'video-player';
                videoPlayer.setAttribute('frameborder', '0');
                videoPlayer.setAttribute('allowfullscreen', '');
                videoPlayer.style.width = '100%';
                videoPlayer.style.height = '100%';
                iframeContainer.appendChild(videoPlayer);
            }
            
            // Process the video URL based on its source
            let processedUrl = videoUrl;
            
            // Check if it's a YouTube embed URL
            if (videoUrl.includes('youtube.com/embed/')) {
                // Add autoplay=1 parameter for YouTube to autoplay with sound
                const separator = videoUrl.includes('?') ? '&' : '?';
                processedUrl = videoUrl + separator + 'autoplay=1&mute=0';
            } 
            // For Google Drive preview, ensure no autoplay parameters
            else if (videoUrl.includes('drive.google.com/file/d/')) {
                // Google Drive preview doesn't autoplay by default, so no changes needed
                processedUrl = videoUrl;
            }
            
            // Set the processed video URL in the iframe
            videoPlayer.src = processedUrl;
            
            // Track current movie
            currentMovieInModal = item;
            
            // Update save button state
            updateSaveButton();
            
            // Only push state if we're not already in the modal
            if (!inVideoModal) {
                history.pushState({ videoOpen: true }, '');
                inVideoModal = true;
            }
            
            // Check if this is a series with episodes
            const episodeFooter = document.getElementById('episode-footer');
            if (item && item.isSeries && item.seasons) {
                // Show episode footer
                episodeFooter.style.display = 'block';
                
                // Set current season index (if not set, default to 0)
                if (typeof item.currentSeason === 'undefined') {
                    item.currentSeason = 0;
                }
                
                // Update episode title to include season
                document.getElementById('episode-title').textContent = `${item.title} - Season ${item.seasons[item.currentSeason].seasonNumber}`;
                
                // Update episode count for the current season
                document.getElementById('episode-count').textContent = `${item.seasons[item.currentSeason].episodes.length} Episodes`;
                
                // Clear existing episodes
                const episodeScroller = document.getElementById('episode-scroller');
                episodeScroller.innerHTML = '';
                
                // Add Previous Season button if not the first season
                if (item.currentSeason > 0) {
                    const prevSeasonBtn = document.createElement('div');
                    prevSeasonBtn.className = 'season-nav-btn prev-season';
                    prevSeasonBtn.innerHTML = `
                        <span class="season-nav-text">Prev</span>
                        <span class="season-number">S${item.seasons[item.currentSeason - 1].seasonNumber}</span>
                    `;
                    
                    prevSeasonBtn.onclick = () => {
                        goToSeason(item.currentSeason - 1);
                    };
                    
                    episodeScroller.appendChild(prevSeasonBtn);
                }
                
                // Add episode buttons for the current season
                item.seasons[item.currentSeason].episodes.forEach((episode, index) => {
                    const episodeBtn = document.createElement('div');
                    episodeBtn.className = 'episode-btn';
                    if (index === 0) episodeBtn.classList.add('active');
                    
                    const epNum = document.createElement('div');
                    epNum.className = 'ep-num';
                    epNum.textContent = `EP`;
                    
                    const epNumber = document.createElement('div');
                    epNumber.textContent = episode.number;
                    
                    episodeBtn.appendChild(epNum);
                    episodeBtn.appendChild(epNumber);
                    
                    // Add click event
                    episodeBtn.onclick = () => {
                        // Set flag to indicate we're navigating episodes
                        isEpisodeNavigation = true;
                        
                        // Remove active class from all buttons
                        document.querySelectorAll('.episode-btn').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        
                        // Add active class to clicked button
                        episodeBtn.classList.add('active');
                        
                        // Process episode URL if it's a YouTube video
                        let episodeUrl = episode.url;
                        if (episodeUrl.includes('youtube.com/embed/')) {
                            const separator = episodeUrl.includes('?') ? '&' : '?';
                            episodeUrl = episodeUrl + separator + 'autoplay=1&mute=0';
                        }
                        
                        // Load episode in iframe
                        videoPlayer.src = episodeUrl;
                        
                        // Reset flag after a short delay
                        setTimeout(() => {
                            isEpisodeNavigation = false;
                        }, 100);
                    };
                    
                    episodeScroller.appendChild(episodeBtn);
                });
                
                // Add Next Season button if not the last season
                if (item.currentSeason < item.seasons.length - 1) {
                    const nextSeasonBtn = document.createElement('div');
                    nextSeasonBtn.className = 'season-nav-btn next-season';
                    nextSeasonBtn.innerHTML = `
                        <span class="season-nav-text">Next</span>
                        <span class="season-number">S${item.seasons[item.currentSeason + 1].seasonNumber}</span>
                    `;
                    
                    nextSeasonBtn.onclick = () => {
                        goToSeason(item.currentSeason + 1);
                    };
                    
                    episodeScroller.appendChild(nextSeasonBtn);
                }
            } else {
                // Hide episode footer for non-series content
                episodeFooter.style.display = 'none';
            }
            
            // Add the video to the history
            addToHistory(videoId);
        };
        
        // Function to go to a specific season
        const goToSeason = (seasonIndex) => {
            if (!currentMovieInModal || !currentMovieInModal.isSeries || !currentMovieInModal.seasons) return;
            
            // Set flag to indicate we're navigating episodes
            isEpisodeNavigation = true;
            
            // Update current season
            currentMovieInModal.currentSeason = seasonIndex;
            
            // Update the episode scroller for the new season
            const currentSeason = currentMovieInModal.seasons[seasonIndex];
            document.getElementById('episode-title').textContent = `${currentMovieInModal.title} - Season ${currentSeason.seasonNumber}`;
            document.getElementById('episode-count').textContent = `${currentSeason.episodes.length} Episodes`;
            
            // Clear and repopulate episode scroller
            const episodeScroller = document.getElementById('episode-scroller');
            episodeScroller.innerHTML = '';
            
            // Add Previous Season button if not the first season
            if (seasonIndex > 0) {
                const prevSeasonBtn = document.createElement('div');
                prevSeasonBtn.className = 'season-nav-btn prev-season';
                prevSeasonBtn.innerHTML = `
                    <span class="season-nav-text">PREV</span>
                    <span class="season-number">S${currentMovieInModal.seasons[seasonIndex - 1].seasonNumber}</span>
                `;
                
                prevSeasonBtn.onclick = () => {
                    goToSeason(seasonIndex - 1);
                };
                
                episodeScroller.appendChild(prevSeasonBtn);
            }
            
            // Add episode buttons for the current season
            currentSeason.episodes.forEach((episode, index) => {
                const episodeBtn = document.createElement('div');
                episodeBtn.className = 'episode-btn';
                if (index === 0) episodeBtn.classList.add('active');
                
                const epNum = document.createElement('div');
                epNum.className = 'ep-num';
                epNum.textContent = `EP`;
                
                const epNumber = document.createElement('div');
                epNumber.textContent = episode.number;
                
                episodeBtn.appendChild(epNum);
                episodeBtn.appendChild(epNumber);
                
                episodeBtn.onclick = () => {
                    // Set flag to indicate we're navigating episodes
                    isEpisodeNavigation = true;
                    
                    document.querySelectorAll('.episode-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    episodeBtn.classList.add('active');
                    
                    // Process episode URL if it's a YouTube video
                    let episodeUrl = episode.url;
                    if (episodeUrl.includes('youtube.com/embed/')) {
                        const separator = episodeUrl.includes('?') ? '&' : '?';
                        episodeUrl = episodeUrl + separator + 'autoplay=1&mute=0';
                    }
                    
                    document.getElementById('video-player').src = episodeUrl;
                    
                    // Reset flag after a short delay
                    setTimeout(() => {
                        isEpisodeNavigation = false;
                    }, 100);
                };
                
                episodeScroller.appendChild(episodeBtn);
            });
            
            // Add Next Season button if not the last season
            if (seasonIndex < currentMovieInModal.seasons.length - 1) {
                const nextSeasonBtn = document.createElement('div');
                nextSeasonBtn.className = 'season-nav-btn next-season';
                nextSeasonBtn.innerHTML = `
                    <span class="season-nav-text">NEXT</span>
                    <span class="season-number">S${currentMovieInModal.seasons[seasonIndex + 1].seasonNumber}</span>
                `;
                
                nextSeasonBtn.onclick = () => {
                    goToSeason(seasonIndex + 1);
                };
                
                episodeScroller.appendChild(nextSeasonBtn);
            }
            
            // Load the first episode of the new season
            if (currentSeason.episodes.length > 0) {
                let firstEpisodeUrl = currentSeason.episodes[0].url;
                // Process URL if it's a YouTube video
                if (firstEpisodeUrl.includes('youtube.com/embed/')) {
                    const separator = firstEpisodeUrl.includes('?') ? '&' : '?';
                    firstEpisodeUrl = firstEpisodeUrl + separator + 'autoplay=1&mute=0';
                }
                document.getElementById('video-player').src = firstEpisodeUrl;
            }
            
            // Scroll to the beginning of the episode scroller
            episodeScroller.scrollLeft = 0;
            
            // Reset flag after a short delay
            setTimeout(() => {
                isEpisodeNavigation = false;
            }, 100);
        };
        
        // Function to update save button state
        const updateSaveButton = () => {
            const saveBtn = document.getElementById('save-btn');
            if (currentMovieInModal && savedMovies.includes(currentMovieInModal.title)) {
                saveBtn.textContent = 'Added';
                saveBtn.style.backgroundColor = '#ff0000';
            } else {
                saveBtn.textContent = 'Add to list';
                saveBtn.style.backgroundColor = '#00b300';
            }
        };
        
        // Function to toggle save status
        const toggleSaveStatus = () => {
            if (!currentMovieInModal) return;
            
            const movieTitle = currentMovieInModal.title;
            const saveBtn = document.getElementById('save-btn');
            
            if (savedMovies.includes(movieTitle)) {
                // Remove from saved list
                savedMovies = savedMovies.filter(title => title !== movieTitle);
                saveBtn.textContent = 'Add to list';
                saveBtn.style.backgroundColor = '#00b300';
                showNotification('Removed from My List', 'success');
            } else {
                // Add to saved list
                savedMovies.push(movieTitle);
                saveBtn.textContent = 'Added';
                saveBtn.style.backgroundColor = '#ff0000';
                showNotification('Added to My List', 'success');
            }
            
            // Update localStorage
            localStorage.setItem('savedMovies', JSON.stringify(savedMovies));
        };
        
        const addToHistory = (videoId) => {
            const history = JSON.parse(localStorage.getItem('videoHistory')) || [];
            const video = data.find(item => item.title === videoId);
            if (video) {
                // Remove duplicate entries
                const filteredHistory = history.filter(item => item.title !== videoId);
                // Add the new entry at the beginning
                filteredHistory.unshift(video);
                // Save the updated history
                localStorage.setItem('videoHistory', JSON.stringify(filteredHistory));
                // Update the history list
                updateHistoryList();
            }
        };
        
        const updateHistoryList = () => {
            const history = JSON.parse(localStorage.getItem('videoHistory')) || [];
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';
            if (history.length === 0) {
                historyList.innerHTML = '<p>No history available.</p>';
                return;
            }
            history.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                const img = document.createElement('img');
                img.src = item.imgUrl;
                img.alt = item.title;
                const content = document.createElement('div');
                content.className = 'content';
                content.innerHTML = `
                    <h4>${item.title}</h4>
                    <p>${item.description}</p>
                `;
                
                // Add click event to the entire history item that closes the history modal
                historyItem.onclick = () => {
                    // Close the history modal first
                    toggleHistoryModal();
                    // Then open the video
                    openVideoNav(item.videoUrl, item.title, item);
                };
                
                historyItem.appendChild(img);
                historyItem.appendChild(content);
                historyList.appendChild(historyItem);
            });
        };
        
        const clearHistory = () => {
            localStorage.removeItem('videoHistory');
            updateHistoryList();
            showNotification('All history has been cleared.', 'success');
        };
        
        const showAllVideos = (category) => {
            // Reset scroll position
            window.scrollTo(0, 0);
            
            // Set flag and push state for grid view
            inGridView = true;
            history.pushState({ gridView: true }, '');
            
            const categoryData = data.filter(item => item.category === category);
            currentGridData = categoryData; // Set current grid data for filtering
            
            const gridContainer = document.getElementById('grid-container');
            gridContainer.innerHTML = '';
            gridContainer.scrollTop = 0; // Reset grid container scroll
            
            // Hide other sections
            document.getElementById('discover-container').style.display = 'none';
            document.getElementById('categories-container').style.display = 'none';
            gridContainer.style.display = 'grid';
            
            // Add filter section
            const filterSection = createFilterSection();
            gridContainer.insertBefore(filterSection, gridContainer.firstChild);
            
            // Add videos to the grid
            categoryData.forEach(item => {
                const frame = createFrame(item);
                gridContainer.appendChild(frame);
            });
        };
        
        // Enhanced search function to search by title, genre, tags, and keywords
        const handleSearch = () => {
            const searchTerm = document.getElementById('search-bar').value.toLowerCase();
            currentSearchTerm = searchTerm;
            
            // Clear any existing timeout
            clearTimeout(searchTimeout);
            
            // Set a new timeout to delay the search
            searchTimeout = setTimeout(() => {
                // Reset scroll position
                window.scrollTo(0, 0);
                
                // Set flag and push state for grid view
                inGridView = true;
                history.pushState({ gridView: true }, '');
                
                // Filter data based on search term across multiple fields
                const filteredData = data.filter(item => {
                    // Search in title
                    if (item.title && item.title.toLowerCase().includes(searchTerm)) {
                        return true;
                    }
                    
                    // Search in genre
                    if (item.genre && item.genre.toLowerCase().includes(searchTerm)) {
                        return true;
                    }
                    
                    // Search in tags
                    if (item.tags && Array.isArray(item.tags)) {
                        for (const tag of item.tags) {
                            if (tag.toLowerCase().includes(searchTerm)) {
                                return true;
                            }
                        }
                    }
                    
                    // Search in description (keywords)
                    if (item.description && item.description.toLowerCase().includes(searchTerm)) {
                        return true;
                    }
                    
                    // Search in category
                    if (item.category && item.category.toLowerCase().includes(searchTerm)) {
                        return true;
                    }
                    
                    // Search in year
                    if (item.year && item.year.toString().includes(searchTerm)) {
                        return true;
                    }
                    
                    // Search in type (Movie, Series, etc.)
                    if (item.type && item.type.toLowerCase().includes(searchTerm)) {
                        return true;
                    }
                    
                    // Search in country
                    if (item.country && item.country.toLowerCase().includes(searchTerm)) {
                        return true;
                    }
                    
                    return false;
                });
                
                currentGridData = filteredData; // Set current grid data for filtering
                
                const gridContainer = document.getElementById('grid-container');
                gridContainer.innerHTML = '';
                gridContainer.scrollTop = 0; // Reset grid container scroll
                
                // Hide other sections
                document.getElementById('discover-container').style.display = 'none';
                document.getElementById('categories-container').style.display = 'none';
                gridContainer.style.display = 'grid';
                
                // Add filter section
                const filterSection = createFilterSection();
                gridContainer.insertBefore(filterSection, gridContainer.firstChild);
                
                // Add search results to the grid
                if (filteredData.length > 0) {
                    filteredData.forEach(item => {
                        const frame = createFrame(item);
                        gridContainer.appendChild(frame);
                    });
                } else {
                    showNotification('No movies found matching your search.', 'warning');
                }
            }, 300); // 300ms delay for better performance
        };
        
        // Function to show search suggestions
        const showSearchSuggestions = () => {
            const searchTerm = document.getElementById('search-bar').value.toLowerCase();
            const suggestionsContainer = document.getElementById('search-suggestions');
            
            if (searchTerm.length < 2) {
                suggestionsContainer.innerHTML = '';
                suggestionsContainer.classList.remove('show');
                return;
            }
            
            // Get unique suggestions from various fields
            const suggestions = new Set();
            
            data.forEach(item => {
                // Title suggestions
                if (item.title && item.title.toLowerCase().includes(searchTerm)) {
                    suggestions.add({
                        text: item.title,
                        type: 'Title',
                        item: item
                    });
                }
                
                // Genre suggestions
                if (item.genre && item.genre.toLowerCase().includes(searchTerm)) {
                    suggestions.add({
                        text: item.genre,
                        type: 'Genre',
                        item: item
                    });
                }
                
                // Tag suggestions
                if (item.tags && Array.isArray(item.tags)) {
                    item.tags.forEach(tag => {
                        if (tag.toLowerCase().includes(searchTerm)) {
                            suggestions.add({
                                text: tag,
                                type: 'Tag',
                                item: item
                            });
                        }
                    });
                }
                
                // Category suggestions
                if (item.category && item.category.toLowerCase().includes(searchTerm)) {
                    suggestions.add({
                        text: item.category,
                        type: 'Category',
                        item: item
                    });
                }
                
                // Country suggestions
                if (item.country && item.country.toLowerCase().includes(searchTerm)) {
                    suggestions.add({
                        text: item.country,
                        type: 'Country',
                        item: item
                    });
                }
            });
            
            // Convert to array and limit to 5 suggestions
            const suggestionsArray = Array.from(suggestions).slice(0, 5);
            
            // Clear and populate suggestions container
            suggestionsContainer.innerHTML = '';
            
            if (suggestionsArray.length > 0) {
                suggestionsArray.forEach(suggestion => {
                    const suggestionItem = document.createElement('div');
                    suggestionItem.className = 'search-suggestion-item';
                    suggestionItem.innerHTML = `
                        ${suggestion.text}
                        <span class="suggestion-type">${suggestion.type}</span>
                    `;
                    
                    suggestionItem.onclick = () => {
                        document.getElementById('search-bar').value = suggestion.text;
                        handleSearch();
                        suggestionsContainer.classList.remove('show');
                    };
                    
                    suggestionsContainer.appendChild(suggestionItem);
                });
                
                suggestionsContainer.classList.add('show');
            } else {
                suggestionsContainer.classList.remove('show');
            }
        };
        
        // Function to hide search suggestions with delay
        const hideSearchSuggestions = () => {
            setTimeout(() => {
                document.getElementById('search-suggestions').classList.remove('show');
            }, 200);
        };
        
        // Improved notification system
        function showNotification(message, type = 'info') {
            // Remove any existing notifications
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => {
                notification.remove();
            });
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            // Position fixed at top center
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.left = '50%';
            notification.style.transform = 'translateX(-50%)';
            notification.style.zIndex = '10000';
            notification.style.padding = '15px 25px';
            notification.style.borderRadius = '8px';
            notification.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
            notification.style.maxWidth = '80%';
            notification.style.textAlign = 'center';
            
            // Style based on type
            switch(type) {
                case 'success':
                    notification.style.backgroundColor = '#4CAF50';
                    notification.style.color = 'white';
                    break;
                case 'warning':
                    notification.style.backgroundColor = '#FF9800';
                    notification.style.color = 'white';
                    break;
                case 'error':
                    notification.style.backgroundColor = '#F44336';
                    notification.style.color = 'white';
                    break;
                default:
                    notification.style.backgroundColor = '#2196F3';
                    notification.style.color = 'white';
            }
            
            document.body.appendChild(notification);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 500);
            }, 3000);
        }
        
        // Function to close the modal - optimized for immediate closing
        const closeModal = () => {
            // Stop the video immediately
            const videoPlayer = document.getElementById('video-player');
            const currentSrc = videoPlayer.src;
            
            // Clear the src to stop playback
            videoPlayer.src = 'about:blank'; // Use about:blank to unload
            
            // For YouTube videos, we need additional handling
            if (currentSrc && currentSrc.includes('youtube.com/embed/')) {
                // Create a temporary iframe to properly unload YouTube content
                const tempIframe = document.createElement('iframe');
                tempIframe.style.display = 'none';
                document.body.appendChild(tempIframe);
                tempIframe.src = 'about:blank';
                setTimeout(() => {
                    document.body.removeChild(tempIframe);
                }, 100);
            }
            
            // Hide the modal immediately
            document.getElementById('video-nav').style.display = 'none';
            
            // Reset state immediately
            currentMovieInModal = null;
            inVideoModal = false;
            isEpisodeNavigation = false; // Reset the flag
            
            // Clear any episode/season data
            const episodeFooter = document.getElementById('episode-footer');
            episodeFooter.style.display = 'none';
            
            // Remove the iframe from the DOM to completely stop the video
            const navBody = document.querySelector('.nav-body');
            const iframeContainer = navBody.querySelector('div[style*="position: relative"]');
            if (iframeContainer) {
                const oldIframe = iframeContainer.querySelector('iframe');
                if (oldIframe) {
                    oldIframe.remove();
                }
            }
        };
        // Modified closeNav function for immediate closing
        const closeNav = () => {
            if (inVideoModal) {
                // Close modal immediately without any delay
                closeModal();
                
                // Only use history.back() if we actually pushed a state
                if (window.history.state && window.history.state.videoOpen) {
                    // Use a small timeout to ensure the modal is fully closed before navigating back
                    setTimeout(() => {
                        window.history.back();
                    }, 10);
                }
            } else {
                closeModal();
            }
        };
        
        // Carousel functionality
        let currentIndex = 0;
        let startX = 0;
        let moveX = 0;
        let isDragging = false;
        
        function updateCarousel() {
            const carousel = document.getElementById("carousel");
            carousel.style.transform = `translateX(-${currentIndex * 100}%)`;
            document.querySelectorAll(".dot").forEach((dot, index) => {
                dot.classList.toggle("active", index === currentIndex);
            });
        }
        
        function goToSlide(index) {
            currentIndex = index;
            updateCarousel();
        }
        
        function nextSlide() {
            const carouselData = data.slice(0, 5);
            currentIndex = (currentIndex + 1) % carouselData.length;
            updateCarousel();
        }
        
        function prevSlide() {
            const carouselData = data.slice(0, 5);
            currentIndex = (currentIndex - 1 + carouselData.length) % carouselData.length;
            updateCarousel();
        }
        
        function handleTouchStart(e) {
            startX = e.touches[0].clientX;
            isDragging = true;
        }
        
        function handleTouchMove(e) {
            if (!isDragging) return;
            moveX = e.touches[0].clientX - startX;
        }
        
        function handleTouchEnd() {
            isDragging = false;
            if (moveX > 50) {
                prevSlide();
            } else if (moveX < -50) {
                nextSlide();
            }
        }
        
        function handleMouseDown(e) {
            startX = e.clientX;
            isDragging = true;
        }
        
        function handleMouseMove(e) {
            if (!isDragging) return;
            moveX = e.clientX - startX;
        }
        
        function handleMouseUp() {
            isDragging = false;
            if (moveX > 50) {
                prevSlide();
            } else if (moveX < -50) {
                nextSlide();
            }
        }
        
        // Initialize carousel event listeners
        function initCarousel() {
            const carousel = document.getElementById("carousel");
            carousel.addEventListener("touchstart", handleTouchStart);
            carousel.addEventListener("touchmove", handleTouchMove);
            carousel.addEventListener("touchend", handleTouchEnd);
            carousel.addEventListener("mousedown", handleMouseDown);
            carousel.addEventListener("mousemove", handleMouseMove);
            carousel.addEventListener("mouseup", handleMouseUp);
            carousel.addEventListener("mouseleave", handleMouseUp);
            
            // Auto-slide every 5 seconds
            setInterval(nextSlide, 5000);
        }
        
        // Initialize the page
        async function initializeApp() {
            try {
                showLoading();
                
                // Fetch videos, apps, and ads from Firestore
                const [fetchedVideos, fetchedApps, fetchedAds] = await Promise.all([
                    fetchVideosFromFirestore(),
                    fetchAppsFromFirestore(),
                    fetchAdsFromFirestore()
                ]);
                
                if (fetchedVideos.length > 0) {
                    data = shuffleArray(fetchedVideos);
                    combinedData = data;
                    createCarousel();
                    createDiscoverSection();
                    createCategories();
                    updateHistoryList();
                    initCarousel();
                } else {
                    showNotification('No videos available. Please check back later.', 'warning');
                }
                
                if (fetchedApps.length > 0) {
                    profileApps = fetchedApps;
                }
                
                if (fetchedAds.length > 0) {
                    adsData = fetchedAds;
                    // Initialize ads rotation
                    rotateAds();
                }
                
                hideLoading();
            } catch (error) {
                console.error("App initialization failed:", error);
                showNotification("Failed to load content. Please check your connection.", "warning");
                hideLoading();
            }
        }
        
        // Add category button click handlers
        document.addEventListener('DOMContentLoaded', () => {
            const categoryButtons = document.querySelectorAll('.category-btn');
            categoryButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Remove active class from all buttons
                    categoryButtons.forEach(btn => btn.classList.remove('active'));
                    // Add active class to clicked button
                    this.classList.add('active');
                    
                    // Filter content based on selected category
                    const selectedCategory = this.dataset.category;
                    if (selectedCategory === 'All') {
                        createDiscoverSection();
                    } else {
                        filterContentByCategory(selectedCategory);
                    }
                });
            });
        });
        
        // Function to filter content by category
        const filterContentByCategory = (category) => {
            const discoverScroll = document.getElementById('discover-scroll');
            discoverScroll.innerHTML = '';
            
            // Filter data by category
            const filteredData = data.filter(item => {
                // Check if item matches the selected category
                if (category === 'Hollywood') return item.category === 'Hollywood';
                if (category === 'Nollywood') return item.category === 'Nollywood';
                if (category === 'Bollywood') return item.category === 'Bollywood';
                if (category === 'Kannywood') return item.category === 'Kannywood';
                if (category === 'Action') return item.genre === 'Action';
                if (category === 'Drama') return item.genre === 'Drama';
                if (category === 'Comedy') return item.genre === 'Comedy';
                return true;
            });
            
            // Add filtered items to discover section
            filteredData.forEach(item => {
                const discoverItem = document.createElement('div');
                discoverItem.className = 'discover-item';
                const img = document.createElement('img');
                img.src = item.imgUrl;
                img.alt = item.title;
                const content = document.createElement('div');
                content.className = 'content';
                content.innerHTML = `
                    <h2>${item.title}</h2>
                    <p>${item.description}</p>
                `;
                
                // Add click event to the entire discover item
                discoverItem.onclick = () => openVideoNav(item.videoUrl, item.title, item);
                
                discoverItem.appendChild(img);
                discoverItem.appendChild(content);
                discoverScroll.appendChild(discoverItem);
            });
        };
        
        let lastScrollTop = 0;
        window.addEventListener('scroll', () => {
            const footer = document.querySelector('footer');
            const currentScrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const windowHeight = window.innerHeight;
            const documentHeight = document.documentElement.scrollHeight;
            // Check if user has reached the bottom of the page
            const atPageEnd = (currentScrollTop + windowHeight) >= documentHeight;
            if (atPageEnd && currentScrollTop > lastScrollTop) {
                // Immediately hide footer when at the end of the page and scrolling down
                footer.classList.add('hide');
            } else {
                // Show footer when scrolling down anywhere else or when scrolling up
                footer.classList.remove('hide');
            }
            lastScrollTop = currentScrollTop;
        });
        
        // Fixed: Changed timeout value to something more reasonable (40 seconds)
        setTimeout(() => {
            const bar = document.getElementById('notification-bar');
            bar.style.opacity = '1';
            bar.style.pointerEvents = 'auto'; // Enable interaction once visible
        }, 40000); // Show after 40 seconds
        
        function closeNotification() {
            const bar = document.getElementById('notification-bar');
            bar.style.opacity = '0';
            bar.style.pointerEvents = 'none'; // Disable interaction immediately
            setTimeout(() => {
                bar.remove(); // Fully remove from DOM
            }, 500); // Allow fade-out to complete
        }
        
        // New functions for added features
        
        // Apply filters
        const applyFilters = () => {
            // Reset scroll position
            window.scrollTo(0, 0);
            
            // Set flag and push state for grid view
            inGridView = true;
            history.pushState({ gridView: true }, '');
            
            // Get selected filters
            const selectedGenre = document.querySelector('.filter-option[data-genre].active')?.dataset.genre || 'All';
            const selectedSort = document.querySelector('.filter-option[data-sort].active')?.dataset.sort || 'Newest';
            
            // Apply filters to data
            let filteredData = data;
            
            if (selectedGenre !== 'All') {
                filteredData = filteredData.filter(item => item.genre === selectedGenre);
            }
            
            // Sort data
            if (selectedSort === 'Newest') {
                filteredData.sort((a, b) => b.id - a.id);
            } else if (selectedSort === 'Popular') {
                filteredData.sort((a, b) => (b.views || 0) - (a.views || 0));
            } else if (selectedSort === 'Rating') {
                filteredData.sort((a, b) => (b.rating || 0) - (a.rating || 0));
            } else if (selectedSort === 'A-Z') {
                filteredData.sort((a, b) => a.title.localeCompare(b.title));
            }
            
            // Update UI with filtered data
            const gridContainer = document.getElementById('grid-container');
            gridContainer.innerHTML = '';
            
            // Hide other sections
            document.getElementById('discover-container').style.display = 'none';
            document.getElementById('categories-container').style.display = 'none';
            gridContainer.style.display = 'grid';
            
            filteredData.forEach(item => {
                const frame = createFrame(item);
                gridContainer.appendChild(frame);
            });
            
            // Close filter modal
            toggleFilterModal();
        };
        
        // Share movie function
        const shareMovie = () => {
            // Create a URL with video ID parameter
            const url = new URL(window.location.href);
            url.searchParams.set('videoId', currentMovieInModal.id);
            const shareUrl = url.toString();
            
            if (navigator.share) {
                navigator.share({
                    title: currentMovieInModal.title,
                    text: 'Check out this movie on Movie Nest!',
                    url: shareUrl
                })
                .then(() => console.log('Shared successfully'))
                .catch((error) => console.log('Error sharing:', error));
            } else {
                // Fallback - copy to clipboard
                const dummy = document.createElement('input');
                document.body.appendChild(dummy);
                dummy.value = shareUrl;
                dummy.select();
                document.execCommand('copy');
                document.body.removeChild(dummy);
                showNotification('Link copied to clipboard!', 'success');
            }
        };
        
        // Open Edit Profile Modal
        const openEditProfileModal = () => {
            const editProfileModal = document.getElementById('edit-profile-modal');
            editProfileModal.classList.add('open');
            
            // Set current user name in input
            document.getElementById('user-name-input').value = userProfile.name;
            
            // Set selected avatar
            document.querySelectorAll('.avatar-option').forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.avatar === userProfile.avatar) {
                    option.classList.add('selected');
                }
            });
        };
        
        // Close Edit Profile Modal
        const closeEditProfileModal = () => {
            const editProfileModal = document.getElementById('edit-profile-modal');
            editProfileModal.classList.remove('open');
        };
        
        // Save Profile
        const saveProfile = () => {
            // Get selected avatar
            const selectedAvatar = document.querySelector('.avatar-option.selected');
            if (selectedAvatar) {
                userProfile.avatar = selectedAvatar.dataset.avatar;
            }
            
            // Get user name
            const userName = document.getElementById('user-name-input').value;
            if (userName.trim() !== '') {
                userProfile.name = userName.trim();
            }
            
            // Save to localStorage
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
            
            // Update UI
            updateUserProfile();
            
            // Close modal
            closeEditProfileModal();
            
            // Show notification
            showNotification('Profile updated successfully!', 'success');
        };
        
        // Update User Profile UI
        const updateUserProfile = () => {
            // Update user name
            document.getElementById('user-name').textContent = userProfile.name;
            
            // Update user avatar
            const userAvatar = document.getElementById('user-avatar');
            userAvatar.innerHTML = '';
            
            if (userProfile.avatar) {
                const avatarImg = document.createElement('img');
                avatarImg.src = getAvatarUrl(userProfile.avatar);
                avatarImg.alt = 'User Avatar';
                userAvatar.appendChild(avatarImg);
            } else {
                const defaultIcon = document.createElement('i');
                defaultIcon.className = 'fas fa-user';
                defaultIcon.style.fontSize = '36px';
                userAvatar.appendChild(defaultIcon);
            }
        };
        
        // Get Avatar URL by ID
        const getAvatarUrl = (avatarId) => {
            const avatars = {
                '1': 'https://cdn-icons-png.flaticon.com/128/6997/6997666.png',
                '2': 'https://cdn-icons-png.flaticon.com/128/6997/6997662.png',
                '3': 'https://cdn-icons-png.flaticon.com/128/6997/6997661.png',
                '4': 'https://cdn-icons-png.flaticon.com/128/6997/6997664.png'
            };
            return avatars[avatarId] || avatars['1'];
        };
        
        // Function to check for video ID in URL and open video modal immediately
        const checkVideoIdInUrl = async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const videoId = urlParams.get('videoId');
            
            if (videoId) {
                // Show direct link message
                const directLinkMessage = document.getElementById('direct-link-message');
                directLinkMessage.style.display = 'block';
                
                // Set flag that we're opening a direct link
                openingDirectLink = true;
                
                try {
                    // Fetch videos from Firestore
                    const fetchedVideos = await fetchVideosFromFirestore();
                    if (fetchedVideos.length > 0) {
                        data = shuffleArray(fetchedVideos);
                        
                        // Find the video with the matching ID
                        const video = data.find(item => item.id == videoId);
                        if (video) {
                            // Hide the direct link message after a short delay
                            setTimeout(() => {
                                directLinkMessage.style.display = 'none';
                            }, 2000);
                            
                            // Open video modal immediately without delay
                            openVideoNav(video.videoUrl, video.title, video);
                        } else {
                            // Video not found
                            directLinkMessage.textContent = 'Video not found. Redirecting to home page...';
                            setTimeout(() => {
                                directLinkMessage.style.display = 'none';
                                showDiscoverSection();
                            }, 3000);
                        }
                    } else {
                        // No videos available
                        directLinkMessage.textContent = 'No videos available. Please check back later.';
                        setTimeout(() => {
                            directLinkMessage.style.display = 'none';
                        }, 3000);
                    }
                } catch (error) {
                    console.error("Error fetching videos for direct link:", error);
                    directLinkMessage.textContent = 'Error loading video. Please try again later.';
                    setTimeout(() => {
                        directLinkMessage.style.display = 'none';
                    }, 3000);
                }
            }
        };
        
        // Network connection warning functions - Updated to match image
        const showNetworkWarning = () => {
            const networkWarning = document.getElementById('network-warning');
            networkWarning.classList.remove('hidden');
            
            // Hide app content when network warning is shown
            document.querySelector('header').style.display = 'none';
            document.getElementById('discover-container').style.display = 'none';
            document.getElementById('categories-container').style.display = 'none';
            document.getElementById('grid-container').style.display = 'none';
            document.querySelector('footer').style.display = 'none';
        };
        
        const hideNetworkWarning = () => {
            const networkWarning = document.getElementById('network-warning');
            networkWarning.classList.add('hidden');
            
            // Restore app content when network warning is hidden
            document.querySelector('header').style.display = 'flex';
            
            // Restore the appropriate section based on current state
            if (inGridView) {
                document.getElementById('grid-container').style.display = 'grid';
            } else {
                document.getElementById('discover-container').style.display = 'block';
                document.getElementById('categories-container').style.display = 'block';
            }
            
            document.querySelector('footer').style.display = 'flex';
        };
        
        // Check network connection status
        const checkNetworkConnection = () => {
            if (navigator.onLine) {
                hideNetworkWarning();
                showNotification('Network connection restored', 'success');
                // Attempt to reload data
                initializeApp();
            } else {
                // Still offline, keep showing the warning
                showNetworkWarning();
            }
        };
        
        // Ad logic
        const adContainer = document.getElementById('adContainer');
        const adContent = document.getElementById('adContent');
        const installButton = document.getElementById('installButton');
        let currentAdIndex = parseInt(localStorage.getItem('currentAdIndex')) || 0;
        function showAd(index) {
            if (!adsData || !Array.isArray(adsData) || adsData.length === 0) {
                console.warn("Ads data not available");
                return;
            }
            
            const app = adsData[index];
            adContent.innerHTML = `
                <div class="app-icon">
                    <img src="${app.image}" alt="App Icon" />
                </div>
                <div class="ad-info">
                    <div class="app-name">${app.title}</div>
                    <div class="ad-meta">
                        <span class="sponsored">Sponsored </span>
                        <span>${app.rating}  FREE</span>
                    </div>
                </div>
            `;
            installButton.href = app.link;
            adContainer.style.display = 'flex';
            localStorage.setItem('currentAdIndex', index);
        }
        function rotateAds() {
            if (!adsData || !Array.isArray(adsData) || adsData.length === 0) {
                console.warn("Ads data not available, skipping rotation");
                return;
            }
            
            showAd(currentAdIndex);
            currentAdIndex = (currentAdIndex + 1) % adsData.length;
        }
        
        // Initialize all new features when the page loads
        window.addEventListener('load', () => {
            // Initialize filter options
            document.querySelectorAll('.filter-option').forEach(option => {
                option.addEventListener('click', function() {
                    // Remove active class from siblings in the same filter-options container
                    const siblings = this.parentElement.querySelectorAll('.filter-option');
                    siblings.forEach(sib => sib.classList.remove('active'));
                    // Add active class to clicked option
                    this.classList.add('active');
                });
            });
            
            // Initialize avatar options
            document.querySelectorAll('.avatar-option').forEach(option => {
                option.addEventListener('click', function() {
                    // Remove selected class from all options
                    document.querySelectorAll('.avatar-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    // Add selected class to clicked option
                    this.classList.add('selected');
                });
            });
            
            // Update user profile UI
            updateUserProfile();
            
            // Check for video ID in URL immediately
            checkVideoIdInUrl();
            
            // Check network connection on load
            checkNetworkConnection();
            
            // Add event listeners for online/offline events
            window.addEventListener('online', () => {
                hideNetworkWarning();
                showNotification('Network connection restored', 'success');
            });
            
            window.addEventListener('offline', () => {
                showNetworkWarning();
            });
            
            // Add event listener to close modal when clicking outside
            document.getElementById('upload-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeUploadModal();
                }
            });
            
            document.getElementById('apps-upload-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeAppsUploadModal();
                }
            });
            
            document.getElementById('ads-upload-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeAdsUploadModal();
                }
            });
            
            document.getElementById('password-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closePasswordModal();
                }
            });
            
            // Add keyboard event to close modal with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    if (inUploadModal) {
                        closeUploadModal();
                    } else if (inAppsUploadModal) {
                        closeAppsUploadModal();
                    } else if (inAdsUploadModal) {
                        closeAdsUploadModal();
                    } else if (inPasswordModal) {
                        closePasswordModal();
                    }
                }
            });
            
            // Add history state handling with immediate response
            window.addEventListener('popstate', (event) => {
                // If we're navigating episodes, ignore the back button
                if (isEpisodeNavigation) {
                    // Push state again to prevent closing the modal
                    history.pushState({ videoOpen: true }, '');
                    return;
                }
                
                // Handle video modal - close immediately
                if (inVideoModal) {
                    closeModal();
                    return; // Exit early to prevent any delays
                } 
                // Handle grid view
                else if (inGridView) {
                    inGridView = false;
                    // Show both discover container and categories container
                    document.getElementById('discover-container').style.display = 'block';
                    document.getElementById('categories-container').style.display = 'block';
                    document.getElementById('grid-container').style.display = 'none';
                }
                // Handle filter modal
                else if (inFilterModal) {
                    document.getElementById('filter-modal').classList.remove('open');
                    inFilterModal = false;
                }
                // Handle history modal
                else if (inHistoryModal) {
                    document.getElementById('history-modal').classList.remove('open');
                    inHistoryModal = false;
                }
                // Handle sidebar modal
                else if (inSidebarModal) {
                    document.getElementById('sidebar-modal').classList.remove('open');
                    inSidebarModal = false;
                }
                // Handle upload modal
                else if (inUploadModal) {
                    document.getElementById('upload-modal').classList.remove('open');
                    inUploadModal = false;
                }
                // Handle apps upload modal
                else if (inAppsUploadModal) {
                    document.getElementById('apps-upload-modal').classList.remove('open');
                    inAppsUploadModal = false;
                }
                // Handle ads upload modal
                else if (inAdsUploadModal) {
                    document.getElementById('ads-upload-modal').classList.remove('open');
                    inAdsUploadModal = false;
                }
                // Handle password modal
                else if (inPasswordModal) {
                    document.getElementById('password-modal').classList.remove('open');
                    inPasswordModal = false;
                }
                // Default to discover if no specific state
                else {
                    showDiscoverSection();
                }
            });
            
            // Initialize the app
            initializeApp();
        });
    </script>
</body>
</html>
